import { s, e, a } from '../index-9d8fa28c.js';
import { i as pt$1, j as ht$1, k as gt$1, o, Q as Qn, p as pe, b as re, K as Kn, X as Xn, d as de, t as te, F as Ft$1, r, P as Pn, $ as $n, G as Gn, m as Nn, n as rn, q as Kt$1, M as Mn, v as oe, Z as Zt$1, U as Un$1, w as Zn, y as ne, z as Qt$1, A as Mt$1, Y as Yt$1, J as Jn, C as Yn, H as Hn, I as Bn$1, V as Vn, L as nn, S as Fn, R as Rn } from '../json-rpc-bbea77b7.js';
import { g, v, s as s$2, b, T, S, w, R as R$1, u, h } from '../users-73981cf4.js';
import '../keysIn-f91c894f.js';
import { a as ae, f as fe, s as se } from '../background-share-b59fc4f7.js';
import { B as Bn, z as zn, R as Re$1, a as R, U as Un, q as qn, C as Cr, D as Dr, j as jr, W as Wn, k as kn } from '../logging-23079156.js';
import { t } from '../merge-626c69be.js';
import { o as o$1, r as r$1 } from '../snippet-collections-86e7c592.js';
import { s as s$1, a as a$1 } from '../google-sheets-f469d8b7.js';
import { SESSION_COOKIE_NAME as n, restoreAuthCookie as s$3, backupAuthCookie as i } from '../background-auth-15e91915.js';

var ye=s((function(e,t){var r;t=e.exports=z,r="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER"),console.log.apply(console,e);}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var s=Number.MAX_SAFE_INTEGER||9007199254740991,n=t.re=[],i=t.src=[],o=0,a=o++;i[a]="0|[1-9]\\d*";var c=o++;i[c]="[0-9]+";var l=o++;i[l]="\\d*[a-zA-Z-][a-zA-Z0-9-]*";var u=o++;i[u]="("+i[a]+")\\.("+i[a]+")\\.("+i[a]+")";var p=o++;i[p]="("+i[c]+")\\.("+i[c]+")\\.("+i[c]+")";var d=o++;i[d]="(?:"+i[a]+"|"+i[l]+")";var f=o++;i[f]="(?:"+i[c]+"|"+i[l]+")";var h=o++;i[h]="(?:-("+i[d]+"(?:\\."+i[d]+")*))";var g=o++;i[g]="(?:-?("+i[f]+"(?:\\."+i[f]+")*))";var m=o++;i[m]="[0-9A-Za-z-]+";var y=o++;i[y]="(?:\\+("+i[m]+"(?:\\."+i[m]+")*))";var w=o++,v="v?"+i[u]+i[h]+"?"+i[y]+"?";i[w]="^"+v+"$";var b="[v=\\s]*"+i[p]+i[g]+"?"+i[y]+"?",S=o++;i[S]="^"+b+"$";var I=o++;i[I]="((?:<|>)?=?)";var E=o++;i[E]=i[c]+"|x|X|\\*";var _=o++;i[_]=i[a]+"|x|X|\\*";var T=o++;i[T]="[v=\\s]*("+i[_]+")(?:\\.("+i[_]+")(?:\\.("+i[_]+")(?:"+i[h]+")?"+i[y]+"?)?)?";var U=o++;i[U]="[v=\\s]*("+i[E]+")(?:\\.("+i[E]+")(?:\\.("+i[E]+")(?:"+i[g]+")?"+i[y]+"?)?)?";var O=o++;i[O]="^"+i[I]+"\\s*"+i[T]+"$";var A=o++;i[A]="^"+i[I]+"\\s*"+i[U]+"$";var k=o++;i[k]="(?:^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])";var C=o++;i[C]="(?:~>?)";var N=o++;i[N]="(\\s*)"+i[C]+"\\s+",n[N]=new RegExp(i[N],"g");var P=o++;i[P]="^"+i[C]+i[T]+"$";var R=o++;i[R]="^"+i[C]+i[U]+"$";var x=o++;i[x]="(?:\\^)";var M=o++;i[M]="(\\s*)"+i[x]+"\\s+",n[M]=new RegExp(i[M],"g");var F=o++;i[F]="^"+i[x]+i[T]+"$";var D=o++;i[D]="^"+i[x]+i[U]+"$";var V=o++;i[V]="^"+i[I]+"\\s*("+b+")$|^$";var j=o++;i[j]="^"+i[I]+"\\s*("+v+")$|^$";var L=o++;i[L]="(\\s*)"+i[I]+"\\s*("+b+"|"+i[T]+")",n[L]=new RegExp(i[L],"g");var B=o++;i[B]="^\\s*("+i[T]+")\\s+-\\s+("+i[T]+")\\s*$";var q=o++;i[q]="^\\s*("+i[U]+")\\s+-\\s+("+i[U]+")\\s*$";var $=o++;i[$]="(<|>)?=?\\s*\\*";for(var G=0;G<35;G++)r(G,i[G]),n[G]||(n[G]=new RegExp(i[G]));function K(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof z)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?n[S]:n[w]).test(e))return null;try{return new z(e,t)}catch(e){return null}}function z(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof z){if(e.loose===t.loose)return e;e=e.version;}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof z))return new z(e,t);r("SemVer",e,t),this.options=t,this.loose=!!t.loose;var i=e.trim().match(t.loose?n[S]:n[w]);if(!i)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+i[1],this.minor=+i[2],this.patch=+i[3],this.major>s||this.major<0)throw new TypeError("Invalid major version");if(this.minor>s||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>s||this.patch<0)throw new TypeError("Invalid patch version");i[4]?this.prerelease=i[4].split(".").map((function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<s)return t}return e})):this.prerelease=[],this.build=i[5]?i[5].split("."):[],this.format();}t.parse=K,t.valid=function(e,t){var r=K(e,t);return r?r.version:null},t.clean=function(e,t){var r=K(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null},t.SemVer=z,z.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},z.prototype.toString=function(){return this.version},z.prototype.compare=function(e){return r("SemVer.compare",this.version,this.options,e),e instanceof z||(e=new z(e,this.options)),this.compareMain(e)||this.comparePre(e)},z.prototype.compareMain=function(e){return e instanceof z||(e=new z(e,this.options)),H(this.major,e.major)||H(this.minor,e.minor)||H(this.patch,e.patch)},z.prototype.comparePre=function(e){if(e instanceof z||(e=new z(e,this.options)),this.prerelease.length&&!e.prerelease.length)return -1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var s=this.prerelease[t],n=e.prerelease[t];if(r("prerelease compare",t,s,n),void 0===s&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===s)return -1;if(s!==n)return H(s,n)}while(++t)},z.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else {for(var r=this.prerelease.length;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);-1===r&&this.prerelease.push(0);}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,r,s){"string"==typeof r&&(s=r,r=void 0);try{return new z(e,r).inc(t,s).version}catch(e){return null}},t.diff=function(e,t){if(Q(e,t))return null;var r=K(e),s=K(t),n="";if(r.prerelease.length||s.prerelease.length){n="pre";var i="prerelease";}for(var o in r)if(("major"===o||"minor"===o||"patch"===o)&&r[o]!==s[o])return n+o;return i},t.compareIdentifiers=H;var W=/^[0-9]+$/;function H(e,t){var r=W.test(e),s=W.test(t);return r&&s&&(e=+e,t=+t),e===t?0:r&&!s?-1:s&&!r?1:e<t?-1:1}function J(e,t,r){return new z(e,r).compare(new z(t,r))}function X(e,t,r){return J(e,t,r)>0}function Y(e,t,r){return J(e,t,r)<0}function Q(e,t,r){return 0===J(e,t,r)}function Z(e,t,r){return 0!==J(e,t,r)}function ee(e,t,r){return J(e,t,r)>=0}function te(e,t,r){return J(e,t,r)<=0}function re(e,t,r,s){switch(t){case"===":return "object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return "object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return Q(e,r,s);case"!=":return Z(e,r,s);case">":return X(e,r,s);case">=":return ee(e,r,s);case"<":return Y(e,r,s);case"<=":return te(e,r,s);default:throw new TypeError("Invalid operator: "+t)}}function se(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof se){if(e.loose===!!t.loose)return e;e=e.value;}if(!(this instanceof se))return new se(e,t);r("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===ne?this.value="":this.value=this.operator+this.semver.version,r("comp",this);}t.rcompareIdentifiers=function(e,t){return H(t,e)},t.major=function(e,t){return new z(e,t).major},t.minor=function(e,t){return new z(e,t).minor},t.patch=function(e,t){return new z(e,t).patch},t.compare=J,t.compareLoose=function(e,t){return J(e,t,!0)},t.rcompare=function(e,t,r){return J(t,e,r)},t.sort=function(e,r){return e.sort((function(e,s){return t.compare(e,s,r)}))},t.rsort=function(e,r){return e.sort((function(e,s){return t.rcompare(e,s,r)}))},t.gt=X,t.lt=Y,t.eq=Q,t.neq=Z,t.gte=ee,t.lte=te,t.cmp=re,t.Comparator=se;var ne={};function ie(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof ie)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new ie(e.raw,t);if(e instanceof se)return new ie(e.value,t);if(!(this instanceof ie))return new ie(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map((function(e){return this.parseRange(e.trim())}),this).filter((function(e){return e.length})),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format();}function oe(e){return !e||"x"===e.toLowerCase()||"*"===e}function ae(e,t,r,s,n,i,o,a,c,l,u,p,d){return ((t=oe(r)?"":oe(s)?">="+r+".0.0":oe(n)?">="+r+"."+s+".0":">="+t)+" "+(a=oe(c)?"":oe(l)?"<"+(+c+1)+".0.0":oe(u)?"<"+c+"."+(+l+1)+".0":p?"<="+c+"."+l+"."+u+"-"+p:"<="+a)).trim()}function ce(e,t,s){for(var n=0;n<e.length;n++)if(!e[n].test(t))return !1;if(t.prerelease.length&&!s.includePrerelease){for(n=0;n<e.length;n++)if(r(e[n].semver),e[n].semver!==ne&&e[n].semver.prerelease.length>0){var i=e[n].semver;if(i.major===t.major&&i.minor===t.minor&&i.patch===t.patch)return !0}return !1}return !0}function le(e,t,r){try{t=new ie(t,r);}catch(e){return !1}return t.test(e)}function ue(e,t,r,s){var n,i,o,a,c;switch(e=new z(e,s),t=new ie(t,s),r){case">":n=X,i=te,o=Y,a=">",c=">=";break;case"<":n=Y,i=ee,o=X,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(le(e,t,s))return !1;for(var l=0;l<t.set.length;++l){var u=t.set[l],p=null,d=null;if(u.forEach((function(e){e.semver===ne&&(e=new se(">=0.0.0")),p=p||e,d=d||e,n(e.semver,p.semver,s)?p=e:o(e.semver,d.semver,s)&&(d=e);})),p.operator===a||p.operator===c)return !1;if((!d.operator||d.operator===a)&&i(e,d.semver))return !1;if(d.operator===c&&o(e,d.semver))return !1}return !0}se.prototype.parse=function(e){var t=this.options.loose?n[V]:n[j],r=e.match(t);if(!r)throw new TypeError("Invalid comparator: "+e);this.operator=r[1],"="===this.operator&&(this.operator=""),r[2]?this.semver=new z(r[2],this.options.loose):this.semver=ne;},se.prototype.toString=function(){return this.value},se.prototype.test=function(e){return r("Comparator.test",e,this.options.loose),this.semver===ne||("string"==typeof e&&(e=new z(e,this.options)),re(e,this.operator,this.semver,this.options))},se.prototype.intersects=function(e,t){if(!(e instanceof se))throw new TypeError("a Comparator is required");var r;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return r=new ie(e.value,t),le(this.value,r,t);if(""===e.operator)return r=new ie(this.value,t),le(e.semver,r,t);var s=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),n=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),i=this.semver.version===e.semver.version,o=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=re(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),c=re(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return s||n||i&&o||a||c},t.Range=ie,ie.prototype.format=function(){return this.range=this.set.map((function(e){return e.join(" ").trim()})).join("||").trim(),this.range},ie.prototype.toString=function(){return this.range},ie.prototype.parseRange=function(e){var t=this.options.loose;e=e.trim();var s=t?n[q]:n[B];e=e.replace(s,ae),r("hyphen replace",e),e=e.replace(n[L],"$1$2$3"),r("comparator trim",e,n[L]),e=(e=(e=e.replace(n[N],"$1~")).replace(n[M],"$1^")).split(/\s+/).join(" ");var i=t?n[V]:n[j],o=e.split(" ").map((function(e){return function(e,t){return r("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){r("caret",e,t);var s=t.loose?n[D]:n[F];return e.replace(s,(function(t,s,n,i,o){var a;return r("caret",e,t,s,n,i,o),oe(s)?a="":oe(n)?a=">="+s+".0.0 <"+(+s+1)+".0.0":oe(i)?a="0"===s?">="+s+"."+n+".0 <"+s+"."+(+n+1)+".0":">="+s+"."+n+".0 <"+(+s+1)+".0.0":o?(r("replaceCaret pr",o),a="0"===s?"0"===n?">="+s+"."+n+"."+i+"-"+o+" <"+s+"."+n+"."+(+i+1):">="+s+"."+n+"."+i+"-"+o+" <"+s+"."+(+n+1)+".0":">="+s+"."+n+"."+i+"-"+o+" <"+(+s+1)+".0.0"):(r("no pr"),a="0"===s?"0"===n?">="+s+"."+n+"."+i+" <"+s+"."+n+"."+(+i+1):">="+s+"."+n+"."+i+" <"+s+"."+(+n+1)+".0":">="+s+"."+n+"."+i+" <"+(+s+1)+".0.0"),r("caret return",a),a}))}(e,t)})).join(" ")}(e,t),r("caret",e),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){var s=t.loose?n[R]:n[P];return e.replace(s,(function(t,s,n,i,o){var a;return r("tilde",e,t,s,n,i,o),oe(s)?a="":oe(n)?a=">="+s+".0.0 <"+(+s+1)+".0.0":oe(i)?a=">="+s+"."+n+".0 <"+s+"."+(+n+1)+".0":o?(r("replaceTilde pr",o),a=">="+s+"."+n+"."+i+"-"+o+" <"+s+"."+(+n+1)+".0"):a=">="+s+"."+n+"."+i+" <"+s+"."+(+n+1)+".0",r("tilde return",a),a}))}(e,t)})).join(" ")}(e,t),r("tildes",e),e=function(e,t){return r("replaceXRanges",e,t),e.split(/\s+/).map((function(e){return function(e,t){e=e.trim();var s=t.loose?n[A]:n[O];return e.replace(s,(function(t,s,n,i,o,a){r("xRange",e,t,s,n,i,o,a);var c=oe(n),l=c||oe(i),u=l||oe(o);return "="===s&&u&&(s=""),c?t=">"===s||"<"===s?"<0.0.0":"*":s&&u?(l&&(i=0),o=0,">"===s?(s=">=",l?(n=+n+1,i=0,o=0):(i=+i+1,o=0)):"<="===s&&(s="<",l?n=+n+1:i=+i+1),t=s+n+"."+i+"."+o):l?t=">="+n+".0.0 <"+(+n+1)+".0.0":u&&(t=">="+n+"."+i+".0 <"+n+"."+(+i+1)+".0"),r("xRange return",t),t}))}(e,t)})).join(" ")}(e,t),r("xrange",e),e=function(e,t){return r("replaceStars",e,t),e.trim().replace(n[$],"")}(e,t),r("stars",e),e}(e,this.options)}),this).join(" ").split(/\s+/);return this.options.loose&&(o=o.filter((function(e){return !!e.match(i)}))),o=o.map((function(e){return new se(e,this.options)}),this)},ie.prototype.intersects=function(e,t){if(!(e instanceof ie))throw new TypeError("a Range is required");return this.set.some((function(r){return r.every((function(r){return e.set.some((function(e){return e.every((function(e){return r.intersects(e,t)}))}))}))}))},t.toComparators=function(e,t){return new ie(e,t).set.map((function(e){return e.map((function(e){return e.value})).join(" ").trim().split(" ")}))},ie.prototype.test=function(e){if(!e)return !1;"string"==typeof e&&(e=new z(e,this.options));for(var t=0;t<this.set.length;t++)if(ce(this.set[t],e,this.options))return !0;return !1},t.satisfies=le,t.maxSatisfying=function(e,t,r){var s=null,n=null;try{var i=new ie(t,r);}catch(e){return null}return e.forEach((function(e){i.test(e)&&(s&&-1!==n.compare(e)||(n=new z(s=e,r)));})),s},t.minSatisfying=function(e,t,r){var s=null,n=null;try{var i=new ie(t,r);}catch(e){return null}return e.forEach((function(e){i.test(e)&&(s&&1!==n.compare(e)||(n=new z(s=e,r)));})),s},t.minVersion=function(e,t){e=new ie(e,t);var r=new z("0.0.0");if(e.test(r))return r;if(r=new z("0.0.0-0"),e.test(r))return r;r=null;for(var s=0;s<e.set.length;++s){e.set[s].forEach((function(e){var t=new z(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":r&&!X(r,t)||(r=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}}));}if(r&&e.test(r))return r;return null},t.validRange=function(e,t){try{return new ie(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,r){return ue(e,t,"<",r)},t.gtr=function(e,t,r){return ue(e,t,">",r)},t.outside=ue,t.prerelease=function(e,t){var r=K(e,t);return r&&r.prerelease.length?r.prerelease:null},t.intersects=function(e,t,r){return e=new ie(e,r),t=new ie(t,r),e.intersects(t)},t.coerce=function(e){if(e instanceof z)return e;if("string"!=typeof e)return null;var t=e.match(n[k]);if(null==t)return null;return K(t[1]+"."+(t[2]||"0")+"."+(t[3]||"0"))};}));const we=`${Un$1}/config/${Rn.toLowerCase()}-extension/v1.json`,ve={async getAppConfig(){try{return (await se(we)).body}catch(e){throw r.error("Error getting app config:",e),e}}};var be=s((function(e$1,r){e$1.exports=function(){function e$1(t){return (e$1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s);}}function n(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},s=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),s.forEach((function(t){i(e,t,r[t]);}));}return e}var a,c,l,u;function p(){var e;return "object"==typeof process&&void 0!==(null===(e=null===process||void 0===process?void 0:process.versions)||void 0===e?void 0:e.node)}function d(){return "object"==typeof window&&void 0!==(null===window||void 0===window?void 0:window.document)}(function(e){e.IDENTIFY="$identify";})(a||(a={})),function(e){e.SET="$set",e.SET_ONCE="$setOnce",e.ADD="$add",e.APPEND="$append",e.PREPEND="$prepend",e.REMOVE="$remove",e.PREINSERT="$preinsert",e.POSTINSERT="$postinsert",e.UNSET="$unset",e.CLEAR_ALL="$clearAll";}(c||(c={})),function(e){e[e.None=0]="None",e[e.Error=1]="Error",e[e.Warn=2]="Warn",e[e.Verbose=3]="Verbose";}(l||(l={})),function(e){e.Unknown="unknown",e.Skipped="skipped",e.Success="success",e.RateLimit="rate_limit",e.PayloadTooLarge="payload_too_large",e.Invalid="invalid",e.Failed="failed";}(u||(u={})),function(e){function t(t){return t>=200&&t<300?e.Success:429===t?e.RateLimit:413===t?e.PayloadTooLarge:t>=400&&t<500?e.Invalid:t>=500?e.Failed:e.Unknown}e.fromHttpCode=t;}(u||(u={})),u.Skipped;var f={},h=function(){return p()?e:"undefined"!=typeof window?window:"undefined"!=typeof self?self:f},g=function(){var e;if(d()){var t=window,r=Array;if(void 0!==t.Prototype&&void 0!==(null===(e=r.prototype)||void 0===e?void 0:e.toJSON))return delete r.prototype.toJSON,!0}return !1},m=function(){var e=h();return e.__AMPLITUDE__=e.__AMPLITUDE__||{},e.__AMPLITUDE__}(),y="Amplitude Logger ",w=function(){function e$1(){this._logLevel=0;}return e$1.prototype.disable=function(){this._logLevel=0;},e$1.prototype.enable=function(e){void 0===e&&(e=l.Warn),this._logLevel=e;},e$1.prototype.log=function(){for(var e$1=[],r=0;r<arguments.length;r++)e$1[r]=arguments[r];this._logLevel<l.Verbose||e.console.log(y+"[Log]: "+e$1.join(" "));},e$1.prototype.warn=function(){for(var e$1=[],r=0;r<arguments.length;r++)e$1[r]=arguments[r];this._logLevel<l.Warn||e.console.warn(y+"[Warn]: "+e$1.join(" "));},e$1.prototype.error=function(){for(var e$1=[],r=0;r<arguments.length;r++)e$1[r]=arguments[r];this._logLevel<l.Error||e.console.error(y+"[Error]: "+e$1.join(" "));},e$1}(),v=(m.logger||(m.logger=new w),{DEFAULT_INSTANCE:"$default_instance",API_VERSION:2,MAX_STRING_LENGTH:4096,MAX_PROPERTY_KEYS:1e3,IDENTIFY_EVENT:"$identify",GROUP_IDENTIFY_EVENT:"$groupidentify",LAST_EVENT_ID:"amplitude_lastEventId",LAST_EVENT_TIME:"amplitude_lastEventTime",LAST_IDENTIFY_ID:"amplitude_lastIdentifyId",LAST_SEQUENCE_NUMBER:"amplitude_lastSequenceNumber",SESSION_ID:"amplitude_sessionId",DEVICE_ID:"amplitude_deviceId",OPT_OUT:"amplitude_optOut",USER_ID:"amplitude_userId",COOKIE_TEST_PREFIX:"amp_cookie_test",COOKIE_PREFIX:"amp",STORAGE_DEFAULT:"",STORAGE_COOKIES:"cookies",STORAGE_NONE:"none",STORAGE_LOCAL:"localStorage",STORAGE_SESSION:"sessionStorage",REVENUE_EVENT:"revenue_amount",REVENUE_PRODUCT_ID:"$productId",REVENUE_QUANTITY:"$quantity",REVENUE_PRICE:"$price",REVENUE_REVENUE_TYPE:"$revenueType",AMP_DEVICE_ID_PARAM:"amp_device_id",REFERRER:"referrer",UTM_SOURCE:"utm_source",UTM_MEDIUM:"utm_medium",UTM_CAMPAIGN:"utm_campaign",UTM_TERM:"utm_term",UTM_CONTENT:"utm_content",ATTRIBUTION_EVENT:"[Amplitude] Attribution Captured"}),b={encode:function(e){for(var t="",r=0;r<e.length;r++){var s=e.charCodeAt(r);s<128?t+=String.fromCharCode(s):s>127&&s<2048?(t+=String.fromCharCode(s>>6|192),t+=String.fromCharCode(63&s|128)):(t+=String.fromCharCode(s>>12|224),t+=String.fromCharCode(s>>6&63|128),t+=String.fromCharCode(63&s|128));}return t},decode:function(e){for(var t="",r=0,s=0,n=0,i=0;r<e.length;)(s=e.charCodeAt(r))<128?(t+=String.fromCharCode(s),r++):s>191&&s<224?(n=e.charCodeAt(r+1),t+=String.fromCharCode((31&s)<<6|63&n),r+=2):(n=e.charCodeAt(r+1),i=e.charCodeAt(r+2),t+=String.fromCharCode((15&s)<<12|(63&n)<<6|63&i),r+=3);return t}},S={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){try{if(window.btoa&&window.atob)return window.btoa(unescape(encodeURIComponent(e)))}catch(e){}return S._encode(e)},_encode:function(e){var t,r,s,n,i,o,a,c="",l=0;for(e=b.encode(e);l<e.length;)n=(t=e.charCodeAt(l++))>>2,i=(3&t)<<4|(r=e.charCodeAt(l++))>>4,o=(15&r)<<2|(s=e.charCodeAt(l++))>>6,a=63&s,isNaN(r)?o=a=64:isNaN(s)&&(a=64),c=c+S._keyStr.charAt(n)+S._keyStr.charAt(i)+S._keyStr.charAt(o)+S._keyStr.charAt(a);return c},decode:function(e){try{if(window.btoa&&window.atob)return decodeURIComponent(escape(window.atob(e)))}catch(e){}return S._decode(e)},_decode:function(e){var t,r,s,n,i,o,a="",c=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");c<e.length;)t=S._keyStr.indexOf(e.charAt(c++))<<2|(n=S._keyStr.indexOf(e.charAt(c++)))>>4,r=(15&n)<<4|(i=S._keyStr.indexOf(e.charAt(c++)))>>2,s=(3&i)<<6|(o=S._keyStr.indexOf(e.charAt(c++))),a+=String.fromCharCode(t),64!==i&&(a+=String.fromCharCode(r)),64!==o&&(a+=String.fromCharCode(s));return a=b.decode(a)}},I=Object.prototype.toString;function E(t){switch(I.call(t)){case"[object Date]":return "date";case"[object RegExp]":return "regexp";case"[object Arguments]":return "arguments";case"[object Array]":return "array";case"[object Error]":return "error"}return null===t?"null":void 0===t?"undefined":t!=t?"nan":t&&1===t.nodeType?"element":"undefined"!=typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(t)?"buffer":e$1(t=t.valueOf?t.valueOf():Object.prototype.valueOf.apply(t))}var _,T={DISABLE:0,ERROR:1,WARN:2,INFO:3},U=T.WARN,O={error:function(e){U>=T.ERROR&&A(e);},warn:function(e){U>=T.WARN&&A(e);},info:function(e){U>=T.INFO&&A(e);}},A=function(e){try{console.log("[Amplitude] "+e);}catch(e){}},k=function e(t){if("array"===E(t))for(var r=0;r<t.length;r++)t[r]=e(t[r]);else if("object"===E(t))for(var s in t)s in t&&(t[s]=e(t[s]));else t=C(t);return t},C=function(e){return "string"===E(e)&&e.length>v.MAX_STRING_LENGTH?e.substring(0,v.MAX_STRING_LENGTH):e},N=function(e,t,r){return E(e)===r||(O.error("Invalid "+t+" input type. Expected "+r+" but received "+E(e)),!1)},P=function(e){var t=E(e);if("object"!==t)return O.error("Error: invalid properties format. Expecting Javascript object, received "+t+", ignoring"),{};if(Object.keys(e).length>v.MAX_PROPERTY_KEYS)return O.error("Error: too many properties (more than 1000), ignoring"),{};var r={};for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var n=s,i=E(n);"string"!==i&&(n=String(n),O.warn("WARNING: Non-string property key, received type "+i+', coercing to string "'+n+'"'));var o=x(n,e[s]);null!==o&&(r[n]=o);}return r},R=["nan","function","arguments","regexp","element"],x=function e(t,r){var s=E(r);if(-1!==R.indexOf(s))O.warn('WARNING: Property key "'+t+'" with invalid value type '+s+", ignoring"),r=null;else if("undefined"===s)r=null;else if("error"===s)r=String(r),O.warn('WARNING: Property key "'+t+'" with value type error, coercing to '+r);else if("array"===s){for(var n=[],i=0;i<r.length;i++){var o=r[i],a=E(o);"array"!==a?"object"===a?n.push(P(o)):n.push(e(t,o)):O.warn("WARNING: Cannot have "+a+" nested in an array property value, skipping");}r=n;}else "object"===s&&(r=P(r));return r},M=function(e){var t=E(e);if("object"!==t)return O.error("Error: invalid groups format. Expecting Javascript object, received "+t+", ignoring"),{};var r={};for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var n=s,i=E(n);"string"!==i&&(n=String(n),O.warn("WARNING: Non-string groupType, received type "+i+', coercing to string "'+n+'"'));var o=F(n,e[s]);null!==o&&(r[n]=o);}return r},F=function(e,t){var r=E(t);if("string"===r)return t;if("date"===r||"number"===r||"boolean"===r)return t=String(t),O.warn("WARNING: Non-string groupName, received type "+r+', coercing to string "'+t+'"'),t;if("array"===r){for(var s=[],n=0;n<t.length;n++){var i=t[n],o=E(i);"array"!==o&&"object"!==o?"string"===o?s.push(i):"date"!==o&&"number"!==o&&"boolean"!==o||(i=String(i),O.warn("WARNING: Non-string groupName, received type "+o+', coercing to string "'+i+'"'),s.push(i)):O.warn("WARNING: Skipping nested "+o+" in array groupName");}return s}O.warn("WARNING: Non-string groupName, received type "+r+". Please use strings or array of strings for groupName");},D={setLogLevel:function(e){Object.prototype.hasOwnProperty.call(T,U)&&(U=T[e]);},getLogLevel:function(){return U},logLevels:T,log:O,isEmptyString:function(e){return !e||0===e.length},getQueryParam:function(e,t){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===r?void 0:decodeURIComponent(r[1].replace(/\+/g," "))},sessionStorageEnabled:function(){try{if(window.sessionStorage)return !0}catch(e){}return !1},truncate:k,validateGroups:M,validateInput:N,validateProperties:P},V=function(){return window.location},j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",L=function(){for(var e="",t=0;t<22;++t)e+=j.charAt(Math.floor(64*Math.random()));return e},B=function(e){try{for(var t=document.cookie.split(";"),r=null,s=0;s<t.length;s++){for(var n=t[s];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e)){r=n.substring(e.length,n.length);break}}return r}catch(e){return null}},q=function(e,t,r){var s=null!==t?r.expirationDays:-1;if(s){var n=new Date;n.setTime(n.getTime()+24*s*60*60*1e3),s=n;}var i=e+"="+t;s&&(i+="; expires="+s.toUTCString()),i+="; path=/",r.domain&&(i+="; domain="+r.domain),r.secure&&(i+="; Secure"),r.sameSite&&(i+="; SameSite="+r.sameSite),document.cookie=i;},$=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=String(new Date);try{var r=v.COOKIE_TEST_PREFIX+L();q(r,t,e);var s=B(r+"=")===t;return q(r,null,e),s}catch(e){}return !1},G={set:q,get:B,areCookiesEnabled:$},K=function(e){var t=document.createElement("a");return t.href=e,t.hostname||location.hostname},z=function(e){for(var t=K(e).split("."),r=[],s="_tldtest_"+L(),n=t.length-2;n>=0;--n)r.push(t.slice(n).join("."));for(var i=0;i<r.length;++i){var o=r[i],a={domain:"."+o};if(G.set(s,1,a),G.get(s))return G.set(s,null,a),o}return ""},W={expirationDays:void 0,domain:void 0},H=function(e){if(0===arguments.length)return W;e=e||{},W.expirationDays=e.expirationDays,W.secure=e.secure,W.sameSite=e.sameSite;var t=D.isEmptyString(e.domain)?"."+z(V().href):e.domain,r=Math.random();W.domain=t,Y("amplitude_test",r);var s=X("amplitude_test");return s&&s===r||(t=null),Q("amplitude_test"),W.domain=t,W},J=function(e){var t="";return W.domain&&(t="."===W.domain.charAt(0)?W.domain.substring(1):W.domain),e+t},X=function(e){var t=J(e)+"=",r=G.get(t);try{if(r)return JSON.parse(S.decode(r))}catch(e){return null}return null},Y=function(e,t){try{return G.set(J(e),S.encode(JSON.stringify(t)),W),!0}catch(e){return !1}},Q=function(e){try{return G.set(J(e),null,W),!0}catch(e){return !1}},Z={reset:function(){W={expirationDays:void 0,domain:void 0};},options:H,get:X,set:Y,remove:Q,setRaw:function(e,t){try{return G.set(J(e),t,W),!0}catch(e){return !1}},getRaw:function(e){var t=J(e)+"=";return G.get(t)}};if(function(){var e,t=new Date;try{return window.localStorage.setItem(t,t),e=window.localStorage.getItem(t)===String(t),window.localStorage.removeItem(t),e}catch(e){}return !1}())_=window.localStorage;else if(window.globalStorage)try{_=window.globalStorage[window.location.hostname];}catch(e){}else if("undefined"!=typeof document){var ee=document.createElement("div"),te="localStorage";ee.style.display="none",document.getElementsByTagName("head")[0].appendChild(ee),ee.addBehavior&&(ee.addBehavior("#default#userdata"),_={length:0,setItem:function(e,t){ee.load(te),ee.getAttribute(e)||this.length++,ee.setAttribute(e,t),ee.save(te);},getItem:function(e){return ee.load(te),ee.getAttribute(e)},removeItem:function(e){ee.load(te),ee.getAttribute(e)&&this.length--,ee.removeAttribute(e),ee.save(te);},clear:function(){ee.load(te);for(var e,t=0;e=ee.XMLDocument.documentElement.attributes[t++];)ee.removeAttribute(e.name);ee.save(te),this.length=0;},key:function(e){return ee.load(te),ee.XMLDocument.documentElement.attributes[e]}},ee.load(te),_.length=ee.XMLDocument.documentElement.attributes.length);}_||(_={length:0,setItem:function(e,t){},getItem:function(e){},removeItem:function(e){},clear:function(){},key:function(e){}});var re,se=_,ne=function(){this.storage=null;};ne.prototype.getStorage=function(){if(null!==this.storage)return this.storage;if(G.areCookiesEnabled())this.storage=Z;else {var e="amp_cookiestore_";this.storage={_options:{expirationDays:void 0,domain:void 0,secure:!1},reset:function(){this._options={expirationDays:void 0,domain:void 0,secure:!1};},options:function(e){return 0===arguments.length?this._options:(e=e||{},this._options.expirationDays=e.expirationDays||this._options.expirationDays,this._options.domain=e.domain||this._options.domain||window&&window.location&&window.location.hostname,this._options.secure=e.secure||!1)},get:function(t){try{return JSON.parse(se.getItem(e+t))}catch(e){}return null},set:function(t,r){try{return se.setItem(e+t,JSON.stringify(r)),!0}catch(e){}return !1},remove:function(t){try{se.removeItem(e+t);}catch(e){return !1}}};}return this.storage};var ie=(i(re={},v.STORAGE_COOKIES,!0),i(re,v.STORAGE_NONE,!0),i(re,v.STORAGE_LOCAL,!0),i(re,v.STORAGE_SESSION,!0),re),oe=function(){function e(t){var s=t.storageKey,n=t.disableCookies,i=t.domain,o=t.secure,a=t.sameSite,c=t.expirationDays,l=t.storage;r(this,e),this.storageKey=s,this.domain=i,this.secure=o,this.sameSite=a,this.expirationDays=c,this.cookieDomain="";var u=z(V().href);if(this.cookieDomain=i||(u?"."+u:null),ie[l])this.storage=l;else {var p=n||!G.areCookiesEnabled({domain:this.cookieDomain,secure:this.secure,sameSite:this.sameSite,expirationDays:this.expirationDays});this.storage=p?v.STORAGE_LOCAL:v.STORAGE_COOKIES;}}return n(e,[{key:"getCookieStorageKey",value:function(){if(!this.domain)return this.storageKey;var e="."===this.domain.charAt(0)?this.domain.substring(1):this.domain;return "".concat(this.storageKey).concat(e?"_".concat(e):"")}},{key:"save",value:function(e){var t=e.deviceId,r=e.userId,s=e.optOut,n=e.sessionId,i=e.lastEventTime,o=e.eventId,a=e.identifyId,c=e.sequenceNumber;if(this.storage!==v.STORAGE_NONE){var l=[t,S.encode(r||""),s?"1":"",n?n.toString(32):"0",i?i.toString(32):"0",o?o.toString(32):"0",a?a.toString(32):"0",c?c.toString(32):"0"].join(".");switch(this.storage){case v.STORAGE_SESSION:window.sessionStorage&&window.sessionStorage.setItem(this.storageKey,l);break;case v.STORAGE_LOCAL:se.setItem(this.storageKey,l);break;case v.STORAGE_COOKIES:G.set(this.getCookieStorageKey(),l,{domain:this.cookieDomain,secure:this.secure,sameSite:this.sameSite,expirationDays:this.expirationDays});}}}},{key:"load",value:function(){var e;if(this.storage===v.STORAGE_COOKIES&&(e=G.get(this.getCookieStorageKey()+"=")),e||(e=se.getItem(this.storageKey)),e||(e=window.sessionStorage&&window.sessionStorage.getItem(this.storageKey)),!e)return null;var t=e.split("."),r=null;if(t[1])try{r=S.decode(t[1]);}catch(e){r=null;}return {deviceId:t[0],userId:r,optOut:"1"===t[2],sessionId:parseInt(t[3],32),lastEventTime:parseInt(t[4],32),eventId:parseInt(t[5],32),identifyId:parseInt(t[6],32),sequenceNumber:parseInt(t[7],32)}}}]),e}(),ae=function(e,t){var r=e?"?"+e.split(".").slice(-1)[0].replace(/\|/g,"&"):"",s=function(e,t,r,s){return D.getQueryParam(e,t)||D.getQueryParam(r,s)},n=s(v.UTM_SOURCE,t,"utmcsr",r),i=s(v.UTM_MEDIUM,t,"utmcmd",r),o=s(v.UTM_CAMPAIGN,t,"utmccn",r),a=s(v.UTM_TERM,t,"utmctr",r),c=s(v.UTM_CONTENT,t,"utmcct",r),l={},u=function(e,t){D.isEmptyString(t)||(l[e]=t);};return u(v.UTM_SOURCE,n),u(v.UTM_MEDIUM,i),u(v.UTM_CAMPAIGN,o),u(v.UTM_TERM,a),u(v.UTM_CONTENT,c),l},ce="$add",le="$append",ue="$clearAll",pe="$prepend",de="$set",fe="$setOnce",he="$unset",ge=function(){this.userPropertiesOperations={},this.properties=[];};ge.prototype.add=function(e,t){return "number"===E(t)||"string"===E(t)?this._addOperation(ce,e,t):D.log.error("Unsupported type for value: "+E(t)+", expecting number or string"),this},ge.prototype.append=function(e,t){return this._addOperation(le,e,t),this},ge.prototype.clearAll=function(){return Object.keys(this.userPropertiesOperations).length>0?(Object.prototype.hasOwnProperty.call(this.userPropertiesOperations,ue)||D.log.error("Need to send $clearAll on its own Identify object without any other operations, skipping $clearAll"),this):(this.userPropertiesOperations[ue]="-",this)},ge.prototype.prepend=function(e,t){return this._addOperation(pe,e,t),this},ge.prototype.set=function(e,t){return this._addOperation(de,e,t),this},ge.prototype.setOnce=function(e,t){return this._addOperation(fe,e,t),this},ge.prototype.unset=function(e){return this._addOperation(he,e,"-"),this},ge.prototype._addOperation=function(e,t,r){Object.prototype.hasOwnProperty.call(this.userPropertiesOperations,ue)?D.log.error("This identify already contains a $clearAll operation, skipping operation "+e):-1===this.properties.indexOf(t)?(Object.prototype.hasOwnProperty.call(this.userPropertiesOperations,e)||(this.userPropertiesOperations[e]={}),this.userPropertiesOperations[e][t]=r,this.properties.push(t)):D.log.error('User property "'+t+'" already used in this identify, skipping operation '+e);};var me="undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function ye(e,t){return e(t={exports:{}},t.exports),t.exports}var we=ye((function(e){!function(t){function r(e,t){var r=(65535&e)+(65535&t);return (e>>16)+(t>>16)+(r>>16)<<16|65535&r}function s(e,t){return e<<t|e>>>32-t}function n(e,t,n,i,o,a){return r(s(r(r(t,e),r(i,a)),o),n)}function i(e,t,r,s,i,o,a){return n(t&r|~t&s,e,t,i,o,a)}function o(e,t,r,s,i,o,a){return n(t&s|r&~s,e,t,i,o,a)}function a(e,t,r,s,i,o,a){return n(t^r^s,e,t,i,o,a)}function c(e,t,r,s,i,o,a){return n(r^(t|~s),e,t,i,o,a)}function l(e,t){var s,n,l,u,p;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var d=1732584193,f=-271733879,h=-1732584194,g=271733878;for(s=0;s<e.length;s+=16)n=d,l=f,u=h,p=g,d=i(d,f,h,g,e[s],7,-680876936),g=i(g,d,f,h,e[s+1],12,-389564586),h=i(h,g,d,f,e[s+2],17,606105819),f=i(f,h,g,d,e[s+3],22,-1044525330),d=i(d,f,h,g,e[s+4],7,-176418897),g=i(g,d,f,h,e[s+5],12,1200080426),h=i(h,g,d,f,e[s+6],17,-1473231341),f=i(f,h,g,d,e[s+7],22,-45705983),d=i(d,f,h,g,e[s+8],7,1770035416),g=i(g,d,f,h,e[s+9],12,-1958414417),h=i(h,g,d,f,e[s+10],17,-42063),f=i(f,h,g,d,e[s+11],22,-1990404162),d=i(d,f,h,g,e[s+12],7,1804603682),g=i(g,d,f,h,e[s+13],12,-40341101),h=i(h,g,d,f,e[s+14],17,-1502002290),d=o(d,f=i(f,h,g,d,e[s+15],22,1236535329),h,g,e[s+1],5,-165796510),g=o(g,d,f,h,e[s+6],9,-1069501632),h=o(h,g,d,f,e[s+11],14,643717713),f=o(f,h,g,d,e[s],20,-373897302),d=o(d,f,h,g,e[s+5],5,-701558691),g=o(g,d,f,h,e[s+10],9,38016083),h=o(h,g,d,f,e[s+15],14,-660478335),f=o(f,h,g,d,e[s+4],20,-405537848),d=o(d,f,h,g,e[s+9],5,568446438),g=o(g,d,f,h,e[s+14],9,-1019803690),h=o(h,g,d,f,e[s+3],14,-187363961),f=o(f,h,g,d,e[s+8],20,1163531501),d=o(d,f,h,g,e[s+13],5,-1444681467),g=o(g,d,f,h,e[s+2],9,-51403784),h=o(h,g,d,f,e[s+7],14,1735328473),d=a(d,f=o(f,h,g,d,e[s+12],20,-1926607734),h,g,e[s+5],4,-378558),g=a(g,d,f,h,e[s+8],11,-2022574463),h=a(h,g,d,f,e[s+11],16,1839030562),f=a(f,h,g,d,e[s+14],23,-35309556),d=a(d,f,h,g,e[s+1],4,-1530992060),g=a(g,d,f,h,e[s+4],11,1272893353),h=a(h,g,d,f,e[s+7],16,-155497632),f=a(f,h,g,d,e[s+10],23,-1094730640),d=a(d,f,h,g,e[s+13],4,681279174),g=a(g,d,f,h,e[s],11,-358537222),h=a(h,g,d,f,e[s+3],16,-722521979),f=a(f,h,g,d,e[s+6],23,76029189),d=a(d,f,h,g,e[s+9],4,-640364487),g=a(g,d,f,h,e[s+12],11,-421815835),h=a(h,g,d,f,e[s+15],16,530742520),d=c(d,f=a(f,h,g,d,e[s+2],23,-995338651),h,g,e[s],6,-198630844),g=c(g,d,f,h,e[s+7],10,1126891415),h=c(h,g,d,f,e[s+14],15,-1416354905),f=c(f,h,g,d,e[s+5],21,-57434055),d=c(d,f,h,g,e[s+12],6,1700485571),g=c(g,d,f,h,e[s+3],10,-1894986606),h=c(h,g,d,f,e[s+10],15,-1051523),f=c(f,h,g,d,e[s+1],21,-2054922799),d=c(d,f,h,g,e[s+8],6,1873313359),g=c(g,d,f,h,e[s+15],10,-30611744),h=c(h,g,d,f,e[s+6],15,-1560198380),f=c(f,h,g,d,e[s+13],21,1309151649),d=c(d,f,h,g,e[s+4],6,-145523070),g=c(g,d,f,h,e[s+11],10,-1120210379),h=c(h,g,d,f,e[s+2],15,718787259),f=c(f,h,g,d,e[s+9],21,-343485551),d=r(d,n),f=r(f,l),h=r(h,u),g=r(g,p);return [d,f,h,g]}function u(e){var t,r="",s=32*e.length;for(t=0;t<s;t+=8)r+=String.fromCharCode(e[t>>5]>>>t%32&255);return r}function p(e){var t,r=[];for(r[(e.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)r[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return r}function d(e){return u(l(p(e),8*e.length))}function f(e,t){var r,s,n=p(e),i=[],o=[];for(i[15]=o[15]=void 0,n.length>16&&(n=l(n,8*e.length)),r=0;r<16;r+=1)i[r]=909522486^n[r],o[r]=1549556828^n[r];return s=l(i.concat(p(t)),512+8*t.length),u(l(o.concat(s),640))}function h(e){var t,r,s="0123456789abcdef",n="";for(r=0;r<e.length;r+=1)t=e.charCodeAt(r),n+=s.charAt(t>>>4&15)+s.charAt(15&t);return n}function g(e){return unescape(encodeURIComponent(e))}function m(e){return d(g(e))}function y(e){return h(m(e))}function w(e,t){return f(g(e),g(t))}function v(e,t){return h(w(e,t))}function b(e,t,r){return t?r?w(t,e):v(t,e):r?m(e):y(e)}e.exports?e.exports=b:t.md5=b;}(me);})),ve=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return "%"+e.charCodeAt(0).toString(16).toUpperCase()}))},be=Object.getOwnPropertySymbols,Se=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;function Ee(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}function _e(){try{if(!Object.assign)return !1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return !1;for(var t={},r=0;r<10;r++)t["_"+String.fromCharCode(r)]=r;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return !1;var s={};return "abcdefghijklmnopqrst".split("").forEach((function(e){s[e]=e;})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},s)).join("")}catch(e){return !1}}var Te=_e()?Object.assign:function(e,t){for(var r,s,n=Ee(e),i=1;i<arguments.length;i++){for(var o in r=Object(arguments[i]))Se.call(r,o)&&(n[o]=r[o]);if(be){s=be(r);for(var a=0;a<s.length;a++)Ie.call(r,s[a])&&(n[s[a]]=r[s[a]]);}}return n},Ue="%[a-f0-9]{2}",Oe=new RegExp(Ue,"gi"),Ae=new RegExp("("+Ue+")+","gi");function ke(e,t){try{return decodeURIComponent(e.join(""))}catch(e){}if(1===e.length)return e;t=t||1;var r=e.slice(0,t),s=e.slice(t);return Array.prototype.concat.call([],ke(r),ke(s))}function Ce(e){try{return decodeURIComponent(e)}catch(s){for(var t=e.match(Oe),r=1;r<t.length;r++)t=(e=ke(t,r).join("")).match(Oe);return e}}function Ne(e){for(var t={"%FE%FF":"��","%FF%FE":"��"},r=Ae.exec(e);r;){try{t[r[0]]=decodeURIComponent(r[0]);}catch(e){var s=Ce(r[0]);s!==r[0]&&(t[r[0]]=s);}r=Ae.exec(e);}t["%C2"]="�";for(var n=Object.keys(t),i=0;i<n.length;i++){var o=n[i];e=e.replace(new RegExp(o,"g"),t[o]);}return e}var Pe=function(e){if("string"!=typeof e)throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof e+"`");try{return e=e.replace(/\+/g," "),decodeURIComponent(e)}catch(t){return Ne(e)}};function Re(e){switch(e.arrayFormat){case"index":return function(t,r,s){return null===r?[Me(t,e),"[",s,"]"].join(""):[Me(t,e),"[",Me(s,e),"]=",Me(r,e)].join("")};case"bracket":return function(t,r){return null===r?Me(t,e):[Me(t,e),"[]=",Me(r,e)].join("")};default:return function(t,r){return null===r?Me(t,e):[Me(t,e),"=",Me(r,e)].join("")}}}function xe(e){var t;switch(e.arrayFormat){case"index":return function(e,r,s){t=/\[(\d*)\]$/.exec(e),e=e.replace(/\[\d*\]$/,""),t?(void 0===s[e]&&(s[e]={}),s[e][t[1]]=r):s[e]=r;};case"bracket":return function(e,r,s){t=/(\[\])$/.exec(e),e=e.replace(/\[\]$/,""),t?void 0!==s[e]?s[e]=[].concat(s[e],r):s[e]=[r]:s[e]=r;};default:return function(e,t,r){void 0!==r[e]?r[e]=[].concat(r[e],t):r[e]=t;}}}function Me(e,t){return t.encode?t.strict?ve(e):encodeURIComponent(e):e}function Fe(e){return Array.isArray(e)?e.sort():"object"==typeof e?Fe(Object.keys(e)).sort((function(e,t){return Number(e)-Number(t)})).map((function(t){return e[t]})):e}function De(e){var t=e.indexOf("?");return -1===t?"":e.slice(t+1)}function Ve(e,t){var r=xe(t=Te({arrayFormat:"none"},t)),s=Object.create(null);return "string"!=typeof e?s:(e=e.trim().replace(/^[?#&]/,""))?(e.split("&").forEach((function(e){var t=e.replace(/\+/g," ").split("="),n=t.shift(),i=t.length>0?t.join("="):void 0;i=void 0===i?null:Pe(i),r(Pe(n),i,s);})),Object.keys(s).sort().reduce((function(e,t){var r=s[t];return Boolean(r)&&"object"==typeof r&&!Array.isArray(r)?e[t]=Fe(r):e[t]=r,e}),Object.create(null))):s}var je={extract:De,parse:Ve,stringify:function(e,t){!1===(t=Te({encode:!0,strict:!0,arrayFormat:"none"},t)).sort&&(t.sort=function(){});var r=Re(t);return e?Object.keys(e).sort(t.sort).map((function(s){var n=e[s];if(void 0===n)return "";if(null===n)return Me(s,t);if(Array.isArray(n)){var i=[];return n.slice().forEach((function(e){void 0!==e&&i.push(r(s,e,i.length));})),i.join("&")}return Me(s,t)+"="+Me(n,t)})).filter((function(e){return e.length>0})).join("&"):""},parseUrl:function(e,t){return {url:e.split("?")[0]||"",query:Ve(De(e),t)}}},Le=function(e,t){this.url=e,this.data=t||{};};Le.prototype.send=function(e){if(window.XDomainRequest){var t=new window.XDomainRequest;t.open("POST",this.url,!0),t.onload=function(){e(200,t.responseText);},t.onerror=function(){"Request Entity Too Large"===t.responseText?e(413,t.responseText):e(500,t.responseText);},t.ontimeout=function(){},t.onprogress=function(){},t.send(je.stringify(this.data));}else {var r=new XMLHttpRequest;r.open("POST",this.url,!0),r.onreadystatechange=function(){4===r.readyState&&e(r.status,r.responseText);},r.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),r.send(je.stringify(this.data));}};var Be=function(){this._price=null,this._productId=null,this._quantity=1,this._revenueType=null,this._properties=null;};Be.prototype.setProductId=function(e){return "string"!==E(e)?D.log.error("Unsupported type for productId: "+E(e)+", expecting string"):D.isEmptyString(e)?D.log.error("Invalid empty productId"):this._productId=e,this},Be.prototype.setQuantity=function(e){return "number"!==E(e)?D.log.error("Unsupported type for quantity: "+E(e)+", expecting number"):this._quantity=parseInt(e),this},Be.prototype.setPrice=function(e){return "number"!==E(e)?D.log.error("Unsupported type for price: "+E(e)+", expecting number"):this._price=e,this},Be.prototype.setRevenueType=function(e){return "string"!==E(e)?D.log.error("Unsupported type for revenueType: "+E(e)+", expecting string"):this._revenueType=e,this},Be.prototype.setEventProperties=function(e){return "object"!==E(e)?D.log.error("Unsupported type for eventProperties: "+E(e)+", expecting object"):this._properties=D.validateProperties(e),this},Be.prototype._isValidRevenue=function(){return "number"===E(this._price)||(D.log.error("Invalid revenue, need to set price field"),!1)},Be.prototype._toJSONObject=function(){var e="object"===E(this._properties)?this._properties:{};return null!==this._productId&&(e[v.REVENUE_PRODUCT_ID]=this._productId),null!==this._quantity&&(e[v.REVENUE_QUANTITY]=this._quantity),null!==this._price&&(e[v.REVENUE_PRICE]=this._price),null!==this._revenueType&&(e[v.REVENUE_REVENUE_TYPE]=this._revenueType),e};var qe,$e,Ge=ye((function(e,t){
/*!
   * UAParser.js v0.7.21
   * Lightweight JavaScript-based User-Agent string parser
   * https://github.com/faisalman/ua-parser-js
   *
   * Copyright © 2012-2019 Faisal Salman <f@faisalman.com>
   * Licensed under MIT License
   */
!function(r,s){var n="0.7.21",i="",o="?",a="function",c="object",l="string",u="major",p="model",d="name",f="type",h="vendor",g="version",m="architecture",y="console",w="mobile",v="tablet",b="smarttv",S="wearable",I="embedded",E={extend:function(e,t){var r={};for(var s in e)t[s]&&t[s].length%2==0?r[s]=t[s].concat(e[s]):r[s]=e[s];return r},has:function(e,t){return "string"==typeof e&&-1!==t.toLowerCase().indexOf(e.toLowerCase())},lowerize:function(e){return e.toLowerCase()},major:function(e){return typeof e===l?e.replace(/[^\d\.]/g,"").split(".")[0]:s},trim:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}},_={rgx:function(e,t){for(var r,n,i,o,l,u,p=0;p<t.length&&!l;){var d=t[p],f=t[p+1];for(r=n=0;r<d.length&&!l;)if(l=d[r++].exec(e))for(i=0;i<f.length;i++)u=l[++n],typeof(o=f[i])===c&&o.length>0?2==o.length?typeof o[1]==a?this[o[0]]=o[1].call(this,u):this[o[0]]=o[1]:3==o.length?typeof o[1]!==a||o[1].exec&&o[1].test?this[o[0]]=u?u.replace(o[1],o[2]):s:this[o[0]]=u?o[1].call(this,u,o[2]):s:4==o.length&&(this[o[0]]=u?o[3].call(this,u.replace(o[1],o[2])):s):this[o]=u||s;p+=2;}},str:function(e,t){for(var r in t)if(typeof t[r]===c&&t[r].length>0){for(var n=0;n<t[r].length;n++)if(E.has(t[r][n],e))return r===o?s:r}else if(E.has(t[r],e))return r===o?s:r;return e}},T={browser:{oldsafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{amazon:{model:{"Fire Phone":["SD","KF"]}},sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}},U={browser:[[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,/(opera).+version\/([\w\.]+)/i,/(opera)[\/\s]+([\w\.]+)/i],[d,g],[/(opios)[\/\s]+([\w\.]+)/i],[[d,"Opera Mini"],g],[/\s(opr)\/([\w\.]+)/i],[[d,"Opera"],g],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]*)/i,/(avant\s|iemobile|slim)(?:browser)?[\/\s]?([\w\.]*)/i,/(bidubrowser|baidubrowser)[\/\s]?([\w\.]+)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(rekonq)\/([\w\.]*)/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon)\/([\w\.-]+)/i],[d,g],[/(konqueror)\/([\w\.]+)/i],[[d,"Konqueror"],g],[/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i],[[d,"IE"],g],[/(edge|edgios|edga|edg)\/((\d+)?[\w\.]+)/i],[[d,"Edge"],g],[/(yabrowser)\/([\w\.]+)/i],[[d,"Yandex"],g],[/(Avast)\/([\w\.]+)/i],[[d,"Avast Secure Browser"],g],[/(AVG)\/([\w\.]+)/i],[[d,"AVG Secure Browser"],g],[/(puffin)\/([\w\.]+)/i],[[d,"Puffin"],g],[/(focus)\/([\w\.]+)/i],[[d,"Firefox Focus"],g],[/(opt)\/([\w\.]+)/i],[[d,"Opera Touch"],g],[/((?:[\s\/])uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i],[[d,"UCBrowser"],g],[/(comodo_dragon)\/([\w\.]+)/i],[[d,/_/g," "],g],[/(windowswechat qbcore)\/([\w\.]+)/i],[[d,"WeChat(Win) Desktop"],g],[/(micromessenger)\/([\w\.]+)/i],[[d,"WeChat"],g],[/(brave)\/([\w\.]+)/i],[[d,"Brave"],g],[/(qqbrowserlite)\/([\w\.]+)/i],[d,g],[/(QQ)\/([\d\.]+)/i],[d,g],[/m?(qqbrowser)[\/\s]?([\w\.]+)/i],[d,g],[/(baiduboxapp)[\/\s]?([\w\.]+)/i],[d,g],[/(2345Explorer)[\/\s]?([\w\.]+)/i],[d,g],[/(MetaSr)[\/\s]?([\w\.]+)/i],[d],[/(LBBROWSER)/i],[d],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[g,[d,"MIUI Browser"]],[/;fbav\/([\w\.]+);/i],[g,[d,"Facebook"]],[/safari\s(line)\/([\w\.]+)/i,/android.+(line)\/([\w\.]+)\/iab/i],[d,g],[/headlesschrome(?:\/([\w\.]+)|\s)/i],[g,[d,"Chrome Headless"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[[d,/(.+)/,"$1 WebView"],g],[/((?:oculus|samsung)browser)\/([\w\.]+)/i],[[d,/(.+(?:g|us))(.+)/,"$1 $2"],g],[/((?:android.+)crmo|crios)\/([\w\.]+)/i,/android.+(chrome)\/([\w\.]+)\s+(?:mobile\s?safari)/i],[[d,"Chrome Mobile"],g],[/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i],[g,[d,"Android Browser"]],[/(sailfishbrowser)\/([\w\.]+)/i],[[d,"Sailfish Browser"],g],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i],[d,g],[/(dolfin)\/([\w\.]+)/i],[[d,"Dolphin"],g],[/(qihu|qhbrowser|qihoobrowser|360browser)/i],[[d,"360 Browser"]],[/(coast)\/([\w\.]+)/i],[[d,"Opera Coast"],g],[/fxios\/([\w\.-]+)/i],[g,[d,"Firefox"]],[/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i],[g,[d,"Mobile Safari"]],[/version\/([\w\.]+).+?(mobile\s?safari|safari)/i],[g,d],[/webkit.+?(gsa)\/([\w\.]+).+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[[d,"GSA"],g],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[d,[g,_.str,T.browser.oldsafari.version]],[/(webkit|khtml)\/([\w\.]+)/i],[d,g],[/(navigator|netscape)\/([\w\.-]+)/i],[[d,"Netscape"],g],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)/i,/(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]*)/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],[d,g]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,E.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/windows\s(ce|mobile);\sppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[m,/ower/,"",E.lowerize]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+[;l]))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[[m,E.lowerize]]],device:[[/\((ipad|playbook);[\w\s\),;-]+(rim|apple)/i],[p,h,[f,v]],[/applecoremedia\/[\w\.]+ \((ipad)/],[p,[h,"Apple"],[f,v]],[/(apple\s{0,1}tv)/i],[[p,"Apple TV"],[h,"Apple"],[f,b]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad)/i,/(hp).+(tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[h,p,[f,v]],[/(kf[A-z]+)\sbuild\/.+silk\//i],[p,[h,"Amazon"],[f,v]],[/(sd|kf)[0349hijorstuw]+\sbuild\/.+silk\//i],[[p,_.str,T.device.amazon.model],[h,"Amazon"],[f,w]],[/android.+aft([bms])\sbuild/i],[p,[h,"Amazon"],[f,b]],[/\((ip[honed|\s\w*]+);.+(apple)/i],[p,h,[f,w]],[/\((ip[honed|\s\w*]+);/i],[p,[h,"Apple"],[f,w]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]*)/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[h,p,[f,w]],[/\(bb10;\s(\w+)/i],[p,[h,"BlackBerry"],[f,w]],[/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone|p00c)/i],[p,[h,"Asus"],[f,v]],[/(sony)\s(tablet\s[ps])\sbuild\//i,/(sony)?(?:sgp.+)\sbuild\//i],[[h,"Sony"],[p,"Xperia Tablet"],[f,v]],[/android.+\s([c-g]\d{4}|so[-l]\w+)(?=\sbuild\/|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[p,[h,"Sony"],[f,w]],[/\s(ouya)\s/i,/(nintendo)\s([wids3u]+)/i],[h,p,[f,y]],[/android.+;\s(shield)\sbuild/i],[p,[h,"Nvidia"],[f,y]],[/(playstation\s[34portablevi]+)/i],[p,[h,"Sony"],[f,y]],[/(sprint\s(\w+))/i],[[h,_.str,T.device.sprint.vendor],[p,_.str,T.device.sprint.model],[f,w]],[/(htc)[;_\s-]+([\w\s]+(?=\)|\sbuild)|\w+)/i,/(zte)-(\w*)/i,/(alcatel|geeksphone|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]*)/i],[h,[p,/_/g," "],[f,w]],[/(nexus\s9)/i],[p,[h,"HTC"],[f,v]],[/d\/huawei([\w\s-]+)[;\)]/i,/(nexus\s6p|vog-l29|ane-lx1|eml-l29)/i],[p,[h,"Huawei"],[f,w]],[/android.+(bah2?-a?[lw]\d{2})/i],[p,[h,"Huawei"],[f,v]],[/(microsoft);\s(lumia[\s\w]+)/i],[h,p,[f,w]],[/[\s\(;](xbox(?:\sone)?)[\s\);]/i],[p,[h,"Microsoft"],[f,y]],[/(kin\.[onetw]{3})/i],[[p,/\./g," "],[h,"Microsoft"],[f,w]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?:?(\s4g)?)[\w\s]+build\//i,/mot[\s-]?(\w*)/i,/(XT\d{3,4}) build\//i,/(nexus\s6)/i],[p,[h,"Motorola"],[f,w]],[/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],[p,[h,"Motorola"],[f,v]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[h,E.trim],[p,E.trim],[f,b]],[/hbbtv.+maple;(\d+)/i],[[p,/^/,"SmartTV"],[h,"Samsung"],[f,b]],[/\(dtv[\);].+(aquos)/i],[p,[h,"Sharp"],[f,b]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,/((SM-T\w+))/i],[[h,"Samsung"],p,[f,v]],[/smart-tv.+(samsung)/i],[h,[f,b],p],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)/i,/sec-((sgh\w+))/i],[[h,"Samsung"],p,[f,w]],[/sie-(\w*)/i],[p,[h,"Siemens"],[f,w]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]*)/i],[[h,"Nokia"],p,[f,w]],[/android[x\d\.\s;]+\s([ab][1-7]\-?[0178a]\d\d?)/i],[p,[h,"Acer"],[f,v]],[/android.+([vl]k\-?\d{3})\s+build/i],[p,[h,"LG"],[f,v]],[/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i],[[h,"LG"],p,[f,v]],[/(lg) netcast\.tv/i],[h,p,[f,b]],[/(nexus\s[45])/i,/lg[e;\s\/-]+(\w*)/i,/android.+lg(\-?[\d\w]+)\s+build/i],[p,[h,"LG"],[f,w]],[/(lenovo)\s?(s(?:5000|6000)(?:[\w-]+)|tab(?:[\s\w]+))/i],[h,p,[f,v]],[/android.+(ideatab[a-z0-9\-\s]+)/i],[p,[h,"Lenovo"],[f,v]],[/(lenovo)[_\s-]?([\w-]+)/i],[h,p,[f,w]],[/linux;.+((jolla));/i],[h,p,[f,w]],[/((pebble))app\/[\d\.]+\s/i],[h,p,[f,S]],[/android.+;\s(oppo)\s?([\w\s]+)\sbuild/i],[h,p,[f,w]],[/crkey/i],[[p,"Chromecast"],[h,"Google"],[f,b]],[/android.+;\s(glass)\s\d/i],[p,[h,"Google"],[f,S]],[/android.+;\s(pixel c)[\s)]/i],[p,[h,"Google"],[f,v]],[/android.+;\s(pixel( [23])?( xl)?)[\s)]/i],[p,[h,"Google"],[f,w]],[/android.+;\s(\w+)\s+build\/hm\1/i,/android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,/android.+(mi[\s\-_]*(?:a\d|one|one[\s_]plus|note lte)?[\s_]*(?:\d?\w?)[\s_]*(?:plus)?)\s+build/i,/android.+(redmi[\s\-_]*(?:note)?(?:[\s_]*[\w\s]+))\s+build/i],[[p,/_/g," "],[h,"Xiaomi"],[f,w]],[/android.+(mi[\s\-_]*(?:pad)(?:[\s_]*[\w\s]+))\s+build/i],[[p,/_/g," "],[h,"Xiaomi"],[f,v]],[/android.+;\s(m[1-5]\snote)\sbuild/i],[p,[h,"Meizu"],[f,w]],[/(mz)-([\w-]{2,})/i],[[h,"Meizu"],p,[f,w]],[/android.+a000(1)\s+build/i,/android.+oneplus\s(a\d{4})[\s)]/i],[p,[h,"OnePlus"],[f,w]],[/android.+[;\/]\s*(RCT[\d\w]+)\s+build/i],[p,[h,"RCA"],[f,v]],[/android.+[;\/\s]+(Venue[\d\s]{2,7})\s+build/i],[p,[h,"Dell"],[f,v]],[/android.+[;\/]\s*(Q[T|M][\d\w]+)\s+build/i],[p,[h,"Verizon"],[f,v]],[/android.+[;\/]\s+(Barnes[&\s]+Noble\s+|BN[RT])(V?.*)\s+build/i],[[h,"Barnes & Noble"],p,[f,v]],[/android.+[;\/]\s+(TM\d{3}.*\b)\s+build/i],[p,[h,"NuVision"],[f,v]],[/android.+;\s(k88)\sbuild/i],[p,[h,"ZTE"],[f,v]],[/android.+[;\/]\s*(gen\d{3})\s+build.*49h/i],[p,[h,"Swiss"],[f,w]],[/android.+[;\/]\s*(zur\d{3})\s+build/i],[p,[h,"Swiss"],[f,v]],[/android.+[;\/]\s*((Zeki)?TB.*\b)\s+build/i],[p,[h,"Zeki"],[f,v]],[/(android).+[;\/]\s+([YR]\d{2})\s+build/i,/android.+[;\/]\s+(Dragon[\-\s]+Touch\s+|DT)(\w{5})\sbuild/i],[[h,"Dragon Touch"],p,[f,v]],[/android.+[;\/]\s*(NS-?\w{0,9})\sbuild/i],[p,[h,"Insignia"],[f,v]],[/android.+[;\/]\s*((NX|Next)-?\w{0,9})\s+build/i],[p,[h,"NextBook"],[f,v]],[/android.+[;\/]\s*(Xtreme\_)?(V(1[045]|2[015]|30|40|60|7[05]|90))\s+build/i],[[h,"Voice"],p,[f,w]],[/android.+[;\/]\s*(LVTEL\-)?(V1[12])\s+build/i],[[h,"LvTel"],p,[f,w]],[/android.+;\s(PH-1)\s/i],[p,[h,"Essential"],[f,w]],[/android.+[;\/]\s*(V(100MD|700NA|7011|917G).*\b)\s+build/i],[p,[h,"Envizen"],[f,v]],[/android.+[;\/]\s*(Le[\s\-]+Pan)[\s\-]+(\w{1,9})\s+build/i],[h,p,[f,v]],[/android.+[;\/]\s*(Trio[\s\-]*.*)\s+build/i],[p,[h,"MachSpeed"],[f,v]],[/android.+[;\/]\s*(Trinity)[\-\s]*(T\d{3})\s+build/i],[h,p,[f,v]],[/android.+[;\/]\s*TU_(1491)\s+build/i],[p,[h,"Rotor"],[f,v]],[/android.+(KS(.+))\s+build/i],[p,[h,"Amazon"],[f,v]],[/android.+(Gigaset)[\s\-]+(Q\w{1,9})\s+build/i],[h,p,[f,v]],[/\s(tablet|tab)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[[f,E.lowerize],h,p],[/[\s\/\(](smart-?tv)[;\)]/i],[[f,b]],[/(android[\w\.\s\-]{0,9});.+build/i],[p,[h,"Generic"]]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[g,[d,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[d,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[d,g],[/rv\:([\w\.]{1,9}).+(gecko)/i],[g,d]],os:[[/microsoft\s(windows)\s(vista|xp)/i],[d,g],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s\w]*)/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],[[d,_.str,T.os.windows.name],[g,_.str,T.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[d,"Windows"],[g,_.str,T.os.windows.version]],[/\((bb)(10);/i],[[d,"BlackBerry"],g],[/(blackberry)\w*\/?([\w\.]*)/i,/(tizen|kaios)[\/\s]([\w\.]+)/i,/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|sailfish|contiki)[\/\s-]?([\w\.]*)/i],[d,g],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]*)/i],[[d,"Symbian"],g],[/\((series40);/i],[d],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[d,"Firefox OS"],g],[/(nintendo|playstation)\s([wids34portablevu]+)/i,/(mint)[\/\s\(]?(\w*)/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|suse|opensuse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]*)/i,/(hurd|linux)\s?([\w\.]*)/i,/(gnu)\s?([\w\.]*)/i],[[d,"Linux"],g],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[d,"Chromium OS"],g],[/(sunos)\s?([\w\.\d]*)/i],[[d,"Solaris"],g],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]*)/i],[[d,"Linux"],g],[/(iphone)(?:.*os\s*([\w]*)\slike\smac|;\sopera)/i],[[d,"iPhone"],[g,/_/g,"."]],[/(ipad)(?:.*os\s*([\w]*)\slike\smac|;\sopera)/i],[[d,"iPad"],[g,/_/g,"."]],[/(haiku)\s(\w+)/i],[d,g],[/cfnetwork\/.+darwin/i,/ip[honead]{2,4}(?:.*os\s([\w]+)\slike\smac|;\sopera)/i],[[g,/_/g,"."],[d,"iOS"]],[/(mac\sos\sx)\s?([\w\s\.]*)/i,/(macintosh|mac(?=_powerpc)\s)/i],[[d,"Mac"],[g,/_/g,"."]],[/((?:open)?solaris)[\/\s-]?([\w\.]*)/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.])*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms|fuchsia)/i,/(unix)\s?([\w\.]*)/i],[d,g]]},O=function(e,t){if("object"==typeof e&&(t=e,e=s),!(this instanceof O))return new O(e,t).getResult();var n=e||(r&&r.navigator&&r.navigator.userAgent?r.navigator.userAgent:i),o=t?E.extend(U,t):U;return this.getBrowser=function(){var e={name:s,version:s};return _.rgx.call(e,n,o.browser),e.major=E.major(e.version),e},this.getCPU=function(){var e={architecture:s};return _.rgx.call(e,n,o.cpu),e},this.getDevice=function(){var e={vendor:s,model:s,type:s};return _.rgx.call(e,n,o.device),e},this.getEngine=function(){var e={name:s,version:s};return _.rgx.call(e,n,o.engine),e},this.getOS=function(){var e={name:s,version:s};return _.rgx.call(e,n,o.os),e},this.getResult=function(){return {ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return n},this.setUA=function(e){return n=e,this},this};O.VERSION=n,O.BROWSER={NAME:d,MAJOR:u,VERSION:g},O.CPU={ARCHITECTURE:m},O.DEVICE={MODEL:p,VENDOR:h,TYPE:f,CONSOLE:y,MOBILE:w,SMARTTV:b,TABLET:v,WEARABLE:S,EMBEDDED:I},O.ENGINE={NAME:d,VERSION:g},O.OS={NAME:d,VERSION:g},e.exports&&(t=e.exports=O),t.UAParser=O;var A=r&&(r.jQuery||r.Zepto);if(A&&!A.ua){var k=new O;A.ua=k.getResult(),A.ua.get=function(){return k.getUA()},A.ua.set=function(e){k.setUA(e);var t=k.getResult();for(var r in t)A.ua[r]=t[r];};}}("object"==typeof window?window:me);})),Ke=(Ge.UAParser,function e(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}),ze="7.4.2",We="Web",He={apiEndpoint:"api.amplitude.com",batchEvents:!1,cookieExpiration:365,cookieName:"amplitude_id",sameSiteCookie:"Lax",cookieForceUpgrade:!1,deferInitialization:!1,disableCookies:!1,deviceIdFromUrlParam:!1,domain:"",eventUploadPeriodMillis:3e4,eventUploadThreshold:30,forceHttps:!0,includeFbclid:!1,includeGclid:!1,includeReferrer:!1,includeUtm:!1,language:navigator&&(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage)||"",logLevel:"WARN",logAttributionCapturedEvent:!1,optOut:!1,onError:function(){},platform:We,savedMaxCount:1e3,saveEvents:!0,saveParamsReferrerOncePerSession:!0,secureCookie:!1,sessionTimeout:18e5,storage:v.STORAGE_DEFAULT,trackingOptions:{city:!0,country:!0,carrier:!0,device_manufacturer:!0,device_model:!0,dma:!0,ip_address:!0,language:!0,os_name:!0,os_version:!0,platform:!0,region:!0,version_name:!0},unsetParamsReferrerOnNewSession:!1,unsentKey:"amplitude_unsent",unsentIdentifyKey:"amplitude_unsent_identify",uploadBatchSize:100},Je=function(e){d()||D.log.warn("amplitude-js will not work in a non-browser environment. If you are planning to add Amplitude to a node environment, please use @amplitude/node"),this._instanceName=D.isEmptyString(e)?v.DEFAULT_INSTANCE:e.toLowerCase(),this._unsentEvents=[],this._unsentIdentifys=[],this._ua=new Ge(navigator.userAgent).getResult(),this.options=o({},He,{trackingOptions:o({},He.trackingOptions)}),this.cookieStorage=(new ne).getStorage(),this._q=[],this._sending=!1,this._updateScheduled=!1,this._onInit=[],this._eventId=0,this._identifyId=0,this._lastEventTime=null,this._newSession=!1,this._sequenceNumber=0,this._sessionId=null,this._isInitialized=!1,this._userAgent=navigator&&navigator.userAgent||null;};Je.prototype.Identify=ge,Je.prototype.Revenue=Be,Je.prototype.init=function(e,t,r,s){var n=this;if("string"!==E(e)||D.isEmptyString(e))D.log.error("Invalid apiKey. Please re-initialize with a valid apiKey");else try{Ye(this.options,r),d()&&void 0!==window.Prototype&&Array.prototype.toJSON&&(g(),D.log.warn("Prototype.js injected Array.prototype.toJSON. Deleting Array.prototype.toJSON to prevent double-stringify")),this.options.cookieName!==He.cookieName&&D.log.warn("The cookieName option is deprecated. We will be ignoring it for newer cookies"),this.options.apiKey=e,this._storageSuffix="_"+e+(this._instanceName===v.DEFAULT_INSTANCE?"":"_"+this._instanceName),this._storageSuffixV5=e.slice(0,6),this._oldCookiename=this.options.cookieName+this._storageSuffix,this._unsentKey=this.options.unsentKey+this._storageSuffix,this._unsentIdentifyKey=this.options.unsentIdentifyKey+this._storageSuffix,this._cookieName=v.COOKIE_PREFIX+"_"+this._storageSuffixV5,this.cookieStorage.options({expirationDays:this.options.cookieExpiration,domain:this.options.domain,secure:this.options.secureCookie,sameSite:this.options.sameSiteCookie}),this._metadataStorage=new oe({storageKey:this._cookieName,disableCookies:this.options.disableCookies,expirationDays:this.options.cookieExpiration,domain:this.options.domain,secure:this.options.secureCookie,sameSite:this.options.sameSiteCookie,storage:this.options.storage});var i=!!this.cookieStorage.get(this._oldCookiename),o=!!this._metadataStorage.load();this._useOldCookie=!o&&i&&!this.options.cookieForceUpgrade;var a=o||i;if(this.options.domain=this.cookieStorage.options().domain,this.options.deferInitialization&&!a)return void this._deferInitialization(e,t,r,s);"string"===E(this.options.logLevel)&&D.setLogLevel(this.options.logLevel);var c=it(this);this._apiPropertiesTrackingOptions=Object.keys(c).length>0?{tracking_options:c}:{},this.options.cookieForceUpgrade&&i&&(o||Ze(this),this.cookieStorage.remove(this._oldCookiename)),Qe(this),this._pendingReadStorage=!0;var l=function(e){n.options.deviceId=n._getInitialDeviceId(r&&r.deviceId,e),n.options.userId="string"===E(t)&&!D.isEmptyString(t)&&t||"number"===E(t)&&t.toString()||n.options.userId||null;var s=(new Date).getTime();(!n._sessionId||!n._lastEventTime||s-n._lastEventTime>n.options.sessionTimeout)&&(n.options.unsetParamsReferrerOnNewSession&&n._unsetUTMParams(),n._newSession=!0,n._sessionId=s,n.options.saveParamsReferrerOncePerSession&&n._trackParamsAndReferrer()),n.options.saveParamsReferrerOncePerSession||n._trackParamsAndReferrer(),n.options.saveEvents&&(Xe(n._unsentEvents),Xe(n._unsentIdentifys)),n._lastEventTime=s,tt(n),n._pendingReadStorage=!1,n._sendEventsIfReady();for(var i=0;i<n._onInit.length;i++)n._onInit[i](n);n._onInit=[],n._isInitialized=!0;};qe?this._migrateUnsentEvents((function(){Promise.all([qe.getItem(n._storageSuffix),qe.getItem(n.options.unsentKey+n._storageSuffix),qe.getItem(n.options.unsentIdentifyKey+n._storageSuffix)]).then((function(e){if(e[0]){var t=JSON.parse(e[0]);t&&et(n,t);}n.options.saveEvents&&(n._unsentEvents=n._parseSavedUnsentEventsString(e[1]).map((function(e){return {event:e}})).concat(n._unsentEvents),n._unsentIdentifys=n._parseSavedUnsentEventsString(e[2]).map((function(e){return {event:e}})).concat(n._unsentIdentifys)),$e?Promise.all([$e.getCarrier(),$e.getModel(),$e.getManufacturer(),$e.getVersion(),$e.getUniqueId()]).then((function(e){n.deviceInfo={carrier:e[0],model:e[1],manufacturer:e[2],version:e[3]},l(e[4]),n.runQueuedFunctions(),"function"===E(s)&&s(n);})).catch((function(e){n.options.onError(e);})):(l(),n.runQueuedFunctions());})).catch((function(e){n.options.onError(e);}));})):(this.options.saveEvents&&(this._unsentEvents=this._loadSavedUnsentEvents(this.options.unsentKey).map((function(e){return {event:e}})).concat(this._unsentEvents),this._unsentIdentifys=this._loadSavedUnsentEvents(this.options.unsentIdentifyKey).map((function(e){return {event:e}})).concat(this._unsentIdentifys)),l(),this.runQueuedFunctions(),"function"===E(s)&&s(this));}catch(e){D.log.error(e),this.options.onError(e);}},Je.prototype.deleteLowerLevelDomainCookies=function(){var e=K(),t=this.options.domain&&"."===this.options.domain[0]?this.options.domain.slice(1):this.options.domain;if(t&&e!==t&&new RegExp(t+"$").test(e)){for(var r=e.split("."),s=t.split("."),n=r.length;n>s.length;--n){var i=r.slice(r.length-n).join(".");G.set(this._cookieName,null,{domain:"."+i});}G.set(this._cookieName,null,{});}},Je.prototype._getInitialDeviceId=function(e,t){if(e)return e;if(this.options.deviceIdFromUrlParam){var r=this._getDeviceIdFromUrlParam(this._getUrlParams());if(r)return r}return this.options.deviceId?this.options.deviceId:t||L()};var Xe=function(e){for(var t=0;t<e.length;t++){var r=e[t].event.user_properties,s=e[t].event.event_properties,n=e[t].event.groups;e[t].event.user_properties=D.validateProperties(r),e[t].event.event_properties=D.validateProperties(s),e[t].event.groups=D.validateGroups(n);}};Je.prototype._migrateUnsentEvents=function(e){var t=this;Promise.all([qe.getItem(this.options.unsentKey),qe.getItem(this.options.unsentIdentifyKey)]).then((function(e){if(t.options.saveEvents){var r=e[0],s=e[1],n=[],i=[];r&&(n.push(qe.setItem(t.options.unsentKey+t._storageSuffix,JSON.stringify(r))),i.push(qe.removeItem(t.options.unsentKey))),s&&(n.push(qe.setItem(t.options.unsentIdentifyKey+t._storageSuffix,JSON.stringify(s))),i.push(qe.removeItem(t.options.unsentIdentifyKey))),n.length>0&&Promise.all(n).then((function(){})).catch((function(e){t.options.onError(e);}));}})).then(e).catch((function(e){t.options.onError(e);}));},Je.prototype._trackParamsAndReferrer=function(){var e,t,r,s;if(this.options.includeUtm&&(e=this._initUtmData()),this.options.includeReferrer&&(t=this._saveReferrer(this._getReferrer())),this.options.includeGclid&&(r=this._saveGclid(this._getUrlParams())),this.options.includeFbclid&&(s=this._saveFbclid(this._getUrlParams())),this.options.logAttributionCapturedEvent){var n=o({},e,t,r,s);Object.keys(n).length>0&&this.logEvent(v.ATTRIBUTION_EVENT,n);}};var Ye=function e(t,r){if("object"===E(r)){var s=function(s){if(Object.prototype.hasOwnProperty.call(t,s)){var n=r[s],i=E(t[s]);D.validateInput(n,s+" option",i)&&("boolean"===i?t[s]=!!n:"string"===i&&!D.isEmptyString(n)||"number"===i&&n>0?t[s]=n:"object"===i&&e(t[s],n));}};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&s(n);}};Je.prototype.runQueuedFunctions=function(){var e=this._q;this._q=[];for(var t=0;t<e.length;t++){var r=this[e[t][0]];"function"===E(r)&&r.apply(this,e[t].slice(1));}},Je.prototype._apiKeySet=function(e){return !D.isEmptyString(this.options.apiKey)||(D.log.error("Invalid apiKey. Please set a valid apiKey with init() before calling "+e),!1)},Je.prototype._loadSavedUnsentEvents=function(e){var t=this._getFromStorage(se,e),r=this._parseSavedUnsentEventsString(t,e);return this._setInStorage(se,e,JSON.stringify(r)),r},Je.prototype._parseSavedUnsentEventsString=function(e,t){if(D.isEmptyString(e))return [];if("string"===E(e))try{var r=JSON.parse(e);if("array"===E(r))return r}catch(e){}return D.log.error("Unable to load "+t+" events. Restart with a new empty queue."),[]},Je.prototype.isNewSession=function(){return this._newSession},Je.prototype.onInit=function(e){this._isInitialized?e(this):this._onInit.push(e);},Je.prototype.getSessionId=function(){return this._sessionId},Je.prototype.nextEventId=function(){return this._eventId++,this._eventId},Je.prototype.nextIdentifyId=function(){return this._identifyId++,this._identifyId},Je.prototype.nextSequenceNumber=function(){return this._sequenceNumber++,this._sequenceNumber},Je.prototype._unsentCount=function(){return this._unsentEvents.length+this._unsentIdentifys.length},Je.prototype._sendEventsIfReady=function(){return 0!==this._unsentCount()&&(this.options.batchEvents?this._unsentCount()>=this.options.eventUploadThreshold?(this.sendEvents(),!0):(this._updateScheduled||(this._updateScheduled=!0,setTimeout(function(){this._updateScheduled=!1,this.sendEvents();}.bind(this),this.options.eventUploadPeriodMillis)),!1):(this.sendEvents(),!0))},Je.prototype._getFromStorage=function(e,t){return e.getItem(t+this._storageSuffix)},Je.prototype._setInStorage=function(e,t,r){e.setItem(t+this._storageSuffix,r);};var Qe=function(e){if(e._useOldCookie){var t=e.cookieStorage.get(e._oldCookiename);"object"!==E(t)||et(e,t);}else {var r=e._metadataStorage.load();"object"===E(r)&&et(e,r);}},Ze=function(e){var t=e.cookieStorage.get(e._oldCookiename);"object"===E(t)&&(et(e,t),tt(e));},et=function(e,t){t.deviceId&&(e.options.deviceId=t.deviceId),t.userId&&(e.options.userId=t.userId),null!==t.optOut&&void 0!==t.optOut&&!1!==t.optOut&&(e.options.optOut=t.optOut),t.sessionId&&(e._sessionId=parseInt(t.sessionId,10)),t.lastEventTime&&(e._lastEventTime=parseInt(t.lastEventTime,10)),t.eventId&&(e._eventId=parseInt(t.eventId,10)),t.identifyId&&(e._identifyId=parseInt(t.identifyId,10)),t.sequenceNumber&&(e._sequenceNumber=parseInt(t.sequenceNumber,10));},tt=function(e){var t={deviceId:e.options.deviceId,userId:e.options.userId,optOut:e.options.optOut,sessionId:e._sessionId,lastEventTime:e._lastEventTime,eventId:e._eventId,identifyId:e._identifyId,sequenceNumber:e._sequenceNumber};e._useOldCookie?e.cookieStorage.set(e.options.cookieName+e._storageSuffix,t):e._metadataStorage.save(t);};Je.prototype._initUtmData=function(e,t){e=e||this._getUrlParams(),t=t||this.cookieStorage.get("__utmz");var r=ae(t,e);return rt(this,r),r},Je.prototype._unsetUTMParams=function(){var e=new ge;e.unset(v.REFERRER),e.unset(v.UTM_SOURCE),e.unset(v.UTM_MEDIUM),e.unset(v.UTM_CAMPAIGN),e.unset(v.UTM_TERM),e.unset(v.UTM_CONTENT),this.identify(e);};var rt=function(e,t){if("object"===E(t)&&0!==Object.keys(t).length){var r=new ge;for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(r.setOnce("initial_"+s,t[s]),r.set(s,t[s]));e.identify(r);}};Je.prototype._getReferrer=function(){return document.referrer},Je.prototype._getUrlParams=function(){return location.search},Je.prototype._saveGclid=function(e){var t=D.getQueryParam("gclid",e);if(!D.isEmptyString(t)){var r={gclid:t};return rt(this,r),r}},Je.prototype._saveFbclid=function(e){var t=D.getQueryParam("fbclid",e);if(!D.isEmptyString(t)){var r={fbclid:t};return rt(this,r),r}},Je.prototype._getDeviceIdFromUrlParam=function(e){return D.getQueryParam(v.AMP_DEVICE_ID_PARAM,e)},Je.prototype._getReferringDomain=function(e){if(D.isEmptyString(e))return null;var t=e.split("/");return t.length>=3?t[2]:null},Je.prototype._saveReferrer=function(e){if(!D.isEmptyString(e)){var t={referrer:e,referring_domain:this._getReferringDomain(e)};return rt(this,t),t}},Je.prototype.saveEvents=function(){try{var e=JSON.stringify(this._unsentEvents.map((function(e){return e.event})));qe?qe.setItem(this.options.unsentKey+this._storageSuffix,e):this._setInStorage(se,this.options.unsentKey,e);}catch(e){}try{var t=JSON.stringify(this._unsentIdentifys.map((function(e){return e.event})));qe?qe.setItem(this.options.unsentIdentifyKey+this._storageSuffix,t):this._setInStorage(se,this.options.unsentIdentifyKey,t);}catch(e){}},Je.prototype.setDomain=function(e){if(this._shouldDeferCall())return this._q.push(["setDomain"].concat(Array.prototype.slice.call(arguments,0)));if(D.validateInput(e,"domain","string"))try{this.cookieStorage.options({expirationDays:this.options.cookieExpiration,secure:this.options.secureCookie,domain:e,sameSite:this.options.sameSiteCookie}),this.options.domain=this.cookieStorage.options().domain,Qe(this),tt(this);}catch(e){D.log.error(e);}},Je.prototype.setUserId=function(e){if(this._shouldDeferCall())return this._q.push(["setUserId"].concat(Array.prototype.slice.call(arguments,0)));try{this.options.userId=null!=e&&""+e||null,tt(this);}catch(e){D.log.error(e);}},Je.prototype.setGroup=function(e,t){if(this._shouldDeferCall())return this._q.push(["setGroup"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("setGroup()")&&D.validateInput(e,"groupType","string")&&!D.isEmptyString(e)){var r={};r[e]=t;var s=(new ge).set(e,t);this._logEvent(v.IDENTIFY_EVENT,null,null,s.userPropertiesOperations,r,null,null,null);}},Je.prototype.setOptOut=function(e){if(this._shouldDeferCall())return this._q.push(["setOptOut"].concat(Array.prototype.slice.call(arguments,0)));if(D.validateInput(e,"enable","boolean"))try{this.options.optOut=e,tt(this);}catch(e){D.log.error(e);}},Je.prototype.setSessionId=function(e){if(D.validateInput(e,"sessionId","number"))try{this._sessionId=e,tt(this);}catch(e){D.log.error(e);}},Je.prototype.resetSessionId=function(){this.setSessionId((new Date).getTime());},Je.prototype.regenerateDeviceId=function(){if(this._shouldDeferCall())return this._q.push(["regenerateDeviceId"].concat(Array.prototype.slice.call(arguments,0)));this.setDeviceId(L());},Je.prototype.setDeviceId=function(e){if(this._shouldDeferCall())return this._q.push(["setDeviceId"].concat(Array.prototype.slice.call(arguments,0)));if(D.validateInput(e,"deviceId","string"))try{D.isEmptyString(e)||(this.options.deviceId=""+e,tt(this));}catch(e){D.log.error(e);}},Je.prototype.setUserProperties=function(e){if(this._shouldDeferCall())return this._q.push(["setUserProperties"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("setUserProperties()")&&D.validateInput(e,"userProperties","object")){var t=D.truncate(D.validateProperties(e));if(0!==Object.keys(t).length){var r=new ge;for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&r.set(s,t[s]);this.identify(r);}}},Je.prototype.clearUserProperties=function(){if(this._shouldDeferCall())return this._q.push(["clearUserProperties"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("clearUserProperties()")){var e=new ge;e.clearAll(),this.identify(e);}};var st=function(e,t){for(var r=0;r<t._q.length;r++){var s=e[t._q[r][0]];"function"===E(s)&&s.apply(e,t._q[r].slice(1));}return e};Je.prototype.identify=function(e,t){if(this._shouldDeferCall())return this._q.push(["identify"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("identify()"))if(Object.prototype.hasOwnProperty.call(e,"_q")&&(e=st(new ge,e)),e instanceof ge){if(Object.keys(e.userPropertiesOperations).length>0)return this._logEvent(v.IDENTIFY_EVENT,null,null,e.userPropertiesOperations,null,null,null,t);"function"===E(t)&&t(0,"No request sent",{reason:"No user property operations"});}else D.log.error("Invalid identify input type. Expected Identify object but saw "+E(e)),"function"===E(t)&&t(0,"No request sent",{reason:"Invalid identify input type"});else "function"===E(t)&&t(0,"No request sent",{reason:"API key is not set"});},Je.prototype.groupIdentify=function(e,t,r,s){if(this._shouldDeferCall())return this._q.push(["groupIdentify"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("groupIdentify()"))if(D.validateInput(e,"group_type","string")&&!D.isEmptyString(e))if(null!=t)if(Object.prototype.hasOwnProperty.call(r,"_q")&&(r=st(new ge,r)),r instanceof ge){if(Object.keys(r.userPropertiesOperations).length>0)return this._logEvent(v.GROUP_IDENTIFY_EVENT,null,null,null,i({},e,t),r.userPropertiesOperations,null,s);"function"===E(s)&&s(0,"No request sent",{reason:"No group property operations"});}else D.log.error("Invalid identify input type. Expected Identify object but saw "+E(r)),"function"===E(s)&&s(0,"No request sent",{reason:"Invalid identify input type"});else "function"===E(s)&&s(0,"No request sent",{reason:"Invalid group name"});else "function"===E(s)&&s(0,"No request sent",{reason:"Invalid group type"});else "function"===E(s)&&s(0,"No request sent",{reason:"API key is not set"});},Je.prototype.setVersionName=function(e){if(this._shouldDeferCall())return this._q.push(["setVersionName"].concat(Array.prototype.slice.call(arguments,0)));D.validateInput(e,"versionName","string")&&(this.options.versionName=e);},Je.prototype._logEvent=function(e,t,r,s,n,i,a,c){if(Qe(this),e)if(this.options.optOut)"function"===E(c)&&c(0,"No request sent",{reason:"optOut is set to true"});else try{var l;l=e===v.IDENTIFY_EVENT||e===v.GROUP_IDENTIFY_EVENT?this.nextIdentifyId():this.nextEventId();var u=this.nextSequenceNumber(),p="number"===E(a)?a:(new Date).getTime();(!this._sessionId||!this._lastEventTime||p-this._lastEventTime>this.options.sessionTimeout)&&(this._sessionId=p),this._lastEventTime=p,tt(this);var d,f,h,g=this._ua.browser.name,m=this._ua.browser.major,y=this._ua.os.name;s=s||{};var w=o({},this._apiPropertiesTrackingOptions);r=o({},r||{},w),t=t||{},n=n||{},i=i||{};var b={device_id:this.options.deviceId,user_id:this.options.userId,timestamp:p,event_id:l,session_id:this._sessionId||-1,event_type:e,version_name:nt(this,"version_name")&&(this.options.versionName||f)||null,platform:nt(this,"platform")?this.options.platform:null,os_name:nt(this,"os_name")&&g||null,os_version:nt(this,"os_version")&&m||null,device_model:nt(this,"device_model")&&y||null,device_manufacturer:nt(this,"device_manufacturer")&&d||null,language:nt(this,"language")?this.options.language:null,carrier:nt(this,"carrier")&&h||null,api_properties:r,event_properties:D.truncate(D.validateProperties(t)),user_properties:D.truncate(D.validateProperties(s)),uuid:Ke(),library:{name:"amplitude-js",version:ze},sequence_number:u,groups:D.truncate(D.validateGroups(n)),group_properties:D.truncate(D.validateProperties(i)),user_agent:this._userAgent};return e===v.IDENTIFY_EVENT||e===v.GROUP_IDENTIFY_EVENT?(this._unsentIdentifys.push({event:b,callback:c}),this._limitEventsQueued(this._unsentIdentifys)):(this._unsentEvents.push({event:b,callback:c}),this._limitEventsQueued(this._unsentEvents)),this.options.saveEvents&&this.saveEvents(),this._sendEventsIfReady(c),l}catch(e){D.log.error(e);}else "function"===E(c)&&c(0,"No request sent",{reason:"Missing eventType"});};var nt=function(e,t){return !!e.options.trackingOptions[t]},it=function(e){for(var t=["city","country","dma","ip_address","region"],r={},s=0;s<t.length;s++){var n=t[s];nt(e,n)||(r[n]=!1);}return r};Je.prototype._limitEventsQueued=function(e){e.length>this.options.savedMaxCount&&e.splice(0,e.length-this.options.savedMaxCount).forEach((function(e){"function"===E(e.callback)&&e.callback(0,"No request sent",{reason:"Event dropped because options.savedMaxCount exceeded. User may be offline or have a content blocker"});}));},Je.prototype.logEvent=function(e,t,r){return this._shouldDeferCall()?this._q.push(["logEvent"].concat(Array.prototype.slice.call(arguments,0))):this.logEventWithTimestamp(e,t,null,r)},Je.prototype.logEventWithTimestamp=function(e,t,r,s){return this._shouldDeferCall()?this._q.push(["logEventWithTimestamp"].concat(Array.prototype.slice.call(arguments,0))):this._apiKeySet("logEvent()")?D.validateInput(e,"eventType","string")?D.isEmptyString(e)?("function"===E(s)&&s(0,"No request sent",{reason:"Missing eventType"}),-1):this._logEvent(e,t,null,null,null,null,r,s):("function"===E(s)&&s(0,"No request sent",{reason:"Invalid type for eventType"}),-1):("function"===E(s)&&s(0,"No request sent",{reason:"API key not set"}),-1)},Je.prototype.logEventWithGroups=function(e,t,r,s){return this._shouldDeferCall()?this._q.push(["logEventWithGroups"].concat(Array.prototype.slice.call(arguments,0))):this._apiKeySet("logEventWithGroups()")?D.validateInput(e,"eventType","string")?this._logEvent(e,t,null,null,r,null,null,s):("function"===E(s)&&s(0,"No request sent",{reason:"Invalid type for eventType"}),-1):("function"===E(s)&&s(0,"No request sent",{reason:"API key not set"}),-1)};var ot=function(e){return !isNaN(parseFloat(e))&&isFinite(e)};Je.prototype.logRevenueV2=function(e){if(this._shouldDeferCall())return this._q.push(["logRevenueV2"].concat(Array.prototype.slice.call(arguments,0)));if(this._apiKeySet("logRevenueV2()"))if(Object.prototype.hasOwnProperty.call(e,"_q")&&(e=st(new Be,e)),e instanceof Be){if(e&&e._isValidRevenue())return this.logEvent(v.REVENUE_EVENT,e._toJSONObject())}else D.log.error("Invalid revenue input type. Expected Revenue object but saw "+E(e));},Je.prototype.logRevenue=function(e,t,r){return this._shouldDeferCall()?this._q.push(["logRevenue"].concat(Array.prototype.slice.call(arguments,0))):this._apiKeySet("logRevenue()")&&ot(e)&&(void 0===t||ot(t))?this._logEvent(v.REVENUE_EVENT,{},{productId:r,special:"revenue_amount",quantity:t||1,price:e},null,null,null,null,null):-1},Je.prototype.removeEvents=function(e,t,r,s){at(this,"_unsentEvents",e,r,s),at(this,"_unsentIdentifys",t,r,s);};var at=function(e,t,r,s,n){if(!(r<0)){for(var i=[],o=0;o<e[t].length;o++){var a=e[t][o];a.event.event_id>r?i.push(a):a.callback&&a.callback(s,n);}e[t]=i;}};Je.prototype.sendEvents=function(){if(this._apiKeySet("sendEvents()")){if(this.options.optOut)this.removeEvents(1/0,1/0,0,"No request sent",{reason:"Opt out is set to true"});else if(0!==this._unsentCount()&&!this._sending){this._sending=!0;var e=(this.options.forceHttps||"https:"===window.location.protocol?"https":"http")+"://"+this.options.apiEndpoint,t=Math.min(this._unsentCount(),this.options.uploadBatchSize),r=this._mergeEventsAndIdentifys(t),s=r.maxEventId,n=r.maxIdentifyId,i=JSON.stringify(r.eventsToSend.map((function(e){return e.event}))),o=(new Date).getTime(),a={client:this.options.apiKey,e:i,v:v.API_VERSION,upload_time:o,checksum:we(v.API_VERSION+this.options.apiKey+i+o)},c=this;new Le(e,a).send((function(e,r){c._sending=!1;try{200===e&&"success"===r?(c.removeEvents(s,n,e,r),c.options.saveEvents&&c.saveEvents(),c._sendEventsIfReady()):413===e&&(1===c.options.uploadBatchSize&&c.removeEvents(s,n,e,r),c.options.uploadBatchSize=Math.ceil(t/2),c.sendEvents());}catch(e){}}));}}else this.removeEvents(1/0,1/0,0,"No request sent",{reason:"API key not set"});},Je.prototype._mergeEventsAndIdentifys=function(e){for(var t=[],r=0,s=-1,n=0,i=-1;t.length<e;){var o=void 0,a=n>=this._unsentIdentifys.length,c=r>=this._unsentEvents.length;if(c&&a){D.log.error("Merging Events and Identifys, less events and identifys than expected");break}a?s=(o=this._unsentEvents[r++]).event.event_id:c?i=(o=this._unsentIdentifys[n++]).event.event_id:!("sequence_number"in this._unsentEvents[r].event)||this._unsentEvents[r].event.sequence_number<this._unsentIdentifys[n].event.sequence_number?s=(o=this._unsentEvents[r++]).event.event_id:i=(o=this._unsentIdentifys[n++]).event.event_id,t.push(o);}return {eventsToSend:t,maxEventId:s,maxIdentifyId:i}},Je.prototype.setGlobalUserProperties=function(e){this.setUserProperties(e);},Je.prototype.__VERSION__=ze,Je.prototype._shouldDeferCall=function(){return this._pendingReadStorage||this._initializationDeferred},Je.prototype._deferInitialization=function(){this._initializationDeferred=!0,this._q.push(["init"].concat(Array.prototype.slice.call(arguments,0)));},Je.prototype.enableTracking=function(){this._initializationDeferred=!1,tt(this),this.runQueuedFunctions();};var ct=function(){this.options=o({},He),this._q=[],this._instances={};};ct.prototype.Identify=ge,ct.prototype.Revenue=Be,ct.prototype.getInstance=function(e){e=D.isEmptyString(e)?v.DEFAULT_INSTANCE:e.toLowerCase();var t=this._instances[e];return void 0===t&&(t=new Je(e),this._instances[e]=t),t},ct.prototype.runQueuedFunctions=function(){for(var e=0;e<this._q.length;e++){var t=this[this._q[e][0]];"function"===E(t)&&t.apply(this,this._q[e].slice(1));}for(var r in this._q=[],this._instances)Object.prototype.hasOwnProperty.call(this._instances,r)&&this._instances[r].runQueuedFunctions();},ct.prototype.init=function(e,t,r,s){this.getInstance().init(e,t,r,function(e){this.options=e.options,"function"===E(s)&&s(e);}.bind(this));},ct.prototype.isNewSession=function(){return this.getInstance().isNewSession()},ct.prototype.getSessionId=function(){return this.getInstance().getSessionId()},ct.prototype.nextEventId=function(){return this.getInstance().nextEventId()},ct.prototype.nextIdentifyId=function(){return this.getInstance().nextIdentifyId()},ct.prototype.nextSequenceNumber=function(){return this.getInstance().nextSequenceNumber()},ct.prototype.saveEvents=function(){this.getInstance().saveEvents();},ct.prototype.setDomain=function(e){this.getInstance().setDomain(e);},ct.prototype.setUserId=function(e){this.getInstance().setUserId(e);},ct.prototype.setGroup=function(e,t){this.getInstance().setGroup(e,t);},ct.prototype.setOptOut=function(e){this.getInstance().setOptOut(e);},ct.prototype.regenerateDeviceId=function(){this.getInstance().regenerateDeviceId();},ct.prototype.setDeviceId=function(e){this.getInstance().setDeviceId(e);},ct.prototype.setUserProperties=function(e){this.getInstance().setUserProperties(e);},ct.prototype.clearUserProperties=function(){this.getInstance().clearUserProperties();},ct.prototype.identify=function(e,t){this.getInstance().identify(e,t);},ct.prototype.setVersionName=function(e){this.getInstance().setVersionName(e);},ct.prototype.logEvent=function(e,t,r){return this.getInstance().logEvent(e,t,r)},ct.prototype.logEventWithGroups=function(e,t,r,s){return this.getInstance().logEventWithGroups(e,t,r,s)},ct.prototype.logRevenueV2=function(e){return this.getInstance().logRevenueV2(e)},ct.prototype.logRevenue=function(e,t,r){return this.getInstance().logRevenue(e,t,r)},ct.prototype.removeEvents=function(e,t){this.getInstance().removeEvents(e,t);},ct.prototype.sendEvents=function(e){this.getInstance().sendEvents(e);},ct.prototype.setGlobalUserProperties=function(e){this.getInstance().setUserProperties(e);},ct.prototype.__VERSION__=ze;var lt=window.amplitude||{},ut=new ct;for(var pt in ut._q=lt._q||[],lt._iq)Object.prototype.hasOwnProperty.call(lt._iq,pt)&&(ut.getInstance(pt)._q=lt._iq[pt]._q||[]);return ut.runQueuedFunctions(),ut}();}));const Se=`${Un$1}/labels`,Ie={async getForUser(){try{return (await se(Se)).body}catch(e){throw r.error("Error getting labels for user:",e),e}},async getDefaultSourceLabels(){try{return (await se(`${Se}/default-source-labels`)).body}catch(e){throw r.error("Error getting default source labels:",e),e}},async getUserSourceLabels(){try{return (await se(`${Se}/user-source-labels`)).body}catch(e){throw r.error("Error getting user source labels:",e),e}},async save(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{const e=(await se(Se,t)).body,r=[],s=[];for(const t of e)r.push(t.id),s.push(t.name);return mt({type:"label.save-serverSuccess",ids:r,names:s}),e}catch(t){r.error("Error saving label:",t);const r$1=[],n=[];for(const t of e)r$1.push(t.id),n.push(t.name);throw mt({type:"label.save-serverError",ids:r$1,names:n}),t}},async saveUserSourceLabel(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{return (await se(`${Se}/user-source-labels`,t)).body}catch(e){throw r.error("Error saving user source label:",e),e}},async saveDefaultSourceLabel(e){const t={method:"POST",body:JSON.stringify(e)};try{return (await se(`${Se}/default-source-labels`,t)).body}catch(e){throw r.error("Error saving user source label:",e),e}}};class Ee{static init(){re("labelStore").subscribe((async()=>{Gt({labels:await this.getLabels()});}));}static async updateLabelsFromAPI(){const e=await Ie.getForUser(),t=o.keyBy(e,"id");await Qn("labelStore",t);}static async updateDefaultSourceLabelsFromAPI(){const e=await Ie.getDefaultSourceLabels(),t=o.groupBy(e,"sourceId");await Qn("defaultSourceLabelStore",t);}static async updateUserSourceLabelsFromAPI(){const e=await Ie.getUserSourceLabels(),t=o.groupBy(e,"sourceId");await Qn("userSourceLabelStore",t);}static async save(e){const t=await Ie.save(e),r=await Xn("labelStore")||{},s=Object.values(r).concat(t),n=o.keyBy(s,"id");return await Qn("labelStore",n),t}static async saveUserSourceLabel(e){const t=await Ie.saveUserSourceLabel(e),r=await Xn("userSourceLabelStore")||{};for(const e of t)r[e.sourceId]=[e];return await Qn("userSourceLabelStore",r),t}static async saveDefaultSourceLabel(e){const t=await Ie.saveDefaultSourceLabel(e),r=await Xn("defaultSourceLabelStore")||{};for(const e of t){const t=r[e.sourceId]||[];o.remove(t,(t=>t.locale===e.locale)),r[e.sourceId]=[...t,e];}return await Qn("defaultSourceLabelStore",r),t}static async getLabels(){return await Xn("labelStore")||{}}static async getUserSourceLabels(){return await Xn("userSourceLabelStore")||{}}static async getDefaultSourceLabels(){return await Xn("defaultSourceLabelStore")||{}}static getUserSourceLabelsForSources(e,t,r){const s={...r,...t};let n={},i=[];return e&&(i=o.map(e,(e=>e.id))),s&&i&&(n=Object.keys(s).filter((e=>i.includes(e))).reduce(((e,t)=>({...e,[t]:s[t]})),{})),n}static async getSourceLabelStoreForSources(e){const t=await Ee.getUserSourceLabels(),r=await Ee.getDefaultSourceLabels();return Ee.getUserSourceLabelsForSources(e,t,r)}static async getLabelsForSources(e){const t=await Ee.getSourceLabelStoreForSources(e),r=await Ee.getLabels(),s={};if(!(t&&Object.keys(t).length&&r&&Object.keys(r).length))return s;for(const n of e){const e=t[n.id];s[n.id]=e?r[e[0].labelId]:null;}return s}}const _e=`${Un$1}/users/source-transforms`,Te={async getTransformsForUser(){try{return (await se(_e)).body}catch(e){throw r.error("Error getting transforms for user",e),e}},async save(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{return (await se(_e,t)).body}catch(e){throw r.error("Error saving transform",e),e}},async delete(e){if(!e.length)return 0;const t={method:"POST",body:JSON.stringify(e)};try{return (await se(`${_e}/delete`,t)).response.json()}catch(e){throw r.error("Error deleting transform",e),e}}};class Ue{static async setTransforms(){const e=await Te.getTransformsForUser();if(!e)return void r.error("Transforms could not be updated");const t=o.groupBy(e,(e=>e.sourceId));await Qn("sourceTransforms",t);}static async getTransformForSourceId(e,t){const r=await Xn("sourceTransforms");if(!r)return [];if(t){const s=h[t];return r[e].filter((e=>s.includes(e.type)))}return r[e]}static async getTransforms(){return Xn("sourceTransforms")}static getTransformStoreForSources(e,t={}){let r,s={};return e&&(r=o.map(e,(e=>e.id))),t&&r&&(s=o.pick(t,r)),s}static async saveTransform(e){const t=await Te.save(e);t||r.error("Transform could not be updated");const r$1=await Xn("sourceTransforms")||{};t.forEach((async e=>{void 0===r$1[e.sourceId]&&(r$1[e.sourceId]=[]),r$1[e.sourceId].push(e),await Qn("sourceTransforms",r$1);}));}static async deleteTransforms(e){const t=e.map((e=>e.id));if(!await Te.delete(t))return void r.error("Transform could not be deleted");const r$1=await Xn("sourceTransforms");r$1&&(e.forEach((e=>{if(r$1[e.sourceId]){const t=o.filter(r$1[e.sourceId],(t=>e.id!==t.id));r$1[e.sourceId]=t;}})),await Qn("sourceTransforms",r$1));}}const Oe={expansion:[]};let Ae;const ke=new Promise((e=>{Ae=e;}));class Ce{static init(){re("appConfig").subscribe((e=>{if(e?.unsupportedSitePatterns){for(const[t,r]of Object.entries(e.unsupportedSitePatterns))Oe[t]=r.map((e=>new RegExp(e,"i")));Ae(!0);}}));}static async getUnsupportedFeaturesForSite(e){return await ke,[...Object.entries(Oe)].flatMap((([t,r])=>r.some((t=>t.test(e)))?[t]:[]))}}const Ne={},Pe=new de;function Re(){return Object.values(Ne).map((({srcPage:e})=>({...e,title:e.title||e.srcUrl})))}function xe(e,t){const r=e.id,s=Ne[r];if(t.some((e=>e.url)))return e.url?.startsWith("chrome://")&&s?void Me(e):void(s?Fe(e):Me(e));t.some((e=>e.title))&&qe(r,{srcPage:{tabId:r,title:e.title}});}function Me(e){if(!je(e))return null;const t=e.id,r=e.url,s=Wn();return s.srcPage.tabId=t,s.srcPage.srcUrl=r,s.srcPage.lastVisitedAt=(new Date).toISOString(),Ne[t]=s,qe(t,s),Fe(e),s}async function Fe(e){if(!e.id||!e.url)return;const[t,r,s,n,i,o,a,c]=await Promise.all([pt.getUser(),Dt.getPrivateSources(),Dt.getPublicSources(),Dt.getDisabledSourceIds(),Ue.getTransforms(),Ee.getUserSourceLabels(),Ee.getDefaultSourceLabels(),ze.getMappingsForSinkUrl(Kt$1(e.url))]),l=new URL(e.url),{featureFlags:u}=t,[p,d]=await Promise.all([Dt.getForURL({url:l,privateSources:r,publicSources:s,disabledSourceIds:n,featureFlags:u}),Dt.getForURL({url:l,privateSources:r,publicSources:s,disabledSourceIds:n,featureFlags:u,opts:{getDisabled:!0}})]),h={srcPage:{tabId:e.id,title:e.title??"",srcUrl:e.url},destMappings:c,cachedSourcesForUrl:{srcSelectors:p,transforms:Ue.getTransformStoreForSources(p,i),sourceLabelStore:Ee.getUserSourceLabelsForSources(p,o,a),disabledSrcSelectors:d},unsupportedFeatures:await Ce.getUnsupportedFeaturesForSite(e.url)};qe(e.id,h);}async function De(e,t){const{variablesOnClosedTabsEnabled:s}=e;if(!s)return;const[n,i]=await Promise.all([Xn("lastSrcPageForBaseUrl"),zt.getAppConfig()]),o=n??{},a$1=(new Date).toISOString();for(const e of t){if(0===e.srcMatches.length)continue;const{srcSelector:t}=e.srcMatches[0],{baseUrl:s}=t;o[s]={srcPage:{...e,tabId:a.browser.tabs.TAB_ID_NONE},closedAt:a$1};}const u=Object.values(o);if(u.length>i.closedTabsLimit){delete o[u.reduce(((e,t)=>new Date(e.closedAt).getTime()<new Date(t.closedAt).getTime()?e:t)).srcPage.srcMatches[0].srcSelector.baseUrl];}Qn("lastSrcPageForBaseUrl",o),Kt(e,Object.values(o).map((({srcPage:e})=>e)));}async function Ve(e,t,r){for(const s of t){const t=s.srcMatches.map((e=>e.srcSelector))[0];if(!t)continue;const{baseUrl:n}=t;r[n]&&(delete r[n],Qn("lastSrcPageForBaseUrl",r),Kt(e,Object.values(r).map((({srcPage:e})=>e))));}}function je(e){return !(!e.id||!e.url)&&e.id!==a.browser.tabs.TAB_ID_NONE}async function Le(e,t){try{r.debug("[tab:",e,"] background-store.notifyTab, request: ",t),await a.browser.tabs.sendMessage(e,t);}catch(e){!(performance.now()>1e3)&&e instanceof Error&&"Could not establish connection. Receiving end does not exist."===e.message||r.error(e);}}function Be(e){const t=Ne[e];return void 0===t?null:t}function qe(e,t){if(!Ne[e])return void r.trace("Update tab state attempted for missing tab with id",e);const r$1=Ne[e],n=function(e,t){const r=o.cloneDeep(t),s=r.panel?.previousViews||e.panel.previousViews;return r.panel?.activeView&&r.panel.activeView!==s[s.length-1]&&e.panel.activeView!==r.panel.activeView&&(r.panel.previousViews=[...s,r.panel.activeView]),r}(r$1,t);o.mergeWith(r$1,n,Qt$1),Le(e,{action:"tabStateChanged",tabStatePartial:n});}async function $e(e){const{variablesEnabled:t,variablesOnClosedTabsEnabled:r}=e;if(!t)return;const s=Object.values(Ne).map((e=>e.srcPage));if(r){Ve(e,s,await Xn("lastSrcPageForBaseUrl")||{});}Gt({srcPagesForOpenTabs:s});}Pe.method("getInitialTabState",(async({tabId:e})=>{let t=Be(e);if(!t){const s=await a.browser.tabs.get(e);t=Be(e)||Me(s);}if(!t)throw Error("getInitialTabState: tab state isn't populated yet");return t})),Pe.method("updateTabState",(async({tabId:e},t)=>{qe(e,t);})),a.browser.tabs.onActivated.addListener((e=>{const{tabId:t}=e;Ne[t]&&(Ne[t].srcPage.lastVisitedAt=(new Date).toISOString());})),a.browser.tabs.onCreated.addListener((e=>{je(e)&&Me(e);})),pt$1((e=>a.browser.tabs.onUpdated.addListener(e))).pipe(ht$1((([,e])=>void 0!==e.url||void 0!==e.title)),gt$1(500),ht$1((e=>e.length>0))).subscribe((e=>{const t=o.groupBy(e,(([e])=>e));for(const e of Object.values(t)){const[,,t]=e[e.length-1];xe(t,e.map((([,e])=>e)));}})),a.browser.tabs.onRemoved.addListener((e=>{!async function(e){const{featureFlags:t}=await pt.getUser(),r=Ne[e];if(!r)return;if(r.srcPage.srcMatches.length){const{srcPage:e}=r;De(t,[e]);}delete Ne[e],$e(t);}(e);}));const Ge=`${Un$1}/stitches`,Ke={async getStitchesForUser(){try{return (await se(Ge)).body}catch(e){throw r.error("Error geting stitches",e),e}},async save(e){const t={method:"POST",body:JSON.stringify(e)};try{return (await se(Ge,t)).response.json()}catch(e){throw r.error("Error saving stitches",e),e}},async delete(e){const{id:t}=e,r$1={method:"DELETE"};try{return (await se(`${Ge}/${t}`,r$1)).response.json()}catch(e){throw r.error("Error deleting stitches",e),e}}};class ze{static init(){re("mappingsStore").subscribe((async()=>{(await a.browser.tabs.query({})).forEach((async e=>{void 0!==e.id&&e.url&&Be(e.id)&&qe(e.id,{destMappings:await ze.getMappingsForSinkUrl(Kt$1(e.url))});}));}));}static async setMappings(){const e=await Ke.getStitchesForUser();if(!e)return void r.error("Stitch could not be updated");const t={},r$1=await qt(e.map((e=>e.sourceId)));for(const s of e){const e=We(s,r$1);if(!e)continue;const{sinkFullUrl:n}=s.sinkData;void 0===t[n]&&(t[n]=[]),t[n].push({...s,srcUrl:e.baseUrl});}await Qn("mappingsStore",t);}static async getMappingsForSinkUrl(e){const t=await Xn("mappingsStore");if(!t)return [];const r=t[e];if(!r)return [];const s=await qt(r.map((e=>e.sourceId)));return r.flatMap((e=>{const t=We(e,s);return t?[{...e,srcSelector:t}]:[]}))}static async getAllSinkURIs(){const e=await Xn("mappingsStore");return e?Object.keys(e):[]}static async saveMapping(e){const{featureFlags:{mappingsEnabled:t}}=await pt.getUser();if(!t)return;const r$1={id:e.id,sinkFullUrl:e.sinkFullUrl,sinkData:e.sinkData,sourceId:e.sourceId},n=await Ke.save(r$1);n&&0!==n.length||r.error("Stitch could not be updated");const i=await Xn("mappingsStore")||{};void 0===i[e.sinkFullUrl]&&(i[e.sinkFullUrl]=[]),i[e.sinkFullUrl].push(e),await Qn("mappingsStore",i);}static async deleteMapping(e){if(!await Ke.delete(e))return void r.error("Mapping could not be deleted");const t=await Xn("mappingsStore");if(t&&t[e.sinkFullUrl]){const r=o.filter(t[e.sinkFullUrl],(t=>e.id!==t.id));t[e.sinkFullUrl]=r,await Qn("mappingsStore",t);}}}function We(e,t){const r=t.find((t=>t.id===e.sourceId));return r&&"placeholder"!==r.type?r:null}const He=`${Un$1}/users`,Je=`${Un$1}/sessions`,Xe={async getInfoForUser(){try{const e=(await se(`${He}/info`)).body;return Tt(e),e}catch(e){throw r.error("Error geting user info",e),e}},async updateInfoForUser(e){const t={method:"POST",body:JSON.stringify(e)};try{await se(He,t);}catch(e){throw r.error("Error updating user info:",e),e}await pt.updateFromServer();},async logOut(){const e={method:"POST"};try{await se(`${Je}/logout`,e);}catch(e){throw r.error("Error logging user out:",e),e}},async getUserReferrals(){const e={method:"GET"};try{return (await se(`${He}/referredUsers`,e)).body}catch(e){throw r.error("Error getting referral count:",e),e}},async sendRateAppReminder(){const e={method:"POST",body:null};try{await se(`${He}/sendRateAppReminder`,e);}catch(e){throw r.error("Error sending rate app reminder:",e),e}}},Ye=new de;async function Qe(e,t){const{active:s,shouldRefresh:n=!0}=t,i=new URL(e),o=i.searchParams;i.search="";const[a$1]=await a.browser.tabs.query({url:`${i.href}*`});if(a$1){if(s){const{windowId:t}=a$1;t&&await a.browser.windows.update(t,{focused:!0}),await a.browser.tabs.update(a$1.id,{active:!0,url:n||o.values.length>0?e:void 0});}}else await a.browser.tabs.create({url:e,active:s});}Ye.method("openTab",(async(e,t,r=!1)=>Qe(t,{active:r}))),Ye.method("closeTab",(async({tabId:e})=>a.browser.tabs.remove(e))),Ye.method("dispatchWindowEvent",(async({tabId:e},{eventName:t,detail:r})=>Le(e,{action:"dispatchWindowEvent",eventName:t,detail:r})));const Ze=a.browser.extension.getURL("options.html"),et=new de;async function tt(e,t){const r=new URL(e);if(t)for(const[e,s]of Object.entries(t))r.searchParams.set(e,s);return r.toString()}async function rt(e,t){const[s]=await a.browser.tabs.query({url:`${Ze}*`}),n=await tt(Ze,t?.params);if(s&&e!==s.id)await Qe(n,{active:!0,shouldRefresh:t?.shouldRefresh}),await a.browser.tabs.remove(e);else {if(await a.browser.tabs.update(e,{active:!0,url:n}),!s)return;const{windowId:t}=s;t&&await a.browser.windows.update(t,{focused:!0});}}async function st(e={shouldRefresh:!0}){const{shouldRefresh:t,params:r}=e,s=await tt(Ze,r);await Qe(s,{active:!0,shouldRefresh:t});}et.method("delete",(async(e,t)=>{await er.deleteSnippets(t);})),et.method("import",(async(e,t,r)=>{await er.deleteSnippets(r),await er.saveSnippets(t),Qn("defaultSnippets",{});})),et.method("openOrFocusOptionsTab",(async(e,t)=>{st({shouldRefresh:t?.shouldRefresh||!1,params:t?.params});})),et.method("redirectOrFocusTabToOptionsPage",(async({tabId:e})=>{await rt(e);})),et.method("redirectOptionsAndSetReshareCollection",(async({tabId:e},t)=>{await rt(e,{shouldRefresh:!1}),await Qn("reshareCollectionId",t);})),et.method("openOptionsAndOpenDialog",(async({tabId:e},t)=>{const{redirect:r,params:s,source:n}=t;r?await rt(e,{shouldRefresh:!1,params:s}):await st({shouldRefresh:!1,params:s}),mt({type:"options.deeplink",params:s,source:n||""});}));const nt=new de;async function it(e){const{onboarding:t,featureFlags:{fabPanelEnabled:r}}=await pt.getUser();if(r&&at(e.url)){const r=await Xn("notifications");t?.panelIntroductionStarted||r?.panelIntroductionStarted?await async function(e){const{id:t,url:r}=e;if(!t||!r)return;if(!at(r))return;qe(t,{panel:{hasOpenedViaBrowserAction:!0,isOpen:!0}});}(e):ot();}else st();}async function ot(){const[e]=await a.browser.tabs.query({active:!0,currentWindow:!0});e&&e.id&&(at(e.url)?qe(e.id,{panel:{isOpen:!0,activeView:"default",panelIntroductionOpen:kn.MEET_MAGICAL,hasOpenedViaBrowserAction:!0}}):Qe(Ze,{active:!0}));}function at(e){return !(!e||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))}nt.method("hideFab",(async({tabId:e})=>{qe(e,{panel:{hasOpenedViaBrowserAction:!1}});})),nt.method("togglePanelOpen",(async({tabId:e,url:t},r)=>{qe(e,{panel:{isOpen:r}});})),nt.method("openNewTabInEditVariablesMode",(async(e,t)=>{const s=await a.browser.tabs.create({url:t,active:!0});setTimeout((()=>{s.id&&(qe(s.id,{panel:{hasOpenedViaBrowserAction:!0,activeView:"variables",isOpen:!0}}),Bt(s.id,s.url));}),1e3);}));async function ct(){try{await a.browser.contextMenus.remove("CONTEXT_MENU_VARIABLE_CREATE");}catch(e){}(await pt.getUser())?.featureFlags.variablesEnabled&&a.browser.contextMenus.create({id:"CONTEXT_MENU_VARIABLE_CREATE",title:"Create variable",contexts:["selection","page","editable","link"]});}async function lt(){try{await ut();}catch(e){r.error(e);}await yt(),ct();}async function ut(){const e=[],{featureFlags:{variablesEnabled:t,placeholderVariablesEnabled:r,mappingsEnabled:s}}=await pt.updateFromServer();t||r?e.push(Dt.updateAllSourcesFromAPI(),Ue.setTransforms(),Ee.updateLabelsFromAPI(),Ee.updateDefaultSourceLabelsFromAPI(),Ee.updateUserSourceLabelsFromAPI()):(Qn("sourcesV1",{}),Qn("publicSourcesV1",{}),Qn("disabledSourceIds",[]),Qn("sourceTransforms",{})),t&&s?e.push(ze.setMappings()):Qn("mappingsStore",{}),e.push(er.syncSnippets(),pt.syncUserReferrals()),await Promise.allSettled(e);}a.browser.contextMenus.onClicked.addListener((async(e,t)=>{if(t&&t.id)if("CONTEXT_MENU_SHORTCUT_CREATE"===e.menuItemId){let r="";e.selectionText&&(r=e.selectionText);if((await pt.getUser())?.featureFlags.fabPanelEnabled&&t.id&&at(t.url)){const e={...Bn(),body:r,id:pe()};await async function(e,t){qe(e,{panel:{activeView:"snippetEdit",hasOpenedViaBrowserAction:!0,isOpen:!0,views:{snippetEdit:{snippet:t||Bn()}}}});}(t.id,e);}else await Qn("prefillNewShortcut",{body:r}),st({shouldRefresh:!1});}else "CONTEXT_MENU_VARIABLE_CREATE"===e.menuItemId&&(at(t.url)?await Bt(t.id,t.url):st({shouldRefresh:!1}));}));class pt{static async init(){dt.start(),re("userInfo").subscribe((async()=>{Gt({userInfo:await this.getUser()});})),re("showVariableHelp").subscribe((e=>{Gt({showVariableHelp:e});})),re("referrals").subscribe((e=>{Gt({referrals:e});}));}static async syncUserReferrals(){const e=await Xe.getUserReferrals();await Qn("referrals",e);}static async updateFromServer(){const e=await Xe.getInfoForUser();return await Qn("userInfo",e),await Kn("ateUserId",e.id),e}static async getUser(){const e=await Xn("userInfo");return e?(e.settings=o.merge({},zn().settings,e.settings),e):zn()}static async isLoggedIn(){const{email:e}=await pt.getUser();return null!==e&&""!==e}static async setUserChecklist(e){if(!e)return;const t=await pt.getUser(),r=new Set(Object.keys(e||{})),s=[...new Set(Object.keys(t.onboarding?.checklist||{}))];new Set(s.filter((e=>r.has(e)))).size||await Xe.updateInfoForUser({onboarding:{checklist:e}});}static async showPopularSitePanelForUser(e,t){const r=Be(e);if(r&&0===r.srcPage.srcMatches.length)return;const{popularSites:s}=await zt.getAppConfig(),n=s.find((e=>t.startsWith(e)));if(!n)return;const i=await pt.getUser(),o=i.onboarding?.popularSitesHelpCardShown??[];if(o.includes(n))return;o.push(n),qe(e,{panel:{isOpen:!0,hasOpenedViaBrowserAction:!0,views:{default:{selected:"Variables"}}}});const a=await Xn("notifications")??{};a.popularSitesHelpCardToShow||(a.popularSitesHelpCardToShow=[]),a.popularSitesHelpCardToShow.push(n),await Qn("notifications",a),await Xe.updateInfoForUser({onboarding:{...i.onboarding,popularSitesHelpCardShown:o}});}static async setUserChecklistCompleteDate(e){const t=await pt.getUser();t.onboarding?.checklistCompleteDate||await Xe.updateInfoForUser({onboarding:{checklistCompleteDate:e,...t.onboarding}});}static async setAddVariableShortcutSelected(e){const t=await pt.getUser();t.onboarding?.addVariableShortcutSelected||await Xe.updateInfoForUser({onboarding:{...t.onboarding,addVariableShortcutSelected:e}});}static async toggleItemInChecklist(e,t,r){return e.includes(t)?r?e:o.without(e,t):[...e,t]}static async updateUserOnboarding(e){await Xe.updateInfoForUser({onboarding:e});}static async updateUserSettings(e){await Xe.updateInfoForUser({settings:e});}}const dt=new de;dt.method("toggleChecklistItem",(async({tabId:e},t)=>{const{optionName:r,keepOpenIfOpen:s}=t,n=Be(e),{expandedItems:i}=n.panel.views.checklist;qe(e,{panel:{views:{checklist:{expandedItems:await pt.toggleItemInChecklist(i,r,s)}}}});})),dt.method("setUserSignupDetails",(async(e,t)=>{await Xe.updateInfoForUser(t);})),dt.method("updateUserOnboarding",(async(e,t)=>{await pt.updateUserOnboarding(t);})),dt.method("updateUserSettings",(async(e,t)=>{await pt.updateUserSettings(t);})),dt.method("setUserChecklist",(async(e,t)=>{await pt.setUserChecklist(t);})),dt.method("fetchUserAndDataFromServer",(()=>lt())),dt.method("setUserChecklistCompleteDate",(async(e,t)=>{await pt.setUserChecklistCompleteDate(t);})),dt.method("setAddVariableShortcutSelected",(async(e,t)=>{await pt.setAddVariableShortcutSelected(t);})),dt.method("logOut",(async e=>{await Xe.logOut(),await te("authCookieBackup");})),dt.method("sendRateAppReminder",(async e=>{await Xe.sendRateAppReminder();})),dt.method("closePopularSiteHelpPanel",(async(e,t)=>{const r=await Xn("notifications")??{};if(!r||!r.popularSitesHelpCardToShow)return;const s=r.popularSitesHelpCardToShow.filter((e=>e!==t));await Qn("notifications",{...r,popularSitesHelpCardToShow:s});})),dt.method("closeAutosuggestShortcutPrompt",(async e=>{g({autosuggestShortcutContent:""});})),dt.method("closeAutosuggestVariablePrompt",(async e=>{g({autosuggestVariableContent:!1});})),dt.method("openUserSupport",(async(e,t)=>{a.browser.windows.create({url:t,type:"popup",height:800,width:600});}));const ft=new de;function ht(){return `amp_${Pn.substr(0,6)}`}const gt=async function(){const e={platform:"Chrome Extension"},t=ht();if(!document.cookie.includes(`${t}=`)){const r$1=await Ft$1({name:t,domain:"getmagical.com"});for(const t of r$1){const[r$1]=t.split(".");if(r$1){e.deviceId=r$1,r.info("Setting deviceId to",r$1);break}}}const n=be.getInstance();await new Promise((t=>{n.init(Pn,void 0,e,t);}));const{version:i}=a.browser.runtime.getManifest();return n.setVersionName(i),n}();async function mt(e,t,r$1){const n=o(e).omit("type").value();void 0!==t&&(n.originUrl=t.href,n.originHostname=t.hostname),r.debug("Sending tracking event:",e),r$1?.eventTimeStamp?(await gt).logEventWithTimestamp(e.type,n,r$1.eventTimeStamp):(await gt).logEvent(e.type,n);}async function yt(){const e=await pt.getUser(),t=await gt;t.setUserProperties({user:e});const s=await Gn("scto");s&&t.setUserProperties({ateShortcutTimeout:s});const i=Object.values(await er.getSnippets()),o=Object.values(await Xn("snippetCollections")||{}),a$1=o$1(o),c=await er.getTeamSnippets(),u=Object.entries(c).map((([e,t])=>({teamId:e,count:t.length}))),p=a$1.flatMap((e=>e.snippetIds)).reduce(((e,t)=>(e[t]=e[t]+1||1,e)),{}),d=i.map((t=>({snippetId:t.id,baseUrl:t.srcBaseUrls?t.srcBaseUrls[0]:null,variables:t.srcSelectors.map((t=>({srcId:t.id,creator:"00000000-0000-4000-0000-000000000000"===t.creatorUserId?"magical":t.creatorUserId===e.id?"user":"otherUser"})))||null})));let f;t.setUserProperties({"shortcuts.count":i.length,"shortcuts.tagged.counts":Object.values(p),"shortcuts.team.counts":u,"shortcuts.variables":d,"tags.count":a$1.length}),t.options.userId?f=t.options.userId:e?.email&&(f=e.id,f!==t.options.userId&&t.setUserId(f));const h=t.options.deviceId;return await async function(e){const{trackingDeviceId:t,userId:s}=e,i=`${Un$1}/sessions/uninstall`,o={trackingDeviceId:t,userId:s,event:{type:"ate_uninstalled"}},a$1={a:btoa(JSON.stringify(o))},c=Zt$1(i,a$1);await a.browser.runtime.setUninstallURL(c);}({trackingDeviceId:h,userId:e.id}),{trackingDeviceId:h,trackingUserId:f}}ft.method("track",(async({tabId:e},t)=>{let s;if(e){const t=(await a.browser.tabs.get(e)).url;t&&(s=new URL(t));}mt(t,s);})),ft.method("setUserProperties",(async(e,t)=>{(await gt).setUserProperties(t);}));const wt=new Map,vt=new Map;function bt(e,t){let r=e;return "cell"===t.type&&(r+=`:cell_row_${t.row}`),r}async function St(){const e=await Xn("latestFill");if(!e)return {timeSaved:0,unit:"sec",message:"",emoji:""};let t=8*(e.variablesFilled||0)+.3*(e.snippetCharsSaved||0);const r=(await zt.getAppConfig()).savedTimeMessages.find((e=>e.secondsSaved<t)),s=r?.message||"",n=r?.emoji||"";let i;return t>=3600?(t=Math.floor(t/3600*4)/4,i="hr"):t>=60?(t=Math.floor(t/60),i="min"):(t=Math.round(10*t)/10,i="sec"),{timeSaved:t,unit:i,message:s,emoji:n}}async function It(){const e=(await Xn("unsentSnippetExpansionEvents")||[]).reduce(((e,t)=>{const r=`${t.originHostname}-${t.isSpecial}`;if(!e[r]){const s=t.destSelectors||[],n=t.destSelectorTypes||[],i=t.snippetIds||[],{originHostname:o,isSpecial:a,originUrl:c,eventStartAt:l,eventEndAt:u,type:p}=t;e[r]={charCount:0,count:0,destSelectorTypes:n,destSelectors:s,eventEndAt:u,eventStartAt:l,isSpecial:a,numPrivatePlaceholders:[],numPublicPlaceholders:[],numSiteVariables:[],numTotalPlaceholders:0,originHostname:o,originUrl:c,snippetIds:i,type:p};}return t.destSelectors&&t.destSelectors[0]&&!e[r].destSelectors.includes(t.destSelectors[0])&&e[r].destSelectors.push(t.destSelectors[0]),t.destSelectorTypes&&t.destSelectorTypes[0]&&!e[r].destSelectorTypes.includes(t.destSelectorTypes[0])&&e[r].destSelectorTypes.push(t.destSelectorTypes[0]),t.snippetIds&&t.snippetIds[0]&&!e[r].snippetIds.includes(t.snippetIds[0])&&e[r].snippetIds.push(t.snippetIds[0]),t.numSiteVariables&&t.numSiteVariables[0]&&e[r].numSiteVariables.push(t.numSiteVariables[0]),t.numPublicPlaceholders&&t.numPublicPlaceholders[0]&&e[r].numPublicPlaceholders.push(t.numPublicPlaceholders[0]),t.numPrivatePlaceholders&&t.numPrivatePlaceholders[0]&&e[r].numPrivatePlaceholders.push(t.numPrivatePlaceholders[0]),e[r].count+=t.count,e[r].charCount+=t.charCount,e[r].numTotalPlaceholders+=t.numTotalPlaceholders,e[r].eventStartAt=Math.min(e[r].eventStartAt,t.eventStartAt),e[r].eventEndAt=Math.max(e[r].eventEndAt,t.eventEndAt),e}),{}),t=Object.values(e);for(const e of t)mt({...e,eventStartAt:new Date(e.eventStartAt).toISOString(),eventEndAt:new Date(e.eventEndAt).toISOString()},void 0,{eventTimeStamp:e.eventEndAt});await Qn("unsentSnippetExpansionEvents",[]);}ft.onTabConnect((e=>{wt.set(e,new Map),vt.set(e,new Map);})),ft.onTabDisconnect((e=>{wt.delete(e),vt.delete(e);})),ft.method("storeLatestFill",(async({tabId:e,url:t},s,n,i,o)=>{const a$1=a.browser.runtime.getURL("");if(t.href.startsWith(a$1))return;const u=await Xn("latestFill")||{};if(u.latestFillFlow&&u.latestFillFlow.id===s.id)return;let p=i,d=o;u.variablesFilled&&(p+=u.variablesFilled),u.snippetCharsSaved&&(d+=u.snippetCharsSaved);const f={totalFills:(u.totalFills||0)+n,latestFillFlow:s,tabId:e,variablesFilled:p,snippetCharsSaved:d};await Qn("latestFill",f);})),ft.method("fillCompleted",(async({tabId:e},t,r,s)=>{if(!s)return;const n=bt(s.id,r);wt.get(e).set(n,t);})),ft.method("userModifiedFill",(async({tabId:e},t,r$1,n)=>{if(!r$1)return;const i=wt.get(e),o=bt(r$1.id,t),a=i?.get(o);if(!a||Date.now()-a.filledAt>18e4||a.filledValue===n)return;const{fillType:c,id:l}=a;let u;switch(c){case"standard":u="autofill.changed-standard";break;case"magic":case"magic-fill-all":u="autofill.changed-magic-fill";break;case"snippet":return;default:return void r.info("unsupported fill modification type:",c)}const p=vt.get(e);let d=p?.get(l)||0;p?.set(l,++d);const f=await qt([r$1.sourceId]);mt({type:u,fillType:c,fillFlowId:l,fillModificationCount:d,srcUrl:r$1.srcUrl,srcSelector:f[0]??null,stitchId:r$1.id,destSelector:t}),i?.delete(o);})),ft.method("storeSnippetExpansionEvent",(async({url:e},{snippetId:t,snippetType:r,destSelectorType:s,destSelector:n,charCount:i,numPrivatePlaceholders:o,numPublicPlaceholders:a,numSiteVariables:u,numTotalPlaceholders:p})=>{const d=await Xn("unsentSnippetExpansionEvents")||[],f=Date.now();d.push({charCount:i,count:1,destSelectorTypes:[s],destSelectors:[n],eventEndAt:f,eventStartAt:f,isSpecial:r,numPrivatePlaceholders:[o],numPublicPlaceholders:[a],numSiteVariables:[u],numTotalPlaceholders:p,originHostname:e.hostname,originUrl:e.href,snippetIds:[t],type:"ate_snippetUsed"}),await Qn("unsentSnippetExpansionEvents",d);}));const Et=new Map,_t=new Map;function Tt(e){Et.clear();for(const t of e.oAuthAccounts)"google"===t.provider&&Et.set(t.providerUsername,t);}async function Ut(e){const t=(await se(`${Un$1}/users/oauth/${e}`)).body;return t.accessTokenExpiresAt=new Date(t.accessTokenExpiresAt),t.updatedAt=new Date(t.updatedAt),t}async function Ot(e,t){let r$1=Et.get(t);if(r$1?.accessToken&&(r$1?.accessTokenExpiresAt||new Date(0))>new Date){return Et.get(t)}let i=null;async function o(){await async function(e){const t=new URL(`${Un$1}/users/oauth/google/associate`);e&&t.searchParams.append("login_hint",e),r.info("openGoogleAuthorizationWindow",e);const r$1=window.open(t.toString(),`magical-auth-${e}`,"width=500,height=600,resizable=yes,location=yes,scrollbars=yes,toolbar=yes,menubar=yes");return r$1?.focus(),mt({type:"google.initiate-permission-flow"}),new Promise(((e,t)=>{window?.addEventListener("message",(t=>{t.origin===new URL(Un$1).origin&&t.source===r$1?.window&&"success"===t.data&&(mt({type:"google.permission-granted"}),e(),r$1?.close());}));const s=setInterval((()=>{r$1?.closed&&(clearInterval(s),t(new Error("openGoogleAuthorizationWindow: User closed the window")));}),200);}))}(t),await pt.updateFromServer(),r$1=Et.get(t);const e=r$1?.id;if(!e)throw new Error("getAccessToken: OAuth account not found after authorization");return Ut(e)}if("google"===r$1?.provider&&r$1?.id){const t=r$1.id;try{i=await Ut(t);}catch(e){r.error(e);}if(!i){if(!e)throw new Error("Existing access token cannot be refreshed");i=await o();}}else {if(!e)throw new Error("Cannot authorize a new account when interactive is false");i=await o();}if(Et.set(i.providerUsername,i),i?.accessToken&&(i?.accessTokenExpiresAt||new Date(0))>new Date)return i;throw new Error("getAccessToken: Could not acquire one")}async function At(e,t,r$1={}){const n=await Ot(!1,e),i=o.merge({},r$1,{headers:{Authorization:`Bearer ${n.accessToken}`}});return r.info(`[Google API request as ${e}] url ${t}, with options`,r$1),ae.fetchJSON(t,i)}async function kt(e,t){const r$1=Et.get(t);r$1&&r$1.accessToken&&delete r$1.accessToken;try{await Ot(e,t);}catch(e){r.error(e);}}const Ct=e=>401===e.response?.status;async function Nt(e,t,r,s={}){return function(e,t){const r=_t.get(t);if(r)return r;const s=ae.configureRefreshFetch({fetch:At.bind(null,t),shouldRefreshToken:Ct,refreshToken:kt.bind(null,e,t)});return _t.set(t,s),s}(e,t)(r,s)}const Pt=new de;async function Rt(e){const{sinkFullUri:t,valuesToAutofill:r$1,fillFirstWithInsert:n}=e;let{googleEmail:i}=e;if(0===r$1.length){const e={success:!1,status:404,errorMessage:"No values to fill"};return r.error(e),e}if(!i){const e=await Xn("googleSheetURIToUser")||{},r$1=e[t];if(!e||!r$1){const e={success:!1,status:404,errorMessage:`Email missing for sinkFullUri: ${t}`};return r.error(e),e}i=r$1;}const{sheetId:o,spreadsheetId:a}=s$1(t);if(!a||!o){const e={success:!1,status:404,errorMessage:`Unable to get spreadsheet and sheet id from ${t}`};return r.error(e),e}const c=function(e,t,r){const s=[],n=t[0].destSelector,i=t[t.length-1].destSelector;let o=n.row;r&&o--;const a=i.row;a-o>0&&s.push({insertDimension:{range:{sheetId:e,dimension:"ROWS",startIndex:o,endIndex:a},inheritFromBefore:o>0}});return t.forEach((({destSelector:t,value:r,srcMatch:n})=>{"cell"===t.type&&s.push({pasteData:{coordinate:{sheetId:e,rowIndex:t.row-1,columnIndex:xt(t.col)},data:n?.richTextValue||r,type:"PASTE_NORMAL",html:!0}});})),{requests:s}}(o,r$1,n),u=`https://sheets.googleapis.com/v4/spreadsheets/${a}:batchUpdate`;try{const e=await Nt(!0,i,u,{method:"POST",body:JSON.stringify(c)});return {success:200===e.response.status,status:e.response.status}}catch(e){const t={success:!1,status:e.status,errorMessage:e.body.error.message};return r.error(t),Re$1(e),t}}function xt(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let r,s,n=0;for(r=0,s=e.length-1;r<e.length;r+=1,s-=1)n+=t.length**s*(t.indexOf(e[r])+1);return n-1}Pt.method("magicGoogleSheetAutofill",(async(e,t)=>Rt(t))),Pt.method("getGoogleSheetData",(async(e,{sinkFullURIs:t,includeGridData:r$1,interactive:n})=>Promise.all(t.map((async e=>async function(e,t,r$1){const n=(await Xn("googleSheetURIToUser")||{})[e];if(!n){const t={success:!1,status:404,errorMessage:`Email missing for this ${e}`};return r.error(t),t}const{spreadsheetId:i,sheetId:o}=s$1(e);if(!i||!o){const t={success:!1,status:404,errorMessage:`Unable to get spreadsheet and sheet id from ${e}`};return r.error(t),t}if(!t){const e=await Xn("googleSpreadsheetCache")||{};if(e[i]?.sheets.find((e=>e.properties.sheetId.toString()===o)))return {success:!0,status:0,body:e[i]}}return async function(e,t,r$1,n,i){let o=`https://sheets.googleapis.com/v4/spreadsheets/${e}:getByDataFilter`;const a={dataFilters:[{gridRange:{sheetId:t}}],includeGridData:r$1};r$1||(o=`https://sheets.googleapis.com/v4/spreadsheets/${e}`);try{const e=await Nt(n,i,o,{method:r$1?"POST":"GET",body:r$1?JSON.stringify(a):void 0});return async function(e){const t=await Xn("googleSpreadsheetCache")||{};let r=[];const s=t[e.spreadsheetId];s&&(r=s.sheets);for(const t of e.sheets){const e=r.find((e=>t.properties.sheetId===e.properties.sheetId)),s={sheetId:t.properties.sheetId,title:t.properties.title,index:t.properties.index,sheetType:t.properties.sheetType,hidden:t.properties.hidden};e?e.properties=s:r.push({properties:s});}t[e.spreadsheetId]={spreadsheetId:e.spreadsheetId,properties:{title:e.properties.title,locale:e.properties.locale},sheets:r},await Qn("googleSpreadsheetCache",t);}(e.body),{success:200===e.response.status,status:e.response.status,body:e.body}}catch(e){const t={success:!1,status:e.status,errorMessage:e.body.error.message};return r.error(t),Re$1(e),t}}(i,o,t,r$1,n)}(e,r$1,n)))))),Pt.method("storeGoogleEmailForURI",(async(e,t,r)=>{const s=await Xn("googleSheetURIToUser")||{};s[r]=t,await Qn("googleSheetURIToUser",s);})),Pt.method("ensureUnexpiredToken",(async(e,t,r)=>{try{return await Ot(t,r),"valid"}catch(e){if(e instanceof Error&&"Cannot authorize a new account when interactive is false"===e.message)return "missing-user"}return "expired"})),Pt.method("storeGoogleEmailForSpreadsheetId",(async(e,t,r)=>{const s=(await ze.getAllSinkURIs()).filter((e=>a$1(e)&&s$1(e).spreadsheetId===r)),n=await Xn("googleSheetURIToUser")||{};for(const e of s)void 0===n[e]&&(n[e]=t);await Qn("googleSheetURIToUser",n);}));const Mt=`${Un$1}/sources`;async function Ft(){return function(e){const t=o.filter(e.sources,(e=>e.public)),r=o.filter(e.sources,(e=>!e.public));return {public:o.keyBy(t,"id"),private:o.keyBy(r,"id"),disabledSourceIds:e.disabledSourceIds}}((await se(Mt)).body)}class Dt{static init(){Vt.start(),t(re("sourcesV1").pipe(Mt$1(!0)),re("publicSourcesV1").pipe(Mt$1(!0)),re("disabledSourceIds").pipe(Mt$1(!0)),re("sourceTransforms").pipe(Mt$1(!0)),re("labelStore").pipe(Mt$1(!0)),re("userSourceLabelStore").pipe(Mt$1(!0)),re("defaultSourceLabelStore").pipe(Mt$1(!0))).pipe(u(400,void 0,{leading:!1,trailing:!0})).subscribe((async()=>{const[e,t,s,n,i,o,a$1,c,u]=await Promise.all([a.browser.tabs.query({}),pt.getUser(),Ue.getTransforms(),Ee.getUserSourceLabels(),Ee.getDefaultSourceLabels(),Dt.getPlaceholderSrcMatches(),Dt.getPrivateSources(),Dt.getPublicSources(),Dt.getDisabledSourceIds()]),{featureFlags:p}=t;e.forEach((async e=>{if(void 0===e.id)return;const t=Be(e.id);if(!t)return;const r=new URL(t.srcPage.srcUrl),o=await Dt.getForURL({url:r,publicSources:c,privateSources:a$1,disabledSourceIds:u,featureFlags:p}),l=await Dt.getForURL({url:r,publicSources:c,privateSources:a$1,disabledSourceIds:u,featureFlags:p,opts:{getDisabled:!0}});qe(e.id,{cachedSourcesForUrl:{srcSelectors:o,transforms:Ue.getTransformStoreForSources(o,s),sourceLabelStore:Ee.getUserSourceLabelsForSources(o,n,i),disabledSrcSelectors:l}});})),async function(e){const{publicSources:t,privateSources:r,disabledSourceIds:s,featureFlags:n,transformStore:i,userSourceLabelStore:o,defaultSourceLabelStore:a}=e;if(!n.variablesOnClosedTabsEnabled)return;const c=Object.values(await Xn("lastSrcPageForBaseUrl")||{}),u=await Ee.getLabels(),p=[];await Promise.all(c.map((async({srcPage:e})=>{const c=await Dt.getForURL({url:new URL(e.srcUrl),publicSources:t,privateSources:r,disabledSourceIds:s,featureFlags:n}),l=c.flatMap((e=>{const t=Ue.getTransformStoreForSources(c,i),r=t[e.id]?t[e.id]:[],s=Ee.getUserSourceLabelsForSources(c,o,a)[e.id];return [{srcSelector:e,missing:!0,originalValue:"",plainTextValue:"",richTextValue:"",transforms:r,label:s?u[s[0].labelId]:null}]})),d={...e,srcMatches:l};p.push(d);}))),De(n,p);}({publicSources:c,privateSources:a$1,disabledSourceIds:u,featureFlags:p,transformStore:s,userSourceLabelStore:n,defaultSourceLabelStore:i}),Gt({placeholderSrcMatches:o});}));}static async updateAllSourcesFromAPI(){const e=await Ft();e?(await Qn("publicSourcesV1",e.public),await Qn("sourcesV1",e.private),await Qn("disabledSourceIds",e.disabledSourceIds)):r.error("Sources could not be updated");}static async saveSourcesToServer(e){const t=await async function(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{return (await se(Mt,t)).response.json()}catch(e){throw r.error("Error saving sources",e),e}}(e);if(!t)return void r.error("Sources could not be updated");r.info("Saved sources. Response: ",t);const r$1=await Dt.getPublicSources(),n=await Dt.getPrivateSources();for(const e of t)e.public?r$1[e.id]=e:n[e.id]=e;await Qn("publicSourcesV1",r$1),await Qn("sourcesV1",n);}static async saveDisabledSourcesToServer(e){return async function(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{return (await se(`${Un$1}/sources/disabled`,t)).response.json()}catch(e){throw r.error("Error disabling sources",e),e}}(e)}static async reenableSourcesOnServer(e){return async function(e){if(!e)return [];const t={method:"DELETE",body:JSON.stringify(e)};try{return (await se(`${Un$1}/sources/disabled`,t)).response.json()}catch(e){throw r.error("Error disabling sources",e),e}}(e)}static async getPrivateSources(){return await Xn("sourcesV1")||{}}static async getPublicSources(){return await Xn("publicSourcesV1")||{}}static async getDisabledSourceIds(){return await Xn("disabledSourceIds")||[]}static async getForURL(e){const{url:t,publicSources:r,privateSources:s,disabledSourceIds:n,featureFlags:i,opts:o$1}=e;return i.variablesEnabled?function(e,t={},r={},s=[],n){const i=Object.values(r).concat(Object.values(t)).filter((e=>"placeholder"!==e.type)).filter((e=>n?.getDisabled?s.includes(e.id):!s.includes(e.id))).sort(((e,t)=>Date.parse(e.createdAt)-Date.parse(t.createdAt))),o$1=o.groupBy(i,(e=>e.baseUrl)),c=o.map(o$1,((e,t)=>{let r=[];return e.forEach((e=>{r=r.concat([e]);})),{baseUrl:t,sources:r}})),l=Yt$1(e),u=c.filter((({baseUrl:t})=>{const r=new URL(t),s=Yt$1(r);return l===s&&e.pathname.startsWith(r.pathname)}));return o(u).maxBy((t=>o(new URL(t.baseUrl).pathname.split("/")).zip(e.pathname.split("/")).filter((([e,t])=>e===t)).size()))?.sources||[]}(t,s,r,n,o$1):[]}static async getPlaceholderSrcMatches(){const{featureFlags:{placeholderVariablesEnabled:e}}=await pt.getUser();if(!e)return [];const[t,r]=await Promise.all([Dt.getPublicSources(),Dt.getPrivateSources()]),s=Object.values(t).concat(Object.values(r)).filter((e=>"placeholder"===e.type)),n=await Ee.getLabelsForSources(s);return s.map((e=>({srcSelector:e,label:n[e.id],originalValue:"",richTextValue:"",plainTextValue:"",transforms:[],missing:!0})))}}const Vt=new de,jt={};async function Lt(e,t){const r$1=t.flatMap((e=>e.transforms)),n=Be(e)?.srcPage?.srcMatches.map((({srcSelector:e})=>e.id))||[],i=t.map((({srcSelector:e})=>e.id))||[],o$1=o.difference(n,i),u=r$1.map((e=>e.id)),p=await Xn("sourceTransforms"),d=o.flatMap(p,(e=>o.values(e))),f=d.map((e=>e.id)),h=o.difference(f,u),g=d.filter((e=>h.includes(e.id))),m=o.difference(u,f),y=r$1.filter((e=>m.includes(e.id))),w=new Set(await Xn("disabledSourceIds")||[]),v=[],b=[];for(const e of t)w.has(e.srcSelector.id)?b.push(e.srcSelector.id):e.srcSelector.public&&!n.includes(e.srcSelector.id)&&v.push(e);if(!o.isEmpty(b)){await Dt.reenableSourcesOnServer(b);for(const e of b)w.delete(e);await Qn("disabledSourceIds",Array.from(w));}const S=v.map((e=>e.srcSelector));if(await Dt.saveSourcesToServer(S),pt.setUserChecklist({addVariable:!0}),!o.isEmpty(o$1)){await Dt.saveDisabledSourcesToServer(o$1);for(const e of o$1)w.add(e);await Qn("disabledSourceIds",Array.from(w));}o.isEmpty(y)||await Ue.saveTransform(y),o.isEmpty(g)||await Ue.deleteTransforms(g),r.info("Transform store to save: ",y);const I=await Ee.getUserSourceLabels(),E=S.map((e=>e.id)),_=t.filter((e=>{if(E.includes(e.srcSelector.id))return !1;const t=I[e.srcSelector.id];return t&&t.length?t[0].labelId!==e.label?.id:!!e.label})),T=v.concat(_).filter((e=>null!==e.label)).map((e=>({labelId:e.label?.id||"",sourceId:e.srcSelector.id})));o.isEmpty(T)||await Ee.saveUserSourceLabel(T);}async function Bt(e,t){if(void 0===e||!Be(e)||!t)return;const r=jt[e];qe(e,{panel:{hasOpenedViaBrowserAction:!0,activeView:"variables",isOpen:!0}}),r.next({type:"start"});}async function qt(e){const t=await Dt.getPrivateSources(),r=await Dt.getPublicSources();return e.flatMap((e=>{const s=r[e]||t[e];return s?[s]:[]}))}Vt.onTabConnect((async e=>{jt[e]=new R;})),Vt.streamingMethod("builderActionStream",(async({tabId:e})=>jt[e])),Vt.method("saveNewPlaceholder",(async(e,t)=>{if(!t.label)return;const[r]=await Ee.save([t.label]);if(!r)throw new Error("Could not save the placeholder");const s=o.cloneDeep(t);s.label=r;const n={...await Ee.getDefaultSourceLabels(),...await Ee.getUserSourceLabels()};(await qt(Object.values(n).flat().filter((e=>e.labelId===s.label?.id)).map((e=>e.sourceId)))).some((e=>"placeholder"===e.type))||(await Dt.saveSourcesToServer([s.srcSelector]),await Ee.saveUserSourceLabel([{sourceId:s.srcSelector.id,labelId:s.label.id}]));})),Vt.method("doneEditing",(async({tabId:e})=>{jt[e].next({type:"finish"});})),Vt.method("saveNewSourceWithLabel",(async({tabId:e,url:t},r)=>{const s=r.label;if(!s)return;const[n]=await Ee.save([s]),i=o.cloneDeep(r);if(!n)return;i.label=n;const{srcMatches:o$1}=Be(e).srcPage,c=o$1.concat([i]);if(!o$1.length){const{baseUrl:s}=r.srcSelector,{disabledSrcSelectors:n,srcSelectors:i}=Be(e).cachedSourcesForUrl;let o=i.find((e=>"url"===e.type&&e?.baseUrl===s));o||(o=n.find((e=>"url"===e.type&&e?.baseUrl===s))),o||(o={id:pe(),baseUrl:s,creatorUserId:"",exampleUrl:t.toString(),type:"url",public:!0,createdAt:(new Date).toISOString(),modifier:null}),c.push({srcSelector:o,missing:!1,richTextValue:t.toString(),plainTextValue:t.toString(),originalValue:t.toString(),transforms:[],label:v()});}Lt(e,c),i.srcSelector.modifier&&mt({type:"variable.modifier-selected",selector:i.srcSelector,label:i.label});})),Vt.method("editLabel",(async({tabId:e},t)=>{const r=t.label;if(!r)return;const[s]=await Ee.save([r]),{srcMatches:n}=Be(e).srcPage,i=o.cloneDeep(n),o$1=i.find((e=>e.srcSelector.id===t.srcSelector.id));o$1&&(o$1.label=s||null,Lt(e,i));})),Vt.method("promoteLabel",(async(e,t)=>{if(!t.label)return;const{label:r}=t,s={id:pe(),sourceId:t.srcSelector.id,labelId:r.id,locale:r.locale};await Ee.saveDefaultSourceLabel([s]);})),Vt.method("showModifiedVariablesDialog",(async({tabId:e},t,r)=>{jt[e].next({type:"showModifiedVariablesDialog",srcMatch:t,modifiers:r});})),Vt.method("removeSource",(async({tabId:e},t)=>{const{srcMatches:r}=Be(e).srcPage;r.find((e=>e.srcSelector.id===t))&&Lt(e,r.filter((e=>e.srcSelector.id!==t)));})),Vt.method("removeAllSources",(async({tabId:e})=>{Lt(e,[]);})),Vt.method("toggleTransform",(async({tabId:e},t,r)=>{const{srcMatches:s}=Be(e).srcPage,n=s.findIndex((e=>e.srcSelector.id===t));if(n<0)return;const i=o.cloneDeep(s),o$1=i[n],c=o.remove(o$1.transforms,(e=>e.type===r));if(o.isEmpty(c)){const e={id:pe(),type:"hyperlink",sourceId:t};o$1.transforms.push(e);}Lt(e,i);})),Vt.method("openVariablesView",(async({tabId:e})=>{const t=await a.browser.tabs.get(e),{url:s}=t;await Bt(e,s);})),Vt.method("queueFill",(async({tabId:e},t,r,s)=>{const{srcPage:n}=Be(e),i=n?.srcMatches||[];let o=0;const a=await Promise.all(r.map((async e=>{const t=i.find((t=>t.srcSelector.id===e.sourceId));if(!t)throw new Error("SrcMatch for queue fill not found");return !0===t.missing&&o++,{srcMatch:t,destSelector:{...e.sinkData,row:s},value:t.originalValue}}))),c=await Rt({sinkFullUri:t,valuesToAutofill:a,fillFirstWithInsert:!0});return c.success?mt({type:"queue.fill",numFieldsFilledIn:a.length,missingElements:o,sinkFullUrl:t}):mt({type:"queue.fill-error",sinkFullUrl:t,response:c}),c})),Vt.method("publishSrcMatches",(async({tabId:e},t)=>{qe(e,{srcPage:{srcMatches:t,tabId:e}});const{featureFlags:r}=await pt.getUser();$e(r);}));const $t=new de;function Gt(e){!async function(e){const t=await a.browser.tabs.query({});r.debug("background-store.notifyAllTabs - request:",e);for(const n of t)try{if(!n.id)continue;if(n.url&&n.url.startsWith("chrome://"))continue;await a.browser.tabs.sendMessage(n.id,e);}catch(e){!(performance.now()>1e3)&&e instanceof Error&&"Could not establish connection. Receiving end does not exist."===e.message||r.error(e);}}({action:"globalStateChanged",globalStatePartial:e});}async function Kt(e,t){const{variablesEnabled:r,variablesOnClosedTabsEnabled:s}=e;r&&s&&Gt({srcPagesForClosedTabs:t});}$t.method("getInitialGlobalState",(async()=>{const e=Re(),t=await St(),r=await zt.getAppConfig(),s=(await Ft$1({name:"shareId",url:r.magicalMarketingURL,domain:$n}))[0]||"";return {config:r,labels:await Xn("labelStore")||{},notifications:await Xn("notifications")||{},placeholderSrcMatches:await Dt.getPlaceholderSrcMatches(),recoveryState:await Gn("recoveryState"),referrals:await Xn("referrals")||[],sharedCollectionId:s,showVariableHelp:await Xn("showVariableHelp")??!0,snippetCollections:Object.values(await Xn("snippetCollections")||{}),snippets:Object.values(await er.getSnippets()),srcPagesForClosedTabs:Object.values(await Xn("lastSrcPageForBaseUrl")||{}).map((({srcPage:e})=>e)),srcPagesForOpenTabs:e,teamSnippets:await Xn("teamSnippets")||{},totalTimeSaved:t,userInfo:await pt.getUser()}}));class zt{static async init(){re("appConfig").subscribe((e=>{e&&Gt({config:e});}));}static async updateAppConfigFromServer(){try{const e=await ve.getAppConfig();await Qn("appConfig",e);}catch(e){const t=await Xn("appConfig"),r=Nn();(!t||!t.generatedAt||r.generatedAt>t.generatedAt)&&await Qn("appConfig",r);}}static async getAppConfig(){const e=await Xn("appConfig");if(!e){const e=Nn();return await Qn("appConfig",e),e}return e}}const Wt=`${Un$1}/snippet-collections`,Ht={async save(e){const t={method:"POST",body:JSON.stringify(e)};try{return (await se(Wt,t)).body}catch(e){throw r.error("Error creating snippet collection:",e),e}},async getSnippetCollection(e){try{return (await se(`${Wt}/${e}`)).body}catch(e){throw r.error("Error getting snippet collection:",e),e}},async getPublicSnippetCollection(e){try{return (await se(`${Wt}/public/${e}`)).body}catch(e){throw r.error("Error getting snippet collection:",e),e}},async getSnippetsByCollectionId(e){try{return (await se(`${Wt}/${e}/snippets`)).body}catch(e){throw r.error("Error getting snippet for collection:",e),e}},async getForUser(){try{return (await se(Wt)).body}catch(e){throw r.error("Error getting snippet collection:",e),e}},async deleteCollections(e){if(!e.length)return 0;try{const t={method:"DELETE",body:JSON.stringify(e)};return (await se(Wt,t)).body}catch(e){throw r.error("Error deleting snippet collections:",e),e}},async addItems(e){if(e.length)try{const t={method:"POST",body:JSON.stringify(e)};await se(`${Wt}/items`,t);}catch(e){throw r.error("Error adding items to snippet collections:",e),e}},async deleteItems(e){if(e.length)try{const t={method:"DELETE",body:JSON.stringify(e)};await se(`${Wt}/items`,t);}catch(e){throw r.error("Error removing items from snippet collections:",e),e}},async acceptSnippetCollection(e){try{const t={method:"POST",body:JSON.stringify({collectionId:e})};await se(`${Wt}/accepted`,t);}catch(e){throw r.error("Error adding user to accepted snippet collections:",e),e}}};class Jt{static init(){Yt.start(),re("snippetCollections").subscribe((async e=>{Gt({snippetCollections:Object.values(e??[])});}));}static async getSnippetCollections(){return Object.values(await Xn("snippetCollections")||{})}static async getSnippetCollection(e){return Ht.getSnippetCollection(e)}static async getPublicSnippetCollection(e){return Ht.getPublicSnippetCollection(e)}static async save(e){await Xt(e.snippetIds);const t=await Ht.save(e);if(!r$1(t))return t;const r=await Xn("snippetCollections")||{};return r[t.id]=t,await Qn("snippetCollections",r),t}static async getSnippetsByCollectionId(e){return Ht.getSnippetsByCollectionId(e)}static async updateForUserFromAPI(){const e=await Ht.getForUser(),t=o.keyBy(e,"id");await Qn("snippetCollections",t);}static async deleteCollections(e){await Ht.deleteCollections(e);const t=await Xn("snippetCollections")||{};for(const r of e)delete t[r];await Qn("snippetCollections",t);}static async addItems(e){await Xt(e.flatMap((e=>e.snippetIds))),await Ht.addItems(e);const t=await Xn("snippetCollections")||{};for(const r of e){const e=t[r.collectionId];e.snippetIds=Array.from(new Set(e.snippetIds.concat(r.snippetIds)));}await Qn("snippetCollections",t);}static async deleteItems(e){await Ht.deleteItems(e);const t=await Xn("snippetCollections")||{};for(const r of e){const e=t[r.collectionId];e.snippetIds=e.snippetIds.filter((e=>!r.snippetIds.includes(e)));}await Qn("snippetCollections",t);}static async snippetsDeleted(e){const t=await Xn("snippetCollections")||{};for(const r of Object.values(t))r.snippetIds=r.snippetIds.filter((t=>!e.includes(t)));await Qn("snippetCollections",t);}}async function Xt(e){const t=Object.values(await er.getDefaultSnippetsById()).filter((t=>e.includes(t.id)));t.length>0&&await er.saveSnippets(t);}const Yt=new de;Yt.method("saveSnippetCollection",(async(e,t)=>Jt.save(t))),Yt.method("addSnippetCollectionItems",(async(e,t)=>Jt.addItems(t))),Yt.method("deleteSnippetCollections",(async(e,t)=>Jt.deleteCollections(t))),Yt.method("deleteSnippetCollectionItems",(async(e,t)=>Jt.deleteItems(t))),Yt.method("getSnippetCollection",(async(e,t)=>Jt.getSnippetCollection(t))),Yt.method("getPublicSnippetCollection",(async(e,t)=>Jt.getPublicSnippetCollection(t))),Yt.method("getSnippetsByCollectionId",(async(e,t)=>Jt.getSnippetsByCollectionId(t))),Yt.method("getSharedSnippets",(async(e,t)=>{const r=await Jt.getSnippetsByCollectionId(t);return er.serverSnippetsToSnippets(r)})),Yt.method("acceptSnippetCollection",(async(e,t)=>Ht.acceptSnippetCollection(t)));const Qt=`${Un$1}/snippets`,Zt={async findById(e){try{return (await se(`${Qt}/${e}`)).response.json()}catch(e){throw r.error("Error finding snippet",e),e}},async getForUser(){try{return (await se(Qt)).body}catch(e){throw r.error("Error getting snippets for user:",e),e}},async save(e){if(!e.length)return [];const t={method:"POST",body:JSON.stringify(e)};try{return (await se(Qt,t)).body}catch(e){throw mt({type:"ate_saveSnippets_serverError",response:e}),r.error("Error saving snippet:",e),e}},async delete(e){if(!e.length)return 0;const t={method:"DELETE",body:JSON.stringify(e)};try{return (await se(`${Qt}`,t)).response.json()}catch(e){throw mt({type:"ate_deleteSnippets_serverError",response:e}),r.error("Error deleting snippets:",e),e}}};class er{static init(){rr.start(),re("snippets").subscribe((async()=>{const e=await this.getSnippets();Gt({snippets:Object.values(e)});})),re("teamSnippets").subscribe((async e=>{Gt({teamSnippets:e??{}});}));}static async syncSnippets(){await this.deleteUnsyncedDeletedSnippets(),await this.saveUnsyncedSnippets();const e=await this.getSnippetsFromServer(),t=o.keyBy(e,"id");await Qn("snippets",t),await this.removeDuplicateDefaultSnippets(),await Jt.updateForUserFromAPI();}static async removeDuplicateDefaultSnippets(){const e=Object.values(await this.getDefaultSnippetsById()),t=Object.values(await Xn("snippets")||{}).map((e=>e.trigger));o.remove(e,(e=>t.includes(e.trigger)));const r=o.keyBy(e,"id");await Qn("defaultSnippets",r);}static async getSnippetById(e){const t=await Zt.findById(e);if(t){return (await er.serverSnippetsToSnippets(t))[0]}}static async getSnippets(){const e=await Xn("snippets")||{};return {...Object.fromEntries(Object.entries(e).filter((([e,t])=>!t.deleted))),...await this.getDefaultSnippetsById()}}static async getDefaultSnippetsById(){const e=Object.values(await Xn("defaultSnippets")||{}).map((e=>({...e,default:!0})));return o.keyBy(e,"id")}static async updateLastUsed(e){const t=Object.values(await this.getSnippets()),r=t.find((t=>t.id===e));if(!r)return;r.lastUsedAt=Date.now();const s=o.keyBy(t,"id"),n=Un(r)?"defaultSnippets":"snippets";await Qn(n,s);}static async saveSnippets(e){if(!e||0===e.length)return [];const t=[];let r$1;e.forEach((e=>{const r=function(e){const{body:t}=e,r=document.createElement("div");r.innerHTML=t;const s=new Set,n=r.querySelectorAll("[data-magical-source-id]");for(const e of n){const t=e.attributes.getNamedItem("data-magical-source-id")?.value;t&&s.add(t);}const{body:i,plainTextBody:o}=tr(e,{type:"clear"});return {...e,body:i,plainTextBody:o,sourceIds:Array.from(s),lastUsedAt:0}}(e),s=this.snippetToServerSnippet(r);t.push(s);}));try{const e=await Zt.save(t),s=e.flatMap((e=>e.sourceIds));if(s.length>0){const e=[Ee.updateLabelsFromAPI(),Ee.updateUserSourceLabelsFromAPI()],[t,r]=await Promise.all([Dt.getPrivateSources(),Dt.getPublicSources()]),n=new Set(Object.keys(t).concat(Object.keys(r)));s.some((e=>!n.has(e)))&&e.push(Dt.updateAllSourcesFromAPI()),await Promise.allSettled(e);}r$1=await er.serverSnippetsToSnippets(e);let n=!1,i=!1;const o={createSnippet:!0},{platformToShortcutName:a}=await zt.getAppConfig(),c=a.map((e=>e.trigger));r$1.forEach((e=>{c.includes(e.trigger)||(e.srcSelectors.some((e=>"placeholder"===e.type))&&(n=!0),e.srcSelectors.some((e=>"placeholder"!==e.type))&&(i=!0));})),i&&(o.createVariableShortcut=!0),n&&(o.createPlaceholderShortcut=!0),pt.setUserChecklist(o);}catch(e){r$1=(await er.serverSnippetsToSnippets(t)).map((e=>({...e,synced:!1}))),r.error(e);}const n=await Xn("snippets")||{};for(const t of e)delete n[t.id];for(const e of r$1)n[e.id]=e;await Qn("snippets",n);const i=r$1.map((e=>e.id)),o$1=Object.values(await this.getDefaultSnippetsById());if(o.remove(o$1,(e=>i.includes(e.id))).length>0){const e=o.keyBy(o$1,"id");await Qn("defaultSnippets",e);}return r$1}static async deleteSnippets(e){if(!e.length)return;const t=await this.getDefaultSnippetsById(),r$1=Object.values(t).filter((t=>e.includes(t.id))).map((e=>e.id));r$1.forEach((e=>{delete t[e];})),await Qn("defaultSnippets",t);const n=e.filter((e=>!r$1.includes(e)));if(0===n.length)return;const i=await Xn("snippets")||{};try{await Zt.delete(n),n.forEach((e=>{delete i[e];}));}catch(e){n.forEach((e=>{i[e].synced=!1,i[e].deleted=!0;})),r.error(e);}await Qn("snippets",i),await Jt.snippetsDeleted(e);}static async saveTestSnippet(){const e={...Bn(),id:pe(),trigger:";test ",body:'This is the first line<br><br>&nbsp; &nbsp; &nbsp;&nbsp;&lt;-nonbreaking spaces<br><br><b>This</b> is to test that <u>you</u>:<br><ol><li>list</li><li>list</li><li>list</li></ol><br>See <a href="http://www.google.com">here</a><br><br>%d(YYYY) is the year<br><br>',plainTextBody:"This is the first line\n          \n                <-nonbreaking spaces\n          \n          This is to test that you:\n          \n          list\n          list\n          list\n          \n          See here\n          \n          %d(YYYY) is the year\n          \n          ",default:!0},t=o.keyBy([e],"id");return await Qn("defaultSnippets",t),Gt({snippets:[e]}),t}static snippetToServerSnippet(e){const{id:t,trigger:r,body:s,sourceIds:n,parentId:i}=e;return {id:t,body:s,parentId:i,sourceIds:n,trigger:r}}static async serverSnippetsToSnippets(e){const t=await Xn("snippets")||{},r=new Set(e.flatMap((e=>e.sourceIds))),s=await qt(Array.from(r)),n=await Ee.getLabelsForSources(s);return e.map((e=>{const r=t[e.id]?.lastUsedAt||0,i=s.filter((t=>e.sourceIds.includes(t.id))),o=i.flatMap((e=>"placeholder"!==e.type?[e.baseUrl]:[])),a=i.map((e=>({srcSelector:e,label:n[e.id]??null}))),c={plainTextBody:"",lastUsedAt:r,...e,body:rn(e.body),sources:a,srcSelectors:i,srcBaseUrls:Array.from(new Set(o))},l=tr(c,{type:"label",srcLabelMap:n});return {...c,...l}}))}static async getTeamSnippetsFromServer(e){const t=(await Jt.getSnippetCollections()).find((t=>t.teamId===e));if(!t)return [];const r=await Jt.getSnippetsByCollectionId(t.id),s=await er.serverSnippetsToSnippets(r),n=await Xn("teamSnippets")||{};return n[e]=s,await Qn("teamSnippets",n),s}static async getTeamSnippets(){return await Xn("teamSnippets")||{}}static async getSnippetsFromServer(){const e=await Zt.getForUser();return er.serverSnippetsToSnippets(e)}static async saveUnsyncedSnippets(){const e=Object.values(await Xn("snippets")||{}).filter((e=>!1===e.synced&&!e.deleted));await this.saveSnippets(e);}static async deleteUnsyncedDeletedSnippets(){const e=Object.values(await Xn("snippets")||{}).filter((e=>!1===e.synced&&e.deleted)).map((e=>e.id));await this.deleteSnippets(e);}}function tr(e,t){const{body:r,srcSelectors:s}=e,n=document.createElement("div");s$2.sanitize(n),n.innerHTML=r,document.body.append(n);const i=n.querySelectorAll("[data-magical-source-id]");for(const e of i){const r=e.attributes.getNamedItem("data-magical-source-id")?.value;if(r)switch(t.type){case"clear":e.innerText="";break;case"label":{const n=s.find((e=>e.id===r)),i=n?t.srcLabelMap[n.id]?.name:null;e.innerText=i||"Unlabeled Variable";break}case"srcValue":{const{srcMatches:s}=t;e.removeAttribute("data-magical-source-id"),e.removeAttribute("data-magical-is-placeholder");const n=s.find((e=>e.srcSelector.id===r));n?"placeholder"===n.srcSelector.type?e.textContent=n.plainTextValue:e.innerHTML=n.richTextValue:e.innerHTML="";break}case"placeholderInputs":{const{sources:s,srcMatches:n}=t,i=document.createElement("input");i.setAttribute("data-magical-placeholder-src-id",r),i.setAttribute("data-magical",""),i.setAttribute(b,""),i.setAttribute(T,""),i.placeholder=s.find((e=>e.srcSelector.id===r))?.label?.name??"",i.defaultValue=n.find((({srcSelector:e})=>e.id===r))?.plainTextValue??"",e.replaceWith(i);}}}const o=n.innerText.replace(/\s+$/,(e=>e.replace(/\xa0/g," "))),a={body:n.innerHTML,plainTextBody:o};return n.remove(),a}const rr=new de;rr.method("getSnippetById",(async(e,t)=>er.getSnippetById(t))),rr.method("getSnippets",(async e=>er.getSnippets())),rr.method("getSnippetBody",(async(e,t,r)=>tr(t,r))),rr.method("deleteSnippet",(async(e,t)=>{await er.deleteSnippets([t.id]);})),rr.method("saveSnippets",(async(e,t)=>{const r=[],s=await er.getSnippets();for(const e of t){const t={...s[e.id]||Bn(),...e};r.push(t);}return 0===r.length?[]:er.saveSnippets(r)})),rr.method("syncTeamSnippets",(async(e,t)=>er.getTeamSnippetsFromServer(t)));const sr=new de,nr={},ir={};async function or(e,t){const r=ir[e];if(void 0===r[t]){r[t]=[];const e=(await er.getSnippets())[t];e&&(r[t]=e.srcSelectors.filter((e=>"placeholder"!==e.type)).map((e=>({srcSelector:e,srcFullUrl:void 0,srcBaseUrl:e.baseUrl}))));}return r[t]}function ar(e,t){return new URL(e).hostname===new URL(t).hostname}function cr(e,t){const r=[e.plainTextValue];return e.label&&r.push(e.label.name),{type:"standard",srcMatch:e,displayValue:e.plainTextValue,searchValues:r,usedInFill:t}}function lr(e,t,r,s){const{title:n,srcUrl:i,srcMatches:o$1}=e,c=o$1.filter((e=>e.missing)),l=o$1.filter((e=>!e.missing)).map((e=>cr(e,r[i]&&o(r[i]).some(e.srcSelector))));return void 0!==t&&l.length>t&&l.push({type:"show-more-variables",searchValues:[],displayValue:"Show more variables"}),{groupTitle:n,groupType:"",srcUrl:i,suggestions:l,groupSortOrder:s,missingElements:c.length}}function ur(e){return e in nr||(nr[e]={forceShowAll:!1,magicUsed:new Set,dropdownView:"default",previousSuggestion:void 0,showAllVariables:!1}),nr[e]}async function pr(e){e&&await ze.deleteMapping(e);}sr.onTabConnect((async e=>{ir[e]={};})),sr.onTabDisconnect((async e=>{delete ir[e];})),sr.method("getClipboardData",(async()=>{const e={paste:""};if(await a.browser.permissions.request({permissions:["clipboardRead"]})){const t=document.createElement("textarea");document.body.appendChild(t),t.select(),document.execCommand("paste",!0)&&(e.paste=t.value),t.remove();}return e})),sr.method("getAutofillValues",(async({tabId:e},{destSelector:t,existingMapping:r,isLongForm:s})=>"snippet"===ur(t.sinkFullUrl).dropdownView?async function(e,t){const{previousSuggestion:r}=nr[e.sinkFullUrl];if("snippet-unfilled"!==r?.type)throw Error(`expected unfilled snippet as previous suggestion: ${r?.type}`);const{snippet:s}=r,n=(await async function(e,t){return t.map((t=>{const{body:r,plainTextBody:s}=tr(e,{type:"srcValue",srcMatches:t.srcMatches});return {richTextBody:r,plainTextBody:s,srcPage:t}}))}(s,r.srcPages)).map((({srcPage:e,richTextBody:r,plainTextBody:n})=>{const i=[],{variablesFilled:o,missingElements:a}=function(e,t){const r=t.srcMatches.filter((({missing:t,srcSelector:r})=>!t&&e.srcSelectors.some((({id:e})=>r.id===e)))).length;return {variablesFilled:r,missingElements:e.srcSelectors.length-r}}(s,e),c=e.srcMatches.filter((({srcSelector:e})=>s.srcSelectors.some((t=>t.id===e.id)))),l={displayValue:"Autofill all variables",missingElements:a,plainTextValue:n,richTextValue:r,searchValues:[e.title],snippet:s,srcMatches:c,srcUrl:e.srcUrl,tags:[],type:"snippet",variablesFilled:o};if(i.push(l),a>0){const t={type:"missing",displayValue:`${a} variables missing`,tabId:e.tabId,searchValues:[]};i.push(t);}return {groupTitle:e.title,groupType:"pages-for-dynamic-snippet",srcUrl:e.srcUrl,suggestions:i,missingElements:a,groupSortOrder:e.tabId===t?Number.MAX_SAFE_INTEGER:e.tabId}})),{body:i,plainTextBody:o}=tr(r.snippet,{type:"srcValue",srcMatches:[]}),a={type:"snippet",snippet:r.snippet,srcMatches:[],displayValue:`${o}`,richTextValue:i,plainTextValue:o,missingElements:r.snippet.srcSelectors.length,variablesFilled:0,srcUrl:r.snippet.srcBaseUrls[0],searchValues:[r.snippet.trigger,o],tags:[]},c={groupTitle:"Insert without variables",groupType:"pages-for-dynamic-snippet",srcUrl:r.snippet.srcBaseUrls[0],suggestions:[a],missingElements:0,groupSortOrder:1};return n.unshift(c),{groups:n,footerText:""}}(t,e):(pt.setUserChecklist({searchShortcuts:!0}),async function(e,t,r,s){const n=nr[t.sinkFullUrl];let i=await ze.getMappingsForSinkUrl(t.sinkFullUrl);const o$2=Re(),{dropdownVariableLimit:c}=await zt.getAppConfig(),u=o$2.map((t=>lr(t,n.showAllVariables?void 0:c,{},e===t.tabId?Number.MAX_SAFE_INTEGER:t.tabId))),p={type:"create-snippet",displayValue:"Create new",searchValues:["Create new"]};let d=-1;s&&"snippet"!==t.type&&(d=Number.MAX_SAFE_INTEGER);const f={groupTitle:"Shortcuts",groupType:"",srcUrl:(await zt.getAppConfig()).magicalMarketingURL,suggestions:"snippet"===t.type?[]:[p],groupSortOrder:d},h=await async function(e){const t=qn(Object.values(await er.getSnippets())).flatMap((t=>{if(0===t.srcSelectors.length)return [[t,[]]];const r=S(t,e);return r.length>0?[[t,r]]:[[t,[]]]})),r=Object.values(await Xn("snippetCollections")||{}),s=o$1(r).reduce(((e,t)=>{for(const r of t.snippetIds)t.label&&(e[r]=e[r]||[],e[r].push({label:t.label,color:t.metadata?.tag?.color}));return e}),{});return t.map((([e,t])=>0===t.length&&0===e.srcSelectors.length||e.sources.every((e=>"placeholder"===e.srcSelector.type))?{displayValue:`${e.plainTextBody}`,missingElements:0,plainTextValue:e.plainTextBody,richTextValue:e.body,searchValues:[e.trigger,e.plainTextBody],snippet:e,srcMatches:[],srcUrl:"",tags:s[e.id]||[],type:"snippet",variablesFilled:0}:w(e,t)))}(o$2);if(f.suggestions.push(...h),u.push(f),"snippet"===t.type){if(0===(await or(e,t.snippetId)).length)return {groups:u,footerText:""}}else if((void 0===i||void 0!==n&&n.forceShowAll)&&!r)return {groups:u,footerText:""};let g;if(void 0===r){"snippet"===t.type&&(i=(await or(e,t.snippetId)).map((({srcSelector:e,srcBaseUrl:r,srcFullUrl:s})=>({sinkData:t,sinkFullUrl:t.sinkFullUrl,id:t.snippetId,srcSelector:e,srcUrl:s||r,sourceId:e.id}))));const r=o(i).map("srcUrl").uniq().value(),s=o$2.filter((({srcUrl:e})=>r.includes(e)));let l;const[u,p]=o.partition(o$2,(({srcMatches:e})=>r.some((t=>e.some((({srcSelector:e})=>t.startsWith(e.baseUrl)))))));l=s.length?s:u;const d=o(i).groupBy("srcUrl").mapValues((e=>o(e).map("srcSelector").value())).value();g=l.map((t=>lr(t,n.showAllVariables?void 0:c,d,e===t.tabId?Number.MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER-1))),"snippet"!==t.type&&(g=g.concat(p.map((t=>lr(t,n.showAllVariables?void 0:c,d,e===t.tabId?Number.MAX_SAFE_INTEGER-2:t.tabId)))));}else {const e=o(o$2).filter((({srcUrl:e})=>ar(e,r.srcUrl))).map((({title:e,srcUrl:s,srcMatches:n,tabId:o})=>{const a=n.find((({srcSelector:e})=>e.id===r.sourceId));if(void 0===a)return;return {groupTitle:e,groupType:"",srcUrl:s,groupSortOrder:o,suggestions:[{type:"magic",displayValue:"",srcMatch:a,searchValues:[e,a.plainTextValue],valuesToAutofill:n.flatMap((e=>i.filter((t=>t.sourceId===e.srcSelector.id&&t.id!==r.id)).map((r=>"cell"===r.sinkData.type&&"cell"===t.type?{destSelector:{...r.sinkData,row:t.row},value:e.originalValue,srcMatch:e}:{destSelector:r.sinkData,value:e.originalValue,srcMatch:e}))))},cr(a)]}})).compact().value();if(g=e,n&&n.magicUsed){const[t,r]=o(e).partition((e=>n.magicUsed.has(e.srcUrl))).value();g=o.concat(r,t);}if("cell"===t.type){const e=o$2.filter((({srcUrl:e})=>ar(e,r.srcUrl))).filter((({srcUrl:e})=>!n||n&&!n.magicUsed.has(e))),s=e.flatMap((({srcMatches:e},r)=>e.flatMap((e=>i.filter((t=>t.sourceId===e.srcSelector.id)).map((s=>({destSelector:{...s.sinkData,row:t.row+r},value:e.originalValue,srcMatch:e})))))));if(s.length>1){const t=s.find((e=>r.sourceId===e.srcMatch.srcSelector.id)),n={groupTitle:"Remaining webpages",groupType:"",srcUrl:r.srcUrl,groupSortOrder:Number.MAX_SAFE_INTEGER,fillValue:t?.value||"",suggestions:[{type:"magic-fill-all",srcUrls:e.map((({srcUrl:e})=>e)),displayValue:"",valuesToAutofill:s,srcMatch:t?.srcMatch}]};g.unshift(n);}}}if(0===g.length)return {groups:u,footerText:""};g.push(f);let m="Remove magic mapping";r||(m="","snippet"!==t.type&&g.length<u.length&&(m="Show all fields"));return {groups:g,footerText:m}}(e,t,r,s)))),sr.method("standardSelected",(async({url:e},{srcSelector:t,srcUrl:r,destSelector:s,existingMapping:n})=>{await pr(n);const i=await zt.getAppConfig();if(pt.setUserChecklist({autofillVariable:!0}),i.messagingSites.some((t=>e.href.startsWith(t))))return;if("placeholder"===t.type)return;const o={id:pe(),sinkData:s,sourceId:t.id,srcSelector:t,srcUrl:r,sinkFullUrl:s.sinkFullUrl};await ze.saveMapping(o);const a=ur(s.sinkFullUrl);a.magicUsed.add(r),a.forceShowAll=!1,a.showAllVariables=!1;})),sr.method("snippetVariableSelected",(async({tabId:e},{srcSelector:t,srcFullUrl:r,snippetId:s})=>{if("placeholder"===t.type)return;(await or(e,s)).push({srcSelector:t,srcFullUrl:r,srcBaseUrl:t.baseUrl});})),sr.method("snippetVariableRemoved",(async({tabId:e},{srcId:t,snippetId:r,fromSrcPage:s})=>{const n=await or(e,r),i=n.findIndex((e=>t===e.srcSelector.id&&(s?void 0!==e.srcFullUrl:void 0===e.srcFullUrl)));i>-1&&n.splice(i,1);})),sr.method("snippetEditingDone",(async({tabId:e},t)=>{t&&delete ir[e][t];})),sr.method("magicSelected",(async(e,{fillFlowId:t,srcUrl:s,valuesToAutofill:n})=>{const{url:i,tabId:o$1}=e;o.isEmpty(n)||a.browser.tabs.sendMessage(o$1,{fillFlowId:t,action:"magicFillValues",data:n});const c=Kt$1(i.toString());if(!await ze.getMappingsForSinkUrl(c))return;const l=ur(c);l.magicUsed.add(s),l.forceShowAll=!1;})),sr.method("magicFillAllSelected",(async({url:e},{srcUrls:t})=>{const r=ur(Kt$1(e.toString()));for(const e of t)r.magicUsed.add(e);})),sr.method("setDropdownView",(async(e,t,r,s)=>{const n=ur(r.sinkFullUrl);n.dropdownView=t,n.previousSuggestion=s;})),sr.method("showAllVariablesInDropdown",(async(e,t)=>{ur(t).showAllVariables=!0;})),sr.method("selectedSnippet",(async({tabId:e,url:t},r,s)=>{await er.updateLastUsed(r);const n=(await er.getSnippets())[r];n&&Un(n)&&await er.saveSnippets([n]);const i=ur(s);i.dropdownView="default",i.previousSuggestion=void 0,n.sourceIds.length>0&&pt.setUserChecklist({insertVariableShortcut:!0}),pt.setUserChecklist({insertSnippet:!0}),pt.showPopularSitePanelForUser(e,t.toString());const o=await pt.getUser(),a=await Xn("notifications");!o.featureFlags.referralCreditsNotificationEnabled||o.onboarding?.referralCreditsNotificationMade||a?.referralCreditsNotificationMade?!o.featureFlags.proBetaUpgradeExperienceEnabled||o.onboarding?.proBetaCohort===R$1.NEW_USER||o.onboarding?.proBetaUpgradeModalClosed||o.onboarding?.proBetaUpgradeNotificationMade||(mt({type:"pro-beta-upgrade.notification.shake"}),pt.updateUserOnboarding({proBetaUpgradeNotificationMade:!0}),qe(e,{panel:{activeView:"proBetaUpgradeUpdate",previousViews:["default"],proBetaUpgradeNotificationOpen:!0,hasOpenedViaBrowserAction:!0}})):(mt({type:"referral-credits.update.shake"}),pt.updateUserOnboarding({referralCreditsNotificationMade:!0}),g({referralCreditsNotificationMade:!0}),qe(e,{panel:{activeView:"referralCreditsUpdate",previousViews:[],referralCreditsNotificationOpen:!0,hasOpenedViaBrowserAction:!0}}));})),sr.method("autofillShowAll",(async(e,t,r)=>{await pr(r);ur(t.sinkFullUrl).forceShowAll=!0;})),sr.method("autofillCancel",(async(e,t)=>{const r=nr[t];r&&(r.forceShowAll=!1,r.dropdownView="default",r.previousSuggestion=void 0,r.showAllVariables=!1);})),sr.method("focusOpenTab",(async(e,t)=>{const{windowId:s}=await a.browser.tabs.get(t);s&&await a.browser.windows.update(s,{focused:!0}),a.browser.tabs.update(t,{active:!0});}));let dr=1e3*Nn().serverReachableRequestCacheTtlInSec;const fr={lastRequestTime:Number.NEGATIVE_INFINITY,lastServerReachableResult:!0,pendingRequest:null},hr={async isServerReachable(){if(Date.now()-fr.lastRequestTime<dr)return fr.lastServerReachableResult;try{fr.pendingRequest||(fr.pendingRequest=se(`${Un$1}/static/connection-check.txt`,{headers:{"Cache-Control":`max-age=${Math.floor(dr/1e3)}`}}));const e=await fr.pendingRequest;return fr.lastServerReachableResult=200===e.response.status&&"OK\n"===e.body,fr.lastServerReachableResult}catch(e){return fr.pendingRequest=null,r.error("Error geting server info",e),fr.lastServerReachableResult=!1,fr.lastServerReachableResult}finally{fr.pendingRequest=null,fr.lastRequestTime=Date.now(),dr=1e3*(await zt.getAppConfig()).serverReachableRequestCacheTtlInSec;}}},gr=new de;gr.method("isServerReachable",(async e=>hr.isServerReachable()));const mr=/^(https?|wss?|file|ftp|\*):\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^file:\/\/\/.*$|^resource:\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^about:/;function yr(e){if(!mr.test(e))throw new Error(e+" is an invalid pattern, it must match "+String(mr));let[,t,r,s]=e.split(/(^[^:]+:[/][/])([^/]+)?/);return t=t.replace("*","https?").replace(/[/]/g,"[/]"),r=(null!=r?r:"").replace(/^[*][.]/,"([^/]+.)*").replace(/^[*]$/,"[^/]+").replace(/[.]/g,"[.]").replace(/[*]$/g,"[^.]+"),s=s.replace(/[/]/g,"[/]").replace(/[.]/g,"[.]").replace(/[*]/g,".*"),"^"+t+r+"("+s+")?$"}function wr(...e){return new RegExp(e.map(yr).join("|"))}async function vr(e){const{js:t=[],css:s=[],allFrames:n,matchAboutBlank:i,matches:o,excludeMatches:a$1,runAt:c}=e,l=wr(...o),u=wr(...a$1||[]),p=async e=>{const{url:o}=await a.browser.tabs.get(e);if(o&&l.test(o)&&(!a$1||!u.test(o))&&await async function(e){return a.browser.permissions.contains({origins:[`${new URL(e).origin}/*`]})}(o)){for(const t of s)a.browser.tabs.insertCSS(e,{...t,matchAboutBlank:i,allFrames:n,runAt:c??"document_start"});for(const s of t)a.browser.tabs.executeScript(e,{...s,matchAboutBlank:i,allFrames:n,runAt:c});}};return (await a.browser.tabs.query({url:o})).forEach((async e=>{void 0!==e.id&&await p(e.id);})),Promise.resolve()}const br=new de;br.method("sendEvent",((e,...t)=>Promise.resolve(Cr.sendEvent(...t)))),br.method("sendSession",((e,...t)=>Cr.sendSession(...t))),br.method("close",((e,...t)=>Cr.close(...t))),br.method("recordLostEvent",((e,...t)=>Promise.resolve(Cr.recordLostEvent(...t))));const Sr=/^https:\/\/(www\.)?getmagical\.com\/.*(signup-details|use-cases)/;async function Ir(e){const{reason:t,trackAction:n}=e,i=!!await Xn("appConfig");try{await zt.updateAppConfigFromServer();}catch(e){r.error(`Error updating appConfig during extension ${t}:`,e);}try{await ut();}catch(e){r.error(`Error updating user data from API during extension ${t}:`,e);}const o=await pt.getUser();if("install"===t){const e={};try{const{trackingDeviceId:t,trackingUserId:r}=await yt();t&&(e.trackingDeviceId=t),r&&(e.trackingUserId=r);}catch(e){r.error("Error with setAmplitudeUser",e);}const{version:t}=a.browser.runtime.getManifest(),a$1=!!await Gn("installed");if(n){const e=(await a.browser.tabs.query({url:"https://chrome.google.com/webstore/*"})).length>0;let s=[];if(!e&&function(){const e=Date.now(),t=Date.parse("2022-01-18 12:00:00z"),r=Date.parse("2022-01-18 19:00:00z"),s=Date.parse("2022-01-25 12:00:00z"),n=Date.parse("2022-01-25 19:00:00z");return e>t&&e<r||e>s&&e<n}()){s=(await a.browser.tabs.query({})).map((e=>e.url||""));}const n=Math.abs(Date.now()-new Date(o.createdAt).getTime())<864e5;mt({type:"ate_installed",version:t,isExtensionStoreOpen:e,openTabUrls:s,appConfigSetInLocalStorage:i,isSyncStorageEmptyAndUserCreatedWithinOneDay:!a$1&&n,hasSyncStorage:a$1,userCreatedWithinOneDay:n});}a$1||await Kn("installed",!0),Jn().subscribe((()=>{Yn();})),await st();}else if("update"===t){const{version:t}=a.browser.runtime.getManifest();o.featureFlags.variablesEnabled&&t!==e.previousVersion&&e.previousVersion&&ye.lte(e.previousVersion,"3.3.26")&&a.browser.notifications.create("ATE_VARIABLES_NOTIFICATION",{type:"basic",iconUrl:"../assets/icon-64.png",title:"You’ve been Magically upgraded",message:"You are now on Magical Pro Beta. Try Variables, and more.",requireInteraction:!0}),n&&mt({type:"ate_updated",previousVersion:e.previousVersion,version:t});e.previousVersion?.startsWith("1.")?Jn().subscribe((async()=>{await async function(){const e=await Hn(),t=Object.values(await er.getSnippets()).map((e=>e.trigger)),r$1=e.backedUpShortcuts||[],n=[];for(const[s,i]of Object.entries(e)){if(!Bn$1(s)||r$1.includes(s))continue;const e=Vn(s);t.includes(e)?r$1.push(s):n.push({...Bn(),id:pe(),trigger:e,body:rn(nn(i))});}try{const e=(await er.saveSnippets(n)).flatMap((e=>`${Fn}${e.trigger}`)),t=r$1.concat(e);await Kn("backedUpShortcuts",t);}catch(e){r.error("Error backing up shortcuts: ",e);}}(),Yn();})):Jn().subscribe((()=>{Yn();}));await Xn("lastCopiedForAUrl")&&te("lastCopiedForAUrl");}(o?.featureFlags.injectContentScriptsOnInstallAndReload??1)&&a.browser.runtime.getManifest().content_scripts?.forEach((async e=>{vr({js:e.js?.flatMap((e=>({file:e})))||[],css:e.css?.flatMap((e=>({file:e})))||[],matches:e.matches,matchAboutBlank:e.match_about_blank,excludeMatches:e.exclude_matches,runAt:e.run_at});}));}async function Er(){if(a.browser.runtime.requestUpdateCheck){const[e]=await a.browser.runtime.requestUpdateCheck();!function(e){switch(e){case"update_available":return r.info("Update available… reloading extension"),void a.browser.runtime.reload();case"no_update":return;case"throttled":r.info("Update checking is throttled");}}(e);}}async function _r(){const e=()=>a.browser.alarms.clear("ONBOARDING_ALARM"),t=await pt.getUser(),s=await Xn("notifications");if(!s||!1!==s.onboard)return t.onboarding?.checklist?.insertSnippet?(Qn("notifications",{...s,onboard:!1}),void e()):void(t.featureFlags.onboardNotificationEnabled&&(Date.now()-new Date(t.createdAt).getTime()<72e5||(a.browser.notifications.create("ONBOARDING_NOTIFICATION",{type:"basic",iconUrl:"assets/icon-64.png",title:"Get back 2 hours a week",message:"Magical saves users 2+ hours per week! Try the 1 min tutorial",requireInteraction:!0}),mt({type:"popup.notification-onboard-try"}),Qn("notifications",{...s,onboard:!1}),e())));e();}async function Tr(){const{featureFlags:e}=await pt.getUser(),t=await Xn("lastSrcPageForBaseUrl")||{};Ve(e,Object.values(t).filter((e=>new Date(e.closedAt).getTime()<Date.now()-2592e6)).map((e=>e.srcPage)),t);}window.MAGICAL_CSP_NONCE_SUFFIX=`${window.crypto.getRandomValues(new Uint32Array(1))[0]}`,window.MAGICAL_CSP_BUILD_ENV=Mn,Dr(r),window.loglevel=r,sr.start(),Ye.start(),Pt.start(),et.start(),fe.start(),Pe.start(),gr.start(),zt.init(),async function(){const{sentryConfigs:e}=await zt.getAppConfig();jr(e,"background",{enableTracing:!1});}(),Ee.init(),ze.init(),Jt.init(),er.init(),Dt.init(),Ce.init(),pt.init(),async function(){oe("recoveryState").subscribe((e=>{Gt({recoveryState:e});}));}(),function(){nt.start(),a.browser.browserAction.onClicked.addListener(it);const e="CONTEXT_MENU_OPEN_OPTIONS";re("userInfo").subscribe((async t=>{try{await a.browser.contextMenus.remove(e);}catch(e){}t?.featureFlags.fabPanelEnabled&&a.browser.contextMenus.create({id:e,title:"Open Magical Workspace",contexts:["browser_action"]});})),a.browser.contextMenus.onClicked.addListener((async t=>{t.menuItemId===e&&st();}));}(),$t.start(),async function(){re("notifications").subscribe((async e=>{Gt({notifications:e});}));}(),br.start(),async function(){ft.start(),re("latestFill").subscribe((async()=>{Gt({totalTimeSaved:await St()});}));}(),r.setDefaultLevel("info"),a.browser.runtime.onInstalled.addListener((async e=>{"install"!==e.reason&&"update"!==e.reason||Ir({reason:e.reason,trackAction:!0,previousVersion:e.previousVersion});}));const Ur=Nn();a.browser.alarms.create("checkForExtensionUpdate",{periodInMinutes:Ur.extensionUpdateIntervalMinutes}),a.browser.alarms.create("loginNotificationReminder",{periodInMinutes:Ur.loginReminderNotification}),a.browser.alarms.create("ONBOARDING_ALARM",{periodInMinutes:Ur.onboardingNotificationIntervalMinutes}),a.browser.alarms.create("sendSnippetExpansionEvents",{periodInMinutes:Ur.sendSnippetExpansionEventsIntervalMinutes}),a.browser.alarms.create("updateAmplitudeUserInfo",{periodInMinutes:Ur.amplitudeUserInfoUpdateIntervalMinutes}),a.browser.alarms.create("updateAppConfig",{periodInMinutes:Ur.updateAppConfigIntervalMinutes}),a.browser.alarms.create("updateAutosuggest",{periodInMinutes:Ur.updatePasteCountsIntervalMinutes}),a.browser.alarms.create("updateUserDataFromApi",{periodInMinutes:Ur.updateUserDataIntervalMinutes}),a.browser.alarms.create("updateClosedTabStore",{periodInMinutes:Ur.updateClosedTabStoreIntervalMinutes}),a.browser.alarms.onAlarm.addListener((e=>{switch(e.name){case"checkForExtensionUpdate":Er();break;case"loginNotificationReminder":!async function(){await pt.isLoggedIn()||a.browser.notifications.create("ATE_LOGIN_NOTIFICATION",{type:"basic",iconUrl:"../assets/icon-64.png",title:"Magical: Please Sign In",message:"Sign in for free to get unlimited backups, storage and more site support",requireInteraction:!0});}();break;case"ONBOARDING_ALARM":_r();break;case"sendSnippetExpansionEvents":It();break;case"updateAmplitudeUserInfo":yt();break;case"updateAppConfig":zt.updateAppConfigFromServer();break;case"updateAutosuggest":!async function(){const e=await Xn("pasteCounts")||{},t=Date.now()-12096e5,r={};for(const[s,n]of Object.entries(e))n.lastUpdatedAt>t&&(r[s]=n);Qn("pasteCounts",r);}(),async function(){const e=await Xn("copiedMatchersByUrl")||{},t=Date.now()-12096e5,r={};for(const[s,n]of Object.entries(e)){const e=n.filter((e=>e.lastUpdatedAt<t));e&&(r[s]=e);}Qn("copiedMatchersByUrl",r);}();break;case"updateUserDataFromApi":ut();break;case"updateClosedTabStore":Tr();}})),a.browser.tabs.onUpdated.addListener((async(e,t)=>{t.url&&Sr.test(t.url)&&await lt();})),a.browser.runtime.onStartup.addListener((async()=>{try{await zt.updateAppConfigFromServer();}catch(e){r.error("Error updating app config:",e);}await lt();})),a.browser.runtime.onStartup.addListener((async()=>{It();})),a.browser.runtime.onStartup.addListener((async()=>{_r();})),a.browser.runtime.onStartup.addListener((async()=>{Tr();})),a.browser.notifications.onClicked.addListener((async e=>{switch(e){case"ATE_LOGIN_NOTIFICATION":Qe(Ze,{active:!0});break;case"ATE_VARIABLES_NOTIFICATION":ot();break;case"ONBOARDING_NOTIFICATION":{const{magicalMarketingURL:e}=await zt.getAppConfig();Qe(`${e}/onboarding/shortcuts/canned`,{active:!0}),a.browser.alarms.clear("ONBOARDING_ALARM"),mt({type:"popup.notification-close",notification:"onboard"});}}a.browser.notifications.clear(e);})),a.browser.notifications.onClosed.addListener((async e=>{a.browser.notifications.clear(e);})),a.browser.cookies.onChanged.addListener((async function(e){const t=new URL(Un$1).host.replace(/^api[^.]*[.]/,".");e.cookie.domain===t&&e.cookie.name===n&&(e.removed?"expired_overwrite"===e.cause?(r.info("logged out"),async function(){await It(),await mt({type:"ate_signout"});const{magicalMarketingURL:e}=await zt.getAppConfig(),t=ht();document.cookie=`${t}=;Max-Age=-99999;`,await a.browser.cookies.remove({name:t,url:e}),await a.browser.cookies.remove({name:"shareId",url:e}),await a.browser.cookies.remove({name:"referralCode",url:e}),await Zn("ateUserId"),await Zn("refreshToken"),await ne(),await async function(){const e=await gt;e.setUserId(null),e.regenerateDeviceId();}(),await Ir({reason:"install",trackAction:!1}),pt.setUserChecklist({acceptShortcuts:!0}),ct();}()):"overwrite"!==e.cause&&await s$3(e.cookie):await i(e.cookie));})),a.browser.cookies.onChanged.addListener((async function(e){if(e.cookie.domain!==`.${$n}`||"shareId"!==e.cookie.name||!e.cookie.value)return;if(e.removed)return void Gt({sharedCollectionId:""});const{shareShortcutsUrl:t}=await zt.getAppConfig(),s=e.cookie.value;Gt({sharedCollectionId:s});const n=`${t}?*shareId=${s}*`,[i]=await a.browser.tabs.query({url:n});i&&i.id?await rt(i.id):await st();})),async function(){!async function(){try{await a.browser.contextMenus.remove("CONTEXT_MENU_SHORTCUT_CREATE");}catch(e){}a.browser.contextMenus.create({id:"CONTEXT_MENU_SHORTCUT_CREATE",title:"Create shortcut",contexts:["selection","page"]});}(),ct(),async function(){for(const e of await a.browser.tabs.query({}))Me(e);}(),Tt(await pt.getUser());}();
