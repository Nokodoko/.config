import { a } from '../../index-9d8fa28c.js';
import { e as he, p as pe, Q as Qn, q as Kt, W as Nt, X as Xn, aa as ft, j as ht$1 } from '../../json-rpc-bbea77b7.js';
import { s, x, g } from '../../users-73981cf4.js';
import '../../keysIn-f91c894f.js';
import { B as Bn } from '../../logging-23079156.js';
import { addToDeconstructorListener as t } from '../destroy.js';
import { p as Qo, B as Bo, X as Xo, R as Ro, Z as Zo, v as qo, y as ri, x as oi, J as Jo, g as ni, A as ii } from '../../tracking-ba0776b8.js';
import { a as Sr, L as Lr, x as xr, d as Zr } from '../../content-ui-6b2a6ee6.js';
import '../../src-match-utils-e7679468.js';
import { h as ht, L as Le, G as Ge, R as Rt, H as He, U as Ue, I as Ie, W as We, V as Ve, N as Ne, a as Re } from '../../expander-30141e13.js';

async function H(e){if(!(e instanceof ClipboardEvent)||!e.isTrusted||!e.target||Nt(window.location))return;const{fabPanelEnabled:s,autosuggestVariableCreationEnabled:o}=Qo(),{csgBaseConfig:r}=Ro.getState().global.config,l=Xo();if(!s||!o||!1===l.autosuggestVariableEnabled)return;const{origin:u}=window.location,d=Lr(e.target),p=e.composedPath()[0],w=xr(p,pe(),{csgBaseConfig:r});if(!w)return;const b=await Xn("copiedMatchersByUrl")||{},v=b[u],E=l.autosuggestVariableThreshold||Ro.getState().global.config.variables.defaultAutosuggestThreshold;if(v)for(const e of v){const t=Zr(e.paths)||[];if(p&&t&&[...t].includes(p)){e.count+=1,e.lastUpdatedAt=Date.now(),e.count===E&&(g({autosuggestVariableContent:!0}),Jo({panel:{hasOpenedViaBrowserAction:!0}}),ni({type:"autosuggest.variable.show",completePath:d,baseUrl:u}));break}}else b[u]=[{count:1,lastUpdatedAt:Date.now(),paths:w}];Qn("copiedMatchersByUrl",b);}async function N(e){if(!(e instanceof ClipboardEvent)||!e.isTrusted||Nt(window.location))return;const{fabPanelEnabled:n,autosuggestShortcutCreationEnabled:s}=Qo(),o=Xo();if(!n||!s||!1===o.autosuggestVariableEnabled)return;const r=e.clipboardData?.getData("text");if(!r||r.length<11)return;const l=function(e){return e.trim()}(r),u=await Xn("pasteCounts")||{};let d=(u[l]?.count||0)+1;if(d===(o.autosuggestShortcutThreshold||Ro.getState().global.config.shortcuts.defaultAutosuggestThreshold)){"snippetEdit"!==qo((e=>e.panel.activeView))&&o.autosuggestShortcutEnabled?(g({autosuggestShortcutContent:l}),Jo({panel:{hasOpenedViaBrowserAction:!0}}),ni({type:"snippet.autosuggest-creation.show",suggestionLength:l.length})):d--;}u[l]={count:d,lastUpdatedAt:Date.now()},Qn("pasteCounts",u);}const $=/(?<!:)\/\//g,W=new WeakMap,z=new Set,R=new he("autofill-forms");function _(e,t=window){t.addEventListener("keydown",e,!0),t.addEventListener("keypress",e,!0),t.addEventListener("beforeinput",e,!0),t.addEventListener("input",e,!0),t.addEventListener("keyup",e,!0),t.addEventListener("paste",N),t.addEventListener("copy",H);}function G(e){const t=e.composedPath()[0];if(!t)return;if(!e.isTrusted)return;if("string"!=typeof t.value)return;const{mappingsEnabled:n}=Qo(),a=Sr(t,{mappingsEnabled:n}),i=J(t);ii(a,i,t.value);}function K(e){if("magicFillValues"===e.action){const t=e.data,n=Date.now(),{config:a}=Ro.getState().global;t.forEach((({destSelector:t,value:i,srcMatch:s$1})=>{if("input"!==t.type)return;const o=document.querySelector(t.selector);if(null===o)return;if("INPUT"!==o.nodeName&&"TEXTAREA"!==o.nodeName){let e;if(a.aTagDomains.some((e=>window.location.href.includes(e)))){const t={ALLOWED_TAGS:a.domPurifySanitizeOptions.allowedLinkOnlySiteTags,ALLOWED_ATTR:a.domPurifySanitizeOptions.allowedAttr};e=s.sanitize(s$1.richTextValue,t)||i;}else e=s$1?.richTextValue||i;o.innerHTML=e;}else {const e=s$1.plainTextValue.replace(/(\S)\n+(\S)/g,"$1 $2")||i;o.value=e;}const r={id:e.fillFlowId,filledValue:i,fillType:"magic",filledAt:n};o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));const l=J(o);ri(r,t,l);}));}}async function X(){const{fabPanelEnabled:e}=Qo();if(e){const e={panel:{activeView:"snippetEdit",isOpen:!0,hasOpenedViaBrowserAction:!0,views:{snippetEdit:{snippet:{...Bn(),id:pe()}}}}};R.notification("updateTabState",e);}else {await Qn("prefillNewShortcut",{});const e=new he("autofill-forms");await e.request("openOrFocusOptionsTab");}}async function Z(e,t,a){const i=a.detail.item.original,s=i.meta,r=a.target,{mappingsEnabled:l}=Qo(),c=Sr(r,{mappingsEnabled:l}),u=i.fillValue||i.value;if("missing"===s.type)return void t.notification("focusOpenTab",s.tabId);if("show-more-variables"===s.type)return await t.request("showAllVariablesInDropdown",c.sinkFullUrl),void e.showMenuForCollection(a.target,{insertTriggerText:!1});const p={id:pe(),filledValue:u,fillType:s.type,filledAt:Date.now()};oi(p,s);const f=J(a.target);if("standard"===s.type)x(r)||await t.request("standardSelected",{srcSelector:s.srcMatch.srcSelector,srcUrl:i.srcUrl,destSelector:c,existingMapping:f}),"snippet"===c.type&&await t.request("snippetVariableSelected",{srcSelector:s.srcMatch.srcSelector,srcFullUrl:i.srcUrl,snippetId:c.snippetId}),He(a,c,p.id);else if("snippet"===s.type){if(Ue(s))return Ie({id:p.id,triggers:[Xo().triggerInput,s.snippet.trigger],unfilledSnippet:s.snippet,srcMatches:s.srcMatches,elementToFill:r}),void t.notification("autofillCancel",Kt(document.location.href));t.notification("selectedSnippet",s.snippet.id,c.sinkFullUrl),We(a,c,p.id,s);}else {if("snippet-unfilled"===s.type)return await t.request("setDropdownView","snippet",c,s),void e.showMenuForCollection(a.target,{insertTriggerText:!1});"create-snippet"===s.type?await X():(t.notification("magicSelected",{fillFlowId:p.id,srcUrl:i.srcUrl,valuesToAutofill:s.valuesToAutofill}),Ve(a,s.type,c,p.id));}if(ri(p,c,f),"Tab"===a.detail.event.key){const e=a.detail.event;setTimeout((()=>r.dispatchEvent(e)),0);}}function J(e){for(const t of z){const{sinkData:n}=t;if("input"===n.type&&e.matches(n.selector))return t}}!async function(){const t$1=new he("autofill-forms");await Bo;const{triggerInput:n}=Xo(),i=n.substring(0,1),o=ht(function(e){const{dropdownVariableLimit:t}=Ro.getState().global.config;return async function(n,a){const i="INPUT"!==n.nodeName,{mappingsEnabled:s}=Qo(),o=Sr(n,{mappingsEnabled:s}),r=J(n),{groups:l,footerText:c}=await e.request("getAutofillValues",{destSelector:o,existingMapping:r,isLongForm:i}),u=Le(l,t);return l.map((e=>e.groupType)).some((e=>"pages-for-dynamic-snippet"!==e))&&Ge(l,o,a,u),{footerText:c,values:u}}}(t$1),n),c=e=>Z(o,t$1,e),u=e=>{!async function(e,t,n){const{mappingsEnabled:a}=Qo(),i=Sr(n.target,{mappingsEnabled:a}),s=J(n.target);await t.request("autofillShowAll",i,s),s&&z.delete(s);ni({type:"autofill.show-all",destSelector:i}),e.isActive=!1,e.showMenuFor(n.target);}(o,t$1,e);},d=e=>function(e,t){const{mappingsEnabled:n}=Qo(),a=Sr(t.target,{mappingsEnabled:n});e.notification("autofillCancel",a.sinkFullUrl),ni({type:"autofill.cancel",destSelector:a});}(t$1,e);function p(e){const t=e.composedPath()?.[0];t instanceof HTMLIFrameElement&&t.contentWindow&&_(f,t.contentWindow);}function f(e){let t$1;const n=e,s=n.target?n.target:null;if(!s)throw new Error(`keyEventListener: target is falsy: ${s}`);if(n.view?t$1=n.view:s.ownerDocument?.defaultView?t$1=s.ownerDocument.defaultView:s.defaultView?t$1=s.defaultView:s.document?.defaultView&&(t$1=s.document.defaultView),!t$1)throw new Error(`Cannot find the global for the ${n.type} event on target: ${e.target}`);const p=n.composedPath().find((e=>t$1&&e instanceof t$1.Element&&(e instanceof t$1.HTMLTextAreaElement||e instanceof t$1.HTMLInputElement||e.hasAttribute&&e.hasAttribute("contenteditable"))));if(!p)return;const f=p;let g="";if(n instanceof t$1.KeyboardEvent)g=n.key;else if(n instanceof t$1.InputEvent){if(!n.data)return;g=n.data;}if(!f||!g)return;if(f instanceof t$1.HTMLInputElement||f instanceof t$1.HTMLTextAreaElement){let e=W.get(f);void 0===e&&(e=f.getAttribute("autocomplete"),W.set(f,e));const n=f.value;Array.from(n.matchAll($)).length>0?(f.setAttribute("autocomplete","chrome-off"),f instanceof t$1.HTMLTextAreaElement&&(f.blur(),f.focus())):null===e?f.removeAttribute("autocomplete"):f.setAttribute("autocomplete",e);}if(f.hasAttribute("data-magical"))return;if(!f.hasAttribute(Ne)&&g!==i)return;f.setAttribute("data-magical","attached"),o.attach(f),f.addEventListener("tribute-replaced",c),f.addEventListener("tribute-footer-clicked",u),f.addEventListener("tribute-cancel",d),f.addEventListener("create-new-shortcut",X);const m=ft(window,"keydown",{capture:!0}).pipe(ht$1((e=>["Enter","Tab"].includes(e.key))),ht$1((e=>e.composedPath()[0].isContentEditable))).subscribe((e=>{o.isActive&&(e.stopPropagation(),e.preventDefault(),o.events.keydown(o.events,e));}));t((()=>{f&&f.hasAttribute("data-magical")&&(o.detach(f),f.removeAttribute("data-magical"),f.removeEventListener("tribute-replaced",c),f.removeEventListener("tribute-footer-clicked",u),f.removeEventListener("tribute-cancel",d),f.removeEventListener("create-new-shortcut",X),m.unsubscribe());})),async function(){const e=await Xn("userInfo");if(e?.featureFlags.magicFillChangeTrackingEnabled){window.addEventListener("change",G);const t$1=Re(window,(t=>({value:t.innerText,destSelector:Sr(t,{mappingsEnabled:e?.featureFlags.mappingsEnabled}),existingMapping:J(t)})),(({value:e,destSelector:t,existingMapping:n})=>ii(t,n,e)));t((()=>{t$1.unsubscribe(),window.removeEventListener("change",G);}));}}();}_(f),window.addEventListener("SnippetBodyEditorLoaded",p),t((()=>window.removeEventListener("SnippetBodyEditorLoaded",p))),window.frameElement&&window.frameElement.addEventListener("load",(e=>{_(f);}),!0),a.browser.runtime.onMessage.addListener(K);const g=Zo((()=>{z.clear();const e=qo((e=>e.destMappings));for(const t of e)z.add(t);}));Rt(o),t((()=>{g.unsubscribe(),window.removeEventListener("keydown",f,!0),window.removeEventListener("keypress",f,!0),window.removeEventListener("beforeinput",f,!0),window.removeEventListener("input",f,!0),window.removeEventListener("keyup",f,!0),a.browser.runtime.onMessage.removeListener(K);}));}();const Q={onTributeReplaced:Z,onMessageListener:K};

export { Q as TESTABLES, X as onClickCreateNew };
