import '../../index-9d8fa28c.js';
import { e as he, ad as m, B as B$1, O as O$1, ab as Y, ae as Vt, af as Rt, aa as ft, j as ht$1, q as Kt, p as pe, Q as Qn, o } from '../../json-rpc-bbea77b7.js';
import '../../users-73981cf4.js';
import '../../keysIn-f91c894f.js';
import { B as Bn } from '../../logging-23079156.js';
import { t, e, s } from '../../google-sheets-f469d8b7.js';
import { addToDeconstructorListener as t$1 } from '../destroy.js';
import { B as Bo, X as Xo, R as Ro, g as ni, Z as Zo, v as qo, x as oi, y as ri, p as Qo, A as ii } from '../../tracking-ba0776b8.js';
import '../../content-ui-6b2a6ee6.js';
import '../../src-match-utils-e7679468.js';
import { h as ht, G as Ge, L as Le, a as Re, R as Rt$1, H as He, U as Ue, I as Ie, W as We, V as Ve } from '../../expander-30141e13.js';

function O(i,s){var n;return void 0===i&&(i=0),void 0===s&&(s=B$1),(m(n=i)||!(n-parseFloat(n)+1>=0)||i<0)&&(i=0),s&&"function"==typeof s.schedule||(s=B$1),new O$1((function(e){return e.add(s.schedule(P,i,{subscriber:e,counter:0,period:i})),e}))}function P(e){var t=e.subscriber,o=e.counter,i=e.period;t.next(o),this.schedule({subscriber:t,counter:o+1,period:i},i);}async function R(){const e=window.crypto.getRandomValues(new Uint32Array(1))[0];return new Promise((t=>{window.addEventListener("message",(function o(i){i.isTrusted&&i.source===window&&"https://docs.google.com"===i.origin&&"document-user"===i.data?.type&&i.data?.nonce===e&&(window.removeEventListener("message",o),t(i.data.email));})),window.location.href=`javascript:window.postMessage({      type: "document-user",      nonce: ${e},      email: window.mergedConfig.appConfig.email,    }, "https://docs.google.com")`;}))}const $=new Set,B=new he("autofill-google-sheets");async function N(e,t){const o=await R();return {authTokenStatus:await e.request("ensureUnexpiredToken",t,o),googleUserEmail:o}}function K(e$1){if(e$1.id!==t)return;const t$1=e$1?.getAttribute(e)?.match(/([A-Z]+)([0-9]+)/);if(!t$1)return;const[,o,i]=t$1;return {type:"cell",col:o,row:parseInt(i,10),sinkFullUrl:Kt(document.location.href),originalUrl:document.location.href}}async function Z(e,t,o,s){const n=pe(),a=s.detail.item.original,r=a.fillValue||a.value,l=a.meta;if("oauthPrompt"===l.type){const{googleUserEmail:e,authTokenStatus:t}=await N(o,!0);return void("valid"===t&&z(o,e))}if("missing"===l.type)return void t.notification("focusOpenTab",l.tabId);const p=s.target,g=K(p);if(void 0===g)return;if("show-more-variables"===l.type)return await t.request("showAllVariablesInDropdown",g.sinkFullUrl),void e.showMenuForCollection(s.target,{insertTriggerText:!1});const m={id:n,filledValue:r,fillType:l.type,filledAt:Date.now()};oi(m,l);const w=await R(),h=Kt(document.location.href),v=H(g);if("standard"===l.type){if(await t.request("standardSelected",{srcSelector:l.srcMatch.srcSelector,srcUrl:a.srcUrl,destSelector:g,existingMapping:v}),o.notification("storeGoogleEmailForURI",w,h),He(s,g,n),ri(m,g,v),"Tab"===s.detail.event.key){const e=s.detail.event;setTimeout((()=>p.dispatchEvent(e)),0);}}else if("snippet"===l.type){if(Ue(l))return Ie({id:m.id,triggers:[Xo().triggerInput,l.snippet.trigger],unfilledSnippet:l.snippet,srcMatches:l.srcMatches,elementToFill:p}),void t.notification("autofillCancel",Kt(document.location.href));t.notification("selectedSnippet",l.snippet.id,g.sinkFullUrl),We(s,g,n,l);}else if("create-snippet"===l.type){const{fabPanelEnabled:e}=Qo();if(e){const e={panel:{activeView:"snippetEdit",isOpen:!0,views:{snippetEdit:{snippet:{...Bn(),id:pe()}}}}};B.notification("updateTabState",e);}else {await Qn("prefillNewShortcut",{});const e=new he("autofill-google-sheets");await e.request("openOrFocusOptionsTab");}}else if("snippet-unfilled"===l.type)await t.request("setDropdownView","snippet",g,l),e.showMenuForCollection(s.target,{insertTriggerText:!1});else if(l.valuesToAutofill.forEach((({destSelector:e,value:t,srcMatch:o})=>{"cell"===e.type&&ri({...m,filledValue:o?.richTextValue||t},e,v);})),o.request("magicGoogleSheetAutofill",{sinkFullUri:h,valuesToAutofill:l.valuesToAutofill,googleEmail:w}).then((e=>{e.success||ni({type:"google.sheets-autofill-error",destSelector:g,response:e});})),Ve(s,l.type,g,n),"magic"===l.type?t.notification("magicSelected",{fillFlowId:n,srcUrl:a.srcUrl}):"magic-fill-all"===l.type&&t.notification("magicFillAllSelected",{srcUrls:l.srcUrls}),ri(m,g,v),"Enter"===s.detail.event.key){const e=new KeyboardEvent("keypress",{key:"Enter",code:"Enter"});setTimeout((()=>p.dispatchEvent(e)),0);}}async function z(e,t){const o=Kt(document.location.href),{spreadsheetId:i}=s(o);e.notification("storeGoogleEmailForSpreadsheetId",t,i);}function H(e){if(e)for(const t of $)if(J(e,t.sinkData))return t}function J(e,t){if("cell"!==t.type)return !1;const o$1=["row","sheetName"];return o.isEqual(o(e).omit(o$1),o(t).omit(o$1))}!async function(){const e=new he("autofill-google-sheets"),t$2=new he("autofill-google-sheets");await Bo;const{triggerInput:o}=Xo(),u=ht(function(e,t){const{dropdownVariableLimit:o}=Ro.getState().global.config;return async function(i,s){const n=K(i);if(void 0===n)throw Error("Could not get current cell");const a=N(t,!1),r=e.request("getAutofillValues",{destSelector:n,existingMapping:H(n),isLongForm:!1}),{authTokenStatus:l,googleUserEmail:c}=await a;if("valid"!==l)return ""===s&&(Ge([],n,s,[]),ni({type:"error.no-auth-google-sheets",destSelector:n,tokenStatus:l})),{values:[{groupTitle:"Magical needs access to Google Drive",groupType:"",srcUrl:"https://google.com",value:`Allow access for ${c}`,fillValue:"",groupIndex:0,suggestionIndex:0,meta:{type:"oauthPrompt"},hidden:!1}],footerText:""};const{groups:u,footerText:d}=await r,p=Le(u,o);return u.map((e=>e.groupType)).some((e=>"pages-for-dynamic-snippet"!==e))&&Ge(u,n,s,p),{values:p,footerText:d}}}(e,t$2),o),d=o=>Z(u,e,t$2,o),p=t=>{!async function(e,t,o){const i=K(o.target);if(void 0!==i){const e=H(i);await t.request("autofillShowAll",i,e),e&&$.delete(e),ni({type:"autofill.show-all",destSelector:i});}e.isActive=!1,e.showMenuFor(o.target);}(u,e,t);},f=t=>function(e,t){const o=K(t.target);e.notification("autofillCancel",Kt(document.location.href)),ni({type:"autofill.cancel",destSelector:o});}(e,t);let b;O(500).pipe(Y((()=>document.getElementById(t))),Vt(),Rt()).subscribe((e=>{u.attach(e),e.addEventListener("tribute-replaced",d),e.addEventListener("tribute-footer-clicked",p),e.addEventListener("tribute-cancel",f),b=Re(e,(e=>({value:e.innerText.trim(),destSelector:K(e)})),(({value:e,destSelector:t})=>ii(t,H(t),e)));}));const y=ft(document,"keydown",{capture:!0}).pipe(ht$1((e=>["ArrowUp","ArrowDown","Tab"].includes(e.key)))).subscribe((e=>{u.isActive&&(e.stopPropagation(),e.preventDefault(),u.events.keydown(u.events,e));})),{googleUserEmail:T,authTokenStatus:E}=await N(t$2,!1);"valid"===E&&z(t$2,T);const S=Zo((()=>{$.clear();const e=qo((e=>e.destMappings));for(const t of e)$.add(t);}));Rt$1(u),t$1((()=>{S.unsubscribe();const e=document.getElementById(t);e&&(u.detach(e),b.unsubscribe(),e.removeEventListener("tribute-replaced",d),e.removeEventListener("tribute-footer-clicked",p),e.removeEventListener("tribute-cancel",f)),y.unsubscribe();}));}();const Q={onTributeReplaced:Z};

export { Q as TESTABLES };
