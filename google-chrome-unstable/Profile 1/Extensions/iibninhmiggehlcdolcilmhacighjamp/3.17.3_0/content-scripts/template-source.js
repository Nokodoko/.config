import '../index-9d8fa28c.js';
import { u, ag as nt, ah as rt, ai as et, e as he, aj as Bt, ak as sn, A as Mt, p as pe, o, al as tt, ab as Y, a2 as an, x, aa as ft, am as F } from '../json-rpc-bbea77b7.js';
import '../users-73981cf4.js';
import '../keysIn-f91c894f.js';
import '../logging-23079156.js';
import { t as t$1 } from '../merge-626c69be.js';
import { addToDeconstructorListener as t } from './destroy.js';
import { Z as Zo, v as qo, B as Bo, R as Ro, g as ni, J as Jo } from '../tracking-ba0776b8.js';
import { m as mf, w as wr, y as yr, e as eC, f as Lf, g as Mr, x as xr, J as Je } from '../content-ui-6b2a6ee6.js';
import { n } from '../src-match-utils-e7679468.js';

function C(r,o){return "function"==typeof o?function(s){return s.pipe(C((function(s,n){return tt(r(s,n)).pipe(Y((function(e,t){return o(s,e,n,t)})))})))}:function(e){return e.lift(new I(r))}}var I=function(){function e(e){this.project=e;}return e.prototype.call=function(e,t){return t.subscribe(new L(e,this.project))},e}(),L=function(e){function t(t,r){var o=e.call(this,t)||this;return o.project=r,o.index=0,o}return u(t,e),t.prototype._next=function(e){var t,r=this.index++;try{t=this.project(e,r);}catch(e){return void this.destination.error(e)}this._innerSub(t);},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var r=new nt(this),n=this.destination;n.add(r),this.innerSubscription=rt(e,r),this.innerSubscription!==r&&n.add(this.innerSubscription);},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe();},t.prototype._unsubscribe=function(){this.innerSubscription=void 0;},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this);},t.prototype.notifyNext=function(e){this.destination.next(e);},t}(et);let V;function P(e,t,r,o$1){const s=wr(t,r,o$1),n=s.map((e=>{const{element:t,...r}=e;return r})),i=V?V.map((e=>{const{element:t,...r}=e;return r})):void 0;o.isEqual(n,i)||(e.notification("publishSrcMatches",n),V=s);}function N(e,t){const r=Array.from(t.childNodes);if(r.some((e=>e.nodeType===Node.TEXT_NODE&&!!e.nodeValue?.trim())))return !0;if(!!an(t))return !0;return r.some((t=>t instanceof Element&&t.matches(e)))}function B(e,t){const{candidateElementChildSelector:r,rootElementSelector:o}=t,s=e.querySelectorAll(o),n=N.bind(null,r),i=[...s].filter(n);return new Set(i)}const O={canElementBeAVariable:N,getAllSelectableDomElements:B};!function(){const e=new he("template-source"),r=Bt(2e3);!async function(e,t$1,r){let o$1,s,n,i=x.EMPTY,c=x.EMPTY;const l=Zo((()=>{const{srcSelectors:l,transforms:u,sourceLabelStore:d}=qo((e=>e.cachedSourcesForUrl));if(void 0!==o$1&&void 0!==s&&void 0!==n&&o.isEqual(o$1,l)&&o.isEqual(n,d)&&o.isEqual(s,u))return;if(o$1=l,s=u,n=d,!o$1.length)return P(e,o$1,s,n),i.closed||i.unsubscribe(),void(c.closed||c.unsubscribe());if(!i.closed||!c.closed)return void P(e,o$1,s,n);const m=()=>{void 0!==o$1&&void 0!==s&&void 0!==n&&P(e,o$1,s,n);};i=t$1.subscribe(m);const f=V.flatMap((e=>e.element??[]))??[];sn(f)?c=r.subscribe(m):c.closed||c.unsubscribe();}));t((()=>{i.unsubscribe(),c.unsubscribe(),l.unsubscribe();}));}(e,mf,r),async function(e,r,o$1){await Bo;const{csgBaseConfig:s,variables:n$1}=Ro.getState().global.config,i=o$1.pipe(Mt({type:"changeEvent"})),c=e.streamingRequest("builderActionStream").pipe(C((e=>"finish"!==e.type?t$1(t$1(ft(document,"click",{capture:!0}),ft(document,"mouseover",{capture:!0})).pipe(Y((e=>({type:e.type,event:e,target:e.target}))),Je(e)),m,i):F(e))));let a,d=null;const m=r.pipe(Mt({type:"domChange"})),j=c.subscribe(x);async function x(t){switch(t.type){case"start":{const e=qo((e=>e.cachedSourcesForUrl.disabledSrcSelectors));d=B(document,n$1),a=wr(e);break}case"finish":d?.clear();break;case"domChange":if(a&&a.length){const e=a.map((e=>e.srcSelector));a=wr(e);}case"changeEvent":d=B(document,n$1);break;case"mouseover":if(document.querySelectorAll(".ha-selection-hover").forEach((e=>e?.classList?.remove("ha-selection-hover"))),!d?.has(t.target))break;t.event.preventDefault(),t.event.stopPropagation(),t.target.classList.add("ha-selection-hover");break;case"click":{if(Lf(t.target))break;if(t.event.preventDefault(),t.event.stopPropagation(),!d?.has(t.target))break;const r=V.find((({element:e})=>e===t.target));if(r){e.notification("removeSource",r.srcSelector.id),ni({type:"template.remove-selector",selector:r.srcSelector,clickedX:!1});break}const o$1=V.reduce(((e,{srcSelector:{baseUrl:t}})=>t.length>e.length?t:e),"")||`${new URL(document.location.href).origin}/`,n=Mr(t.target);let i=a.find((({element:e})=>o.isEqual(e,t.target)));if(!i){const e=pe();i={element:t.target,srcSelector:{id:e,type:"multi",paths:xr(t.target,e,{csgBaseConfig:s}),public:!0,baseUrl:o$1,exampleUrl:document.location.href,createdAt:(new Date).toISOString(),creatorUserId:null,modifier:null},missing:!1,originalValue:n,richTextValue:n,plainTextValue:n,transforms:[],label:null};}Jo({panel:{variableLabelDialogProps:{showModal:!0,srcMatch:i,isEdit:!1}}}),ni({type:"template.add-selector",selector:i.srcSelector});break}case"showModifiedVariablesDialog":{const e=n(t.srcMatch);ni({type:"variable.modifiers-dialog-opened",modifiers:t.modifiers,parentSelector:t.srcMatch.srcSelector,parentLabel:t.srcMatch.label}),e.srcSelector={...e.srcSelector,metadata:{...e.srcSelector.metadata??{},parentSourceId:e.srcSelector.id}};const r=[];for(const o of t.modifiers)r.push({...e,srcSelector:{...e.srcSelector,id:pe(),exampleUrl:document.location.href,modifier:o,createdAt:(new Date).toISOString()}});const o=r.map((e=>e.srcSelector)),s=wr(o).filter(yr).map((e=>{const{element:t,...r}=e;return r}));eC({showModal:!0,srcMatches:s});}}}t((()=>{j.unsubscribe();}));}(e,mf,r);}();

export { O as TESTABLES };
